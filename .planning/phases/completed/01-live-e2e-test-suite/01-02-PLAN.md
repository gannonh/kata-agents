---
phase: 01-live-e2e-test-suite
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - apps/electron/src/renderer/App.tsx
  - packages/ui/src/components/chat/TurnCard.tsx
  - apps/electron/e2e/tests/live/auth.live.e2e.ts
  - apps/electron/e2e/tests/live/chat.live.e2e.ts
autonomous: true
source_issue: ""

must_haves:
  truths:
    - "Auth test verifies app loads without onboarding wizard"
    - "Auth test verifies chat input is available after auth"
    - "Chat test sends a message and receives streaming response"
    - "Chat test verifies turn cards render with responses"
  artifacts:
    - path: "apps/electron/src/renderer/App.tsx"
      provides: "data-testid='app-main-content' on main container"
      contains: "data-testid"
    - path: "packages/ui/src/components/chat/TurnCard.tsx"
      provides: "data-testid='assistant-turn-card' on TurnCard"
      contains: "data-testid"
    - path: "apps/electron/e2e/tests/live/auth.live.e2e.ts"
      provides: "E2E-03 auth verification test"
      contains: "onboarding"
    - path: "apps/electron/e2e/tests/live/chat.live.e2e.ts"
      provides: "E2E-04 chat round-trip test"
      contains: "sendMessage"
  key_links:
    - from: "auth.live.e2e.ts"
      to: "live.fixture.ts"
      via: "import { test, expect }"
      pattern: "from.*live\\.fixture"
    - from: "chat.live.e2e.ts"
      to: "ChatPage.ts"
      via: "ChatPage instance"
      pattern: "new ChatPage"
---

<objective>
Create auth and chat live E2E tests that verify the core user workflow: authenticated app launch and real-time chat with Claude.

Purpose: Fulfills E2E-03 (auth verification) and E2E-04 (chat round-trip) requirements. These are the highest-value live tests as they verify the primary user journey.

Output: Two test files (auth.live.e2e.ts, chat.live.e2e.ts) and necessary data-testid attributes in UI components.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/v0.7.0/01-live-e2e-test-suite/01-RESEARCH.md

@apps/electron/e2e/fixtures/live.fixture.ts
@apps/electron/e2e/page-objects/ChatPage.ts
@apps/electron/src/renderer/App.tsx
@packages/ui/src/components/chat/TurnCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add data-testid attributes to UI components</name>
  <files>apps/electron/src/renderer/App.tsx, packages/ui/src/components/chat/TurnCard.tsx</files>
  <action>
Add data-testid attributes for reliable test selectors:

1. In apps/electron/src/renderer/App.tsx:
   - Find the main content container (likely a `<main>` or primary `<div>` wrapper)
   - Add `data-testid="app-main-content"` to identify the main app container
   - This is used to verify the app loaded successfully past onboarding

2. In packages/ui/src/components/chat/TurnCard.tsx:
   - On the outermost `<div>` of the TurnCard component (around line 1664, the `<div className="space-y-1">`)
   - Add `data-testid="assistant-turn-card"` to identify turn cards in tests
   - Also add `data-streaming={isStreaming}` attribute to indicate streaming state
   - This allows tests to wait for streaming to complete by checking `[data-streaming="false"]`

Note: The existing data-testid attributes in the codebase (git-branch-badge, pr-badge, git-status-badge) are already in place and don't need changes.
  </action>
  <verify>
Run `bun run typecheck:all` from monorepo root to ensure no TypeScript errors.
Run existing E2E tests `cd apps/electron && bun run test:e2e` to ensure nothing broke.
  </verify>
  <done>
data-testid="app-main-content" exists on App.tsx main container.
data-testid="assistant-turn-card" and data-streaming attribute exist on TurnCard.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create auth and chat live E2E tests</name>
  <files>apps/electron/e2e/tests/live/auth.live.e2e.ts, apps/electron/e2e/tests/live/chat.live.e2e.ts</files>
  <action>
Create two test files in apps/electron/e2e/tests/live/:

1. auth.live.e2e.ts:
```typescript
/**
 * E2E-03: Auth verification test
 * Verifies app loads with real credentials, no onboarding wizard appears.
 */
import { test, expect } from '../../fixtures/live.fixture'

test.describe('Live Auth', () => {
  test('E2E-03: app loads with real credentials, no onboarding wizard', async ({ mainWindow }) => {
    // Wait for app to fully initialize (live fixture already waits for splash)
    await mainWindow.waitForLoadState('networkidle')

    // Verify no onboarding wizard appears (checks multiple possible headings)
    const onboardingIndicators = [
      mainWindow.getByRole('heading', { name: /welcome/i }),
      mainWindow.getByRole('heading', { name: /get started/i }),
      mainWindow.getByRole('button', { name: /set up/i }),
    ]

    for (const indicator of onboardingIndicators) {
      await expect(indicator).not.toBeVisible({ timeout: 3000 })
    }

    // Verify main app container is visible (indicates successful auth)
    await expect(mainWindow.locator('[data-testid="app-main-content"]')).toBeVisible()

    // Verify chat input is available (final confirmation of authenticated state)
    await expect(mainWindow.locator('[contenteditable="true"]')).toBeVisible({ timeout: 10000 })
  })
})
```

2. chat.live.e2e.ts:
```typescript
/**
 * E2E-04: Chat round-trip test
 * Sends message, verifies streaming response renders with turn cards.
 */
import { test, expect } from '../../fixtures/live.fixture'
import { ChatPage } from '../../page-objects/ChatPage'

test.describe('Live Chat', () => {
  // Extended timeout for live API calls
  test.setTimeout(120_000)

  test('E2E-04: send message, verify streaming response renders', async ({ mainWindow }) => {
    const chatPage = new ChatPage(mainWindow)

    // Ensure chat is ready (may need to start new conversation)
    await chatPage.waitForReady()

    // Send a simple, deterministic message
    await chatPage.sendMessage('Respond with exactly: "Hello from live test"')

    // Wait for assistant turn card to appear (streaming starts)
    const turnCard = mainWindow.locator('[data-testid="assistant-turn-card"]').last()
    await expect(turnCard).toBeVisible({ timeout: 30_000 })

    // Wait for streaming to complete (data-streaming="false")
    await expect(turnCard).toHaveAttribute('data-streaming', 'false', { timeout: 60_000 })

    // Verify response contains expected text (or at least has content)
    const responseText = await chatPage.getLastAssistantMessage()
    expect(responseText).toBeTruthy()
    expect(responseText!.length).toBeGreaterThan(0)

    // Verify message count increased
    const counts = await chatPage.getMessageCount()
    expect(counts.assistant).toBeGreaterThanOrEqual(1)
  })
})
```

Key patterns used:
- Import from live.fixture.ts (not electron.fixture.ts)
- Extended timeout via test.setTimeout() for real API calls
- data-testid selectors for reliable element targeting
- ChatPage page object for interaction abstraction
- Explicit waits for streaming state changes
  </action>
  <verify>
Run `bun run test:e2e:live` from apps/electron directory.
Both tests should pass (requires valid credentials in ~/.kata-agents/credentials.enc).
Tests should complete within ~60-90 seconds.
  </verify>
  <done>
auth.live.e2e.ts verifies app loads without onboarding.
chat.live.e2e.ts sends message and verifies streaming response.
Both tests pass with real credentials.
  </done>
</task>

</tasks>

<verification>
```bash
# From apps/electron directory
cd apps/electron

# Build the app first (required for E2E tests)
bun run build

# Run live tests
bun run test:e2e:live

# Expected output:
# Running 2 tests using 1 worker
# [1/2] auth.live.e2e.ts:11:3 › Live Auth › E2E-03: app loads with real credentials...
# [2/2] chat.live.e2e.ts:14:3 › Live Chat › E2E-04: send message, verify streaming...
# 2 passed
```
</verification>

<success_criteria>
1. auth.live.e2e.ts test passes, verifying no onboarding wizard appears
2. chat.live.e2e.ts test passes, verifying chat round-trip works
3. data-testid attributes added to App.tsx and TurnCard.tsx
4. Tests use extended timeouts appropriate for live API calls
5. Tests can be run via `bun run test:e2e:live`
</success_criteria>

<output>
After completion, create `.planning/phases/v0.7.0/01-live-e2e-test-suite/01-02-SUMMARY.md`
</output>
