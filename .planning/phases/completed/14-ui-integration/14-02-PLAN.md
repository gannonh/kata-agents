---
phase: 14-ui-integration
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - apps/electron/src/shared/types.ts
  - apps/electron/src/main/ipc.ts
  - apps/electron/src/preload/index.ts
  - apps/electron/src/renderer/atoms/daemon.ts
  - apps/electron/src/renderer/pages/settings/ChannelSettingsPage.tsx
  - apps/electron/src/renderer/pages/settings/SettingsNavigator.tsx
  - apps/electron/src/renderer/components/app-shell/SessionList.tsx
  - apps/electron/src/renderer/components/app-shell/AppShell.tsx
autonomous: true

must_haves:
  truths:
    - "Channel configuration UI lists configured channels with enable/disable toggles"
    - "Channel settings page appears in Settings navigator under 'Channels'"
    - "Channel sessions display a visual badge (adapter icon) in the session list"
    - "Channel sessions are loaded alongside direct sessions in the unified session view"
    - "Daemon state is initialized and kept in sync via IPC subscription in AppShell"
    - "Channel sessions inherit workspace MCP tools via enabledSourceSlugs"
  artifacts:
    - path: "apps/electron/src/renderer/pages/settings/ChannelSettingsPage.tsx"
      provides: "Channel configuration settings page"
      exports: ["default"]
    - path: "apps/electron/src/renderer/components/app-shell/SessionList.tsx"
      provides: "Updated SessionList with channel session badge"
  key_links:
    - from: "apps/electron/src/renderer/pages/settings/ChannelSettingsPage.tsx"
      to: "apps/electron/src/shared/types.ts"
      via: "getChannels/updateChannel IPC calls"
      pattern: "getChannels|updateChannel"
    - from: "apps/electron/src/renderer/components/app-shell/SessionList.tsx"
      to: "apps/electron/src/renderer/atoms/sessions.ts"
      via: "SessionMeta.channel for badge rendering"
      pattern: "meta\\.channel"
    - from: "apps/electron/src/renderer/components/app-shell/AppShell.tsx"
      to: "apps/electron/src/renderer/atoms/daemon.ts"
      via: "daemonStateAtom subscription via IPC"
      pattern: "daemonStateAtom"
---

<objective>
Build the channel configuration UI, add channel session badges in the session list, wire daemon state subscription in AppShell, and enable MCP tool attachment for channel sessions.

Purpose: Completes the UI integration for channel management (CHAN-03), channel session visibility (CHAN-06), MCP tool access (CHAN-07), and daemon state awareness in the renderer.

Output: ChannelSettingsPage, updated SettingsNavigator, channel badge in SessionList, daemon state subscription in AppShell, channel IPC handlers.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/pending/14-ui-integration/14-RESEARCH.md
@.planning/phases/14-ui-integration/14-01-SUMMARY.md
@apps/electron/src/shared/types.ts
@apps/electron/src/preload/index.ts
@apps/electron/src/main/ipc.ts
@apps/electron/src/renderer/atoms/daemon.ts
@apps/electron/src/renderer/atoms/sessions.ts
@apps/electron/src/renderer/components/app-shell/SessionList.tsx
@apps/electron/src/renderer/components/app-shell/AppShell.tsx
@apps/electron/src/renderer/pages/settings/SettingsNavigator.tsx
@apps/electron/src/renderer/pages/settings/WorkspaceSettingsPage.tsx
@packages/shared/src/channels/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add channel config IPC handlers, settings page type, and daemon state subscription</name>
  <files>
    apps/electron/src/shared/types.ts
    apps/electron/src/main/ipc.ts
    apps/electron/src/preload/index.ts
    apps/electron/src/renderer/atoms/daemon.ts
    apps/electron/src/renderer/components/app-shell/AppShell.tsx
  </files>
  <action>
**1. Add channel IPC channels to `IPC_CHANNELS` in types.ts:**

Add after the DAEMON_EVENT entry:

```typescript
// Channel configuration (workspace-scoped)
CHANNELS_GET: 'channels:get',
CHANNELS_UPDATE: 'channels:update',
CHANNELS_DELETE: 'channels:delete',
```

**2. Add settings subpage type:**

In the `SettingsSubpage` type union, add `'channels'`:

```typescript
export type SettingsSubpage = 'app' | 'appearance' | 'workspace' | 'channels' | 'permissions' | 'labels' | 'shortcuts' | 'preferences'
```

**3. Add ElectronAPI methods for channels:**

Add to the `ElectronAPI` interface:

```typescript
// Channel configuration (workspace-scoped)
getChannels(workspaceId: string): Promise<import('@craft-agent/shared/channels').ChannelConfig[]>
updateChannel(workspaceId: string, config: import('@craft-agent/shared/channels').ChannelConfig): Promise<void>
deleteChannel(workspaceId: string, channelSlug: string): Promise<void>
```

**4. Add preload bridge for channels:**

In `apps/electron/src/preload/index.ts`, add after the Skills section:

```typescript
// Channel configuration
getChannels: (workspaceId: string) =>
  ipcRenderer.invoke(IPC_CHANNELS.CHANNELS_GET, workspaceId),
updateChannel: (workspaceId: string, config: any) =>
  ipcRenderer.invoke(IPC_CHANNELS.CHANNELS_UPDATE, workspaceId, config),
deleteChannel: (workspaceId: string, channelSlug: string) =>
  ipcRenderer.invoke(IPC_CHANNELS.CHANNELS_DELETE, workspaceId, channelSlug),
```

**5. Add IPC handlers for channels in `apps/electron/src/main/ipc.ts`:**

Add a new section after the Daemon Management section:

```typescript
// ============================================================
// Channel Configuration
// ============================================================

ipcMain.handle(IPC_CHANNELS.CHANNELS_GET, async (_event, workspaceId: string) => {
  const configDir = process.env.KATA_CONFIG_DIR || process.env.CRAFT_CONFIG_DIR || join(homedir(), '.kata-agents')
  const channelsDir = join(configDir, 'workspaces', workspaceId, 'channels')
  if (!existsSync(channelsDir)) return []
  const slugs = readdirSync(channelsDir, { withFileTypes: true })
    .filter(d => d.isDirectory())
    .map(d => d.name)
  const configs = []
  for (const slug of slugs) {
    const configPath = join(channelsDir, slug, 'config.json')
    if (existsSync(configPath)) {
      try {
        const raw = readFileSync(configPath, 'utf-8')
        configs.push(JSON.parse(raw))
      } catch {
        // Skip malformed configs
      }
    }
  }
  return configs
})

ipcMain.handle(IPC_CHANNELS.CHANNELS_UPDATE, async (_event, workspaceId: string, config: any) => {
  const configDir = process.env.KATA_CONFIG_DIR || process.env.CRAFT_CONFIG_DIR || join(homedir(), '.kata-agents')
  const channelDir = join(configDir, 'workspaces', workspaceId, 'channels', config.slug)
  mkdirSync(channelDir, { recursive: true })
  writeFileSync(join(channelDir, 'config.json'), JSON.stringify(config, null, 2))
})

ipcMain.handle(IPC_CHANNELS.CHANNELS_DELETE, async (_event, workspaceId: string, channelSlug: string) => {
  const configDir = process.env.KATA_CONFIG_DIR || process.env.CRAFT_CONFIG_DIR || join(homedir(), '.kata-agents')
  const channelDir = join(configDir, 'workspaces', workspaceId, 'channels', channelSlug)
  if (existsSync(channelDir)) {
    rmSync(channelDir, { recursive: true })
  }
})
```

Ensure `readdirSync`, `readFileSync`, `writeFileSync`, `mkdirSync`, `rmSync` from `fs` are imported. Check existing imports at the top of `ipc.ts` for available fs functions.

**6. Add channelConfigsAtom to `apps/electron/src/renderer/atoms/daemon.ts`:**

```typescript
import type { ChannelConfig } from '@craft-agent/shared/channels'

/**
 * Channel configurations for the active workspace.
 * Loaded from workspace channels directory.
 */
export const channelConfigsAtom = atom<ChannelConfig[]>([])
```

**7. Wire daemon state subscription in `apps/electron/src/renderer/components/app-shell/AppShell.tsx`:**

Find where sources are subscribed (the `onSourcesChanged` pattern). Add a similar daemon state subscription:

```typescript
import { daemonStateAtom } from '@/atoms/daemon'
```

In the main useEffect that does IPC subscriptions:

```typescript
// Daemon state
window.electronAPI.getDaemonStatus().then((state) => {
  store.set(daemonStateAtom, state)
})
const cleanupDaemonState = window.electronAPI.onDaemonStateChanged((state) => {
  store.set(daemonStateAtom, state as DaemonManagerState)
})
```

Add `cleanupDaemonState()` to the cleanup function returned from useEffect.

Import `DaemonManagerState` from the shared types if needed for the cast, or leave it uncast if TypeScript is happy.

Follow the exact pattern used by the existing `onSourcesChanged` subscription for consistency.
  </action>
  <verify>
`bun run typecheck:all` passes. New IPC handlers compile and the preload bridge methods are typed.
  </verify>
  <done>
Channel IPC handlers read/write/delete channel configs from workspace directories. Preload bridge exposes getChannels, updateChannel, deleteChannel. AppShell subscribes to daemon state changes and populates daemonStateAtom. SettingsSubpage includes 'channels'.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ChannelSettingsPage, update SettingsNavigator, add channel badge to SessionList</name>
  <files>
    apps/electron/src/renderer/pages/settings/ChannelSettingsPage.tsx
    apps/electron/src/renderer/pages/settings/SettingsNavigator.tsx
    apps/electron/src/renderer/components/app-shell/SessionList.tsx
  </files>
  <action>
**1. Create `apps/electron/src/renderer/pages/settings/ChannelSettingsPage.tsx`:**

Follow the WorkspaceSettingsPage pattern for layout and structure. The page should:

- Load channel configs for the current workspace on mount via `window.electronAPI.getChannels(workspaceId)`
- Display a list of configured channels, each showing: adapter type icon (Slack/WhatsApp), slug, enabled toggle
- Each channel row has an enable/disable toggle that calls `window.electronAPI.updateChannel()` with the updated config
- A "No channels configured" empty state with instructions text
- Delete button per channel (with confirmation) calling `window.electronAPI.deleteChannel()`
- The page does NOT have an "Add Channel" button yet (channel creation involves credential setup which would be a separate flow). Show a note: "Use the CLI to configure channels." This keeps the scope minimal.

The DaemonStatusIndicator should appear at the top of the page showing current daemon state, alongside a Start/Stop button.

Import the DaemonStatusIndicator and daemonStateAtom:
```typescript
import { useAtomValue } from 'jotai'
import { daemonStateAtom } from '@/atoms/daemon'
import { DaemonStatusIndicator } from '@/components/ui/daemon-status-indicator'
```

Start/Stop button calls `window.electronAPI.startDaemon()` or `window.electronAPI.stopDaemon()`.

Use existing UI patterns from WorkspaceSettingsPage:
- Section headers with description text
- Switch/Toggle from shadcn/ui for enable/disable
- Button component for actions
- Loading state while fetching

**2. Update SettingsNavigator to add Channels entry:**

In `apps/electron/src/renderer/pages/settings/SettingsNavigator.tsx`:

Add a channel icon (use Lucide `Radio` or `MessageSquare` icon, or create a custom SVG similar to the existing patterns).

Add to the `settingsItems` array, after the 'workspace' entry:

```typescript
{
  id: 'channels' as SettingsSubpage,
  label: 'Channels',
  icon: ChannelsIcon,
  description: 'Daemon, Slack, WhatsApp channels',
},
```

Create a ChannelsIcon SVG component. Use a simple radio/signal icon pattern:

```typescript
const ChannelsIcon = ({ className }: { className?: string }) => (
  <svg
    viewBox="0 0 24 24"
    fill="none"
    xmlns="http://www.w3.org/2000/svg"
    className={className}
  >
    <path
      d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"
      fill="currentColor"
    />
  </svg>
)
```

Actually, for better consistency, use a simple "broadcast" or "antenna" style icon. Or just use Lucide `Radio` directly if Lucide is already imported. Check what icons Lucide offers and pick the best fit. `Radio`, `Antenna`, `Podcast`, or `Rss` are good candidates. Import from lucide-react.

**3. Add channel session badge to SessionList:**

In `apps/electron/src/renderer/components/app-shell/SessionList.tsx`:

Find where session badges are rendered (look for `isFlagged`, `hasUnread`, labels, or similar badge rendering in the session row component).

Add a channel badge before or after the existing badges:

```tsx
{meta.channel && (
  <Tooltip>
    <TooltipTrigger asChild>
      <span className="inline-flex items-center text-xs text-muted-foreground">
        {meta.channel.adapter === 'slack' ? (
          <Hash className="h-3 w-3" />
        ) : meta.channel.adapter === 'whatsapp' ? (
          <MessageCircle className="h-3 w-3" />
        ) : (
          <Radio className="h-3 w-3" />
        )}
      </span>
    </TooltipTrigger>
    <TooltipContent side="top">
      <span>{meta.channel.displayName || `${meta.channel.adapter}/${meta.channel.slug}`}</span>
    </TooltipContent>
  </Tooltip>
)}
```

Import the needed Lucide icons (`Hash`, `MessageCircle`, `Radio`) from lucide-react if not already imported.

The badge should appear in the session row near the session title or alongside other metadata indicators. Follow the existing pattern used by the flag indicator or unread badge.

**4. Wire SettingsNavigator to route to ChannelSettingsPage:**

Check how existing settings pages are routed. The SettingsSubpage type change (adding 'channels') should make the routing work if the settings details panel uses a switch/map on subpage. Find where `WorkspaceSettingsPage`, `AppSettingsPage` etc. are rendered based on `subpage` and add the `ChannelSettingsPage` case:

```typescript
case 'channels':
  return <ChannelSettingsPage />
```

Search for where settings subpages are rendered (likely in a details panel component or NavigatorPanel) and add the routing.

**5. Ensure channel sessions get MCP tools (CHAN-07):**

Channel sessions already go through the same CraftAgent initialization path as interactive sessions. When the daemon creates a session, it can pass `enabledSourceSlugs` from the workspace config. No renderer changes needed for CHAN-07 beyond confirming the daemon session creation path already supports it.

In the ChannelSettingsPage, add a note or informational section stating: "Channel sessions inherit MCP tools from the workspace's enabled sources."
  </action>
  <verify>
`bun run typecheck:all` passes. `bun run lint:electron` passes (or pre-existing warnings only). Navigate to Settings > Channels in the app to verify the page renders. Check that a session with `channel` metadata shows the badge icon in the session list.
  </verify>
  <done>
ChannelSettingsPage displays channel list with enable/disable toggles and daemon status. SettingsNavigator includes Channels entry. SessionList renders adapter-specific badge (Hash/MessageCircle/Radio) for channel sessions. Settings routing resolves 'channels' subpage to ChannelSettingsPage. Channel sessions inherit MCP tools from workspace sources.
  </done>
</task>

</tasks>

<verification>
- `bun run typecheck:all` passes
- `bun run lint:electron` passes (or pre-existing warnings only)
- Settings > Channels page renders with daemon status and channel list
- Channel IPC handlers read/write/delete from `~/.kata-agents/workspaces/{id}/channels/{slug}/config.json`
- Channel sessions display adapter-specific badge in SessionList
- daemonStateAtom is populated on app load and stays in sync
- ChannelSettingsPage shows Start/Stop Daemon button that works
</verification>

<success_criteria>
- Users can see configured channels and toggle them on/off (CHAN-03)
- Channel sessions appear in the session list with a visual badge (CHAN-06)
- Channel sessions get MCP tools through workspace source configuration (CHAN-07)
- Daemon state is visible and controllable from the Channels settings page
- All 5 remaining Phase 14 requirements (DAEMON-03, DAEMON-07, CHAN-03, CHAN-06, CHAN-07) are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/14-ui-integration/14-02-SUMMARY.md`
</output>
