# v0.7.0 Always-On Assistant: Manual Testing Guide

Manual testing procedures for all user-facing features introduced in v0.7.0 (Phases 10-14). Each section covers prerequisites, step-by-step instructions, and expected outcomes.

## Prerequisites

1. Build the app: `bun run electron:build`
2. Launch: `bun run electron:dev` (development) or `bun run electron:start` (production build)
3. Ensure at least one workspace is configured
4. For channel adapter tests: Slack bot token and/or WhatsApp account available

---

## 1. System Tray

### 1.1 Tray Icon Appearance

**Steps:**
1. Launch the app
2. Look at the macOS menu bar (top-right area)

**Expected:**
- A small Kata icon appears in the menu bar
- The icon uses a template image: adapts to light/dark menu bar appearance
- Hovering shows tooltip "Kata Agents"

### 1.2 Tray Context Menu

**Steps:**
1. Click the tray icon in the menu bar

**Expected menu items (top to bottom):**
- **Show Window** (clickable)
- Separator
- **Daemon: Stopped** (greyed out label showing current state)
- **Start Daemon** (clickable)
- Separator
- **Quit** (clickable)

### 1.3 Show Window from Tray

**Steps:**
1. Close all app windows
2. Click tray icon > Show Window

**Expected:** The main window reopens and comes to focus.

### 1.4 Quit from Tray

**Steps:**
1. Click tray icon > Quit

**Expected:** The app fully exits. The tray icon disappears from the menu bar.

---

## 2. Daemon Lifecycle

### 2.1 Start Daemon via Tray

**Steps:**
1. Click tray icon
2. Click "Start Daemon"
3. Click tray icon again to check status

**Expected:**
- The menu item briefly shows "Starting..." (disabled state)
- After a moment, the status label changes to "Daemon: Running"
- The menu now shows "Stop Daemon" instead of "Start Daemon"
- Tray tooltip updates to "Kata Agents — Daemon: Running"

### 2.2 Stop Daemon via Tray

**Steps:**
1. With daemon running, click tray icon
2. Click "Stop Daemon"
3. Click tray icon again

**Expected:**
- Status transitions: "Stopping" then "Stopped"
- Menu reverts to "Start Daemon"

### 2.3 App Stays Alive with Daemon Running

**Steps:**
1. Start the daemon via tray
2. Close all app windows (Cmd+W or red close button)

**Expected:**
- The app does NOT quit
- Tray icon remains in menu bar
- "Show Window" from tray reopens the window

### 2.4 App Quits When Daemon Stopped and All Windows Closed

**Steps:**
1. Stop the daemon via tray (or confirm it's stopped)
2. Close all app windows

**Expected:** The app fully quits. Tray icon disappears.

### 2.5 Daemon Crash Recovery

**Steps:**
1. Start the daemon
2. Force-kill the daemon subprocess:
   ```bash
   # Find daemon PID
   cat ~/.kata-agents/daemon.pid
   kill -9 <pid>
   ```
3. Wait 1-2 seconds and check tray status

**Expected:**
- Daemon auto-restarts (status goes through "Starting" then "Running")
- After 5 consecutive rapid failures, daemon enters "Error" state and stops retrying
- A stable run (60+ seconds) resets the failure counter

### 2.6 Graceful Shutdown on App Quit

**Steps:**
1. Start the daemon
2. Quit the app (Cmd+Q or tray > Quit)
3. Check for leftover processes:
   ```bash
   cat ~/.kata-agents/daemon.pid 2>/dev/null
   ps aux | grep daemon/entry
   ```

**Expected:**
- PID file is removed
- No orphaned daemon process remains
- The daemon's SQLite database is closed cleanly (no WAL corruption)

---

## 3. Channel Settings Page

### 3.1 Navigate to Channels

**Steps:**
1. Open Settings (gear icon or keyboard shortcut)
2. Click "Channels" in the settings navigator sidebar

**Expected:**
- The Channels page loads in the detail panel
- Header shows "Channels"
- Settings navigator shows "Channels" item with a Radio icon and description "Daemon, Slack, WhatsApp channels"

### 3.2 Daemon Status Section

**Steps:**
1. Navigate to Settings > Channels

**Expected:**
- Top section titled "Daemon"
- Shows a "Status" row with:
  - A colored status dot (DaemonStatusIndicator)
  - The current daemon state label
  - A "Start" or "Stop" button

### 3.3 DaemonStatusIndicator States

**Steps:**
1. On the Channels page, observe the status dot while starting/stopping the daemon

**Expected indicator states:**

| State | Dot Color | Animation |
|-------|-----------|-----------|
| Stopped | Gray | None |
| Starting | Yellow | None |
| Running | Green | Pulse animation |
| Stopping | Yellow | None |
| Error | Red | None |
| Paused | Blue | None |

### 3.4 Start/Stop Daemon from Channels Page

**Steps:**
1. Navigate to Settings > Channels
2. Click the "Start" button
3. Observe the status indicator update
4. Click "Stop" once daemon is running

**Expected:**
- Button text toggles between "Start" and "Stop"
- Button is disabled during transitional states (starting/stopping)
- Status indicator updates in real-time without page refresh
- Tray icon status stays in sync

### 3.5 Empty Channel State

**Steps:**
1. Navigate to Settings > Channels with no channels configured

**Expected:**
- Section titled "Configured Channels"
- Subtitle: "Channel sessions inherit MCP tools from workspace sources."
- Empty state message: "No channels configured. Use the CLI to add channels."

### 3.6 Channel List with Configured Channels

**Prerequisites:** Configure at least one channel. Create a channel config file:

```bash
# Slack channel example
mkdir -p ~/.kata-agents/workspaces/<workspace-id>/channels/my-slack
cat > ~/.kata-agents/workspaces/<workspace-id>/channels/my-slack/config.json << 'EOF'
{
  "slug": "my-slack",
  "adapter": "slack",
  "enabled": true,
  "triggers": [],
  "credentials": "slack-source"
}
EOF
```

**Steps:**
1. Navigate to Settings > Channels
2. Observe the channel list

**Expected:**
- Each channel row shows:
  - Adapter-specific icon: Hash (#) for Slack, MessageCircle for WhatsApp, Radio for generic
  - Channel slug name
  - Adapter type label (smaller, muted text)
  - An inline toggle switch showing enabled/disabled state
  - A trash icon button for deletion

### 3.7 Toggle Channel Enabled/Disabled

**Steps:**
1. With a channel configured, navigate to Settings > Channels
2. Toggle the switch on a channel row

**Expected:**
- The toggle visually switches (the knob slides left/right)
- The channel config file on disk updates with the new `enabled` value
- A toast notification does NOT appear on success (silent update)

### 3.8 Delete Channel

**Steps:**
1. With a channel configured, navigate to Settings > Channels
2. Click the trash icon on a channel row

**Expected:**
- The channel disappears from the list
- A toast notification appears: "Channel deleted"
- The channel config directory is removed from disk
- If it was the last channel, the empty state message appears

---

## 4. Daemon Permission Mode

### 4.1 Mode Not in Cycle

**Steps:**
1. In any session, cycle through permission modes using SHIFT+TAB

**Expected:**
- Modes cycle: Explore > Ask to Edit > Auto > Explore > ...
- "Daemon" mode does NOT appear in the cycle
- Daemon mode is only set programmatically on daemon-created sessions

### 4.2 Daemon Mode Allowlist (Programmatic)

**Context:** Daemon-created sessions automatically use daemon permission mode. These sessions can only use a limited set of tools.

**Allowed tools in daemon mode:**
- Read, Glob, Grep (code exploration)
- WebFetch, WebSearch (web access)
- Task, TaskOutput (agent delegation)
- TodoWrite (task tracking)

**Blocked tools:** All other tools including Edit, Write, Bash, NotebookEdit.

---

## 5. Channel Session Badges

### 5.1 Badge Appearance in Session List

**Prerequisites:** A daemon-created session must exist. This requires a running daemon with a connected channel adapter that has received at least one message.

Alternatively, to test visually, create a session JSONL file with a channel field:

```bash
# In the workspace sessions directory
echo '{"id":"test-chan-session","title":"Slack Test","channel":{"adapter":"slack","slug":"my-slack","displayName":"#general"},"createdAt":"2026-02-09T00:00:00Z"}' > ~/.kata-agents/workspaces/<workspace-id>/sessions/test-chan-session.jsonl
```

**Steps:**
1. Open the session list sidebar
2. Look for sessions with channel badges

**Expected:**
- Channel sessions show a small badge icon next to the session title:
  - **Slack:** Hash (#) icon in a rounded background
  - **WhatsApp:** MessageCircle icon
  - **Generic:** Radio icon
- Hovering the badge shows a tooltip with the display name (e.g., "#general") or adapter/slug fallback (e.g., "slack/my-slack")
- Non-channel sessions (direct chat) have no badge

---

## 6. SQLite Message Queue

### 6.1 Database Creation

**Steps:**
1. Start the daemon
2. Check for database file:
   ```bash
   ls -la ~/.kata-agents/daemon.db*
   ```

**Expected:**
- `daemon.db` file exists
- `daemon.db-wal` file may exist (WAL mode)
- `daemon.db-shm` file may exist (shared memory)

### 6.2 Database Survives Restart

**Steps:**
1. Start daemon, let it process some messages
2. Stop daemon
3. Restart daemon
4. Check SQLite tables:
   ```bash
   sqlite3 ~/.kata-agents/daemon.db ".tables"
   ```

**Expected tables:**
- `messages` (message queue)
- `polling_state` (adapter state persistence)
- `scheduled_tasks` (task scheduler)

### 6.3 PID File Management

**Steps:**
1. Start daemon
2. Check PID file:
   ```bash
   cat ~/.kata-agents/daemon.pid
   ps -p $(cat ~/.kata-agents/daemon.pid)
   ```
3. Stop daemon
4. Check PID file again

**Expected:**
- PID file exists while daemon runs, contains the subprocess PID
- PID matches a running Bun process
- PID file is removed after daemon stops

---

## 7. Slack Channel Adapter

### Prerequisites
- A Slack bot token with `channels:history` and `chat:write` scopes
- The bot added to at least one Slack channel
- Channel configuration with the Slack source credentials reference

### 7.1 Slack Polling

**Steps:**
1. Configure a Slack channel adapter (see section 3.6)
2. Add Slack bot credentials as a source in the workspace
3. Start the daemon
4. Send a message in the configured Slack channel
5. Wait for the polling interval (configurable, default varies)

**Expected:**
- The daemon logs show the message received
- A new session appears in the session list with a Slack badge
- The session title or content reflects the Slack message

### 7.2 Bot Self-Filtering

**Steps:**
1. With Slack adapter running, have the bot post a message in the channel
2. Observe daemon logs

**Expected:** The bot's own messages are filtered out and not queued.

### 7.3 Trigger Pattern Matching

**Steps:**
1. Configure a channel with trigger patterns:
   ```json
   {
     "triggers": ["^!help", "urgent"]
   }
   ```
2. Send a message that does NOT match any pattern
3. Send a message starting with "!help"

**Expected:**
- Non-matching messages are ignored
- Matching messages are queued and create sessions
- Empty triggers array matches ALL messages

### 7.4 Polling State Persistence

**Steps:**
1. Start daemon with Slack adapter
2. Let it process some messages
3. Stop and restart daemon
4. Send a new message in Slack

**Expected:**
- After restart, the adapter resumes polling from where it left off
- Old messages are not re-processed
- Check polling state:
  ```bash
  sqlite3 ~/.kata-agents/daemon.db "SELECT * FROM polling_state"
  ```

---

## 8. WhatsApp Channel Adapter

### Prerequisites
- WhatsApp account available for QR pairing
- Channel configuration with auth state directory

### 8.1 QR Code Pairing

**Steps:**
1. Configure a WhatsApp channel adapter
2. Start the daemon
3. Check daemon logs for QR code output

**Expected:**
- A QR code is printed to daemon stderr/logs
- Scanning the QR code with WhatsApp on your phone pairs the device
- After pairing, the adapter status becomes healthy

### 8.2 Receiving WhatsApp Messages

**Steps:**
1. With WhatsApp adapter paired and running
2. Send a text message to the paired WhatsApp number

**Expected:**
- Message is received by the adapter
- A session is created with a WhatsApp badge (MessageCircle icon)
- Only text messages are processed (images, stickers, etc. are silently skipped)

### 8.3 Self-Message Filtering

**Steps:**
1. Send a message FROM the paired WhatsApp account

**Expected:** Your own outgoing messages (`fromMe: true`) are filtered out.

---

## 9. Plugin System

### 9.1 Built-in Plugins Load

**Steps:**
1. Configure enabledPlugins in workspace config:
   ```json
   {
     "defaults": {
       "enabledPlugins": ["kata-slack"]
     }
   }
   ```
2. Start the daemon

**Expected:**
- The daemon initializes the PluginManager with the enabled set
- Only enabled plugins register their channel adapters
- Disabled plugins are tracked but not initialized

### 9.2 Plugin Adapter Factory

**Steps:**
1. Enable `kata-slack` plugin
2. Start daemon with a Slack channel config

**Expected:**
- The ChannelRunner uses the plugin-provided adapter factory
- SlackChannelAdapter instances are created through the plugin system
- Adapter behavior is identical to direct instantiation

---

## 10. Task Scheduler

### 10.1 Scheduled Tasks Table

**Steps:**
1. Start daemon
2. Check scheduled tasks:
   ```bash
   sqlite3 ~/.kata-agents/daemon.db "SELECT * FROM scheduled_tasks"
   ```

**Expected:**
- Table exists with columns: id, name, type, schedule, action, enabled, next_run_at, last_run_at, created_at
- No tasks present by default (tasks are added programmatically)

### 10.2 Task Types

The scheduler supports three task types (tested via unit tests):

| Type | Schedule Format | Behavior |
|------|----------------|----------|
| `cron` | Cron expression (e.g., `"*/5 * * * *"`) | Fires on cron schedule |
| `interval` | Milliseconds (e.g., `60000`) | Fires every N ms |
| `one-shot` | ISO timestamp | Fires once, then auto-disables |

### 10.3 Catch-up on Restart

**Steps:**
1. Schedule a task that should have fired while daemon was stopped
2. Start daemon

**Expected:** Missed tasks fire immediately (via `setTimeout(fn, 0)`) on startup.

---

## 11. Cross-Feature Integration

### 11.1 End-to-End: Slack Message to Session

**Steps:**
1. Configure workspace with Slack source (bot token)
2. Configure Slack channel adapter with trigger patterns
3. Enable `kata-slack` plugin in workspace config
4. Start daemon from tray or Channels page
5. Send a matching message in Slack
6. Open the app window

**Expected:**
- New session appears in session list with Slack badge
- Session has channel metadata (adapter: "slack", slug, displayName)
- Session runs in daemon permission mode (read-only tools)
- Daemon status indicator shows "Running" on Channels page
- Tray tooltip shows "Kata Agents — Daemon: Running"

### 11.2 Daemon State Sync Across UI

**Steps:**
1. Open app window to Channels settings page
2. Start daemon from tray menu (not from the page button)
3. Observe the Channels page

**Expected:**
- Status indicator updates to green/running without page refresh
- Button text changes from "Start" to "Stop"
- Both tray and page show the same state at all times

### 11.3 Shutdown Orchestration

**Steps:**
1. Start daemon with channels configured and tasks scheduled
2. Stop daemon

**Expected shutdown order (check logs):**
1. TaskScheduler stops (cancels timers, awaits in-flight callbacks)
2. PluginManager shuts down (stops services, calls plugin shutdown hooks)
3. ChannelRunner stops all adapters
4. MessageQueue closes SQLite database

---

## 12. Build Verification

### 12.1 Typecheck

```bash
bun run typecheck:all
```

**Expected:** Zero errors across all packages (core, shared, mermaid, ui).

### 12.2 Lint

```bash
bun run lint:electron
```

**Expected:** Zero errors. 47 pre-existing warnings (all from code outside v0.7.0 scope).

### 12.3 Unit Tests

```bash
bun test
```

**Expected:** All tests pass. Key v0.7.0 test counts:
- daemon permission mode: 20 tests
- message queue: 14+ tests
- IPC parser: 8 tests
- trigger matcher: 7 tests
- session resolver: 8 tests
- Slack adapter: 14 tests
- WhatsApp adapter: 15 tests
- channel runner: 7 tests
- plugin manager: 8 tests
- task scheduler: 10 tests
- daemon entry integration: 5 tests

### 12.4 Distribution Build

```bash
cd apps/electron && bun run dist:mac
```

**Expected:** DMG builds successfully. Open the DMG and verify the app launches with tray icon.

---

## Quick Smoke Test Checklist

For a fast verification pass without channel adapters:

- [ ] App launches, tray icon appears
- [ ] Tray menu shows all items (Show Window, daemon status, Start/Stop, Quit)
- [ ] Start daemon from tray, status updates to Running
- [ ] Settings > Channels page loads
- [ ] Channels page shows DaemonStatusIndicator (green dot, pulsing)
- [ ] Channels page Start/Stop button works and syncs with tray
- [ ] Empty channel state shows CLI instructions message
- [ ] Close all windows with daemon running, app stays alive
- [ ] Show Window from tray brings window back
- [ ] Stop daemon from tray
- [ ] Close all windows, app quits
- [ ] `bun run typecheck:all` passes
- [ ] `bun run lint:electron` passes (0 errors)
- [ ] `bun test` passes
