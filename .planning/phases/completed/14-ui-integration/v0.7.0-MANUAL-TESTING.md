# v0.7.0 Always-On Assistant: Manual Testing Guide

## What is the Always-On Assistant?

v0.7.0 adds a background daemon to Kata Agents. The daemon runs as a separate process, monitors external messaging platforms (Slack and WhatsApp), and routes incoming messages to AI agent sessions. The daemon continues running even when you close the app window.

The feature has five layers:

1. **System tray** - A menu bar icon that controls the daemon and keeps the app alive
2. **Daemon process** - A Bun subprocess that manages message queuing and channel adapters
3. **Channel adapters** - Connectors for Slack (polling) and WhatsApp (WebSocket)
4. **Plugin system** - Adapter registration and lifecycle management
5. **UI integration** - Settings page, status indicators, and session badges

---

## Part 1: Core Features (No External Accounts Needed)

These tests verify the daemon, tray, and UI without connecting to Slack or WhatsApp.

### 1.1 Build and Launch

```bash
bun run electron:build
bun run electron:dev
```

The app should open with the main window visible.

### 1.2 System Tray Icon

Look at your macOS menu bar (top-right of the screen). A small Kata icon should appear. This is the system tray icon.

**What to verify:**
- The icon appears in the menu bar
- It adapts to your menu bar appearance (light or dark)
- Hovering the icon shows a tooltip: "Kata Agents"

### 1.3 Tray Context Menu

Click the tray icon. A dropdown menu appears with these items:

| Menu Item | State | Behavior |
|-----------|-------|----------|
| Show Window | Always clickable | Brings the app window to focus |
| _(separator)_ | | |
| Daemon: Stopped | Greyed out label | Shows current daemon state |
| Start Daemon | Clickable | Starts the background daemon |
| _(separator)_ | | |
| Quit | Clickable | Exits the app completely |

### 1.4 Start the Daemon

Click the tray icon, then click **Start Daemon**.

**What happens:**
1. The menu item disables briefly (the daemon is starting)
2. Click the tray icon again to check status
3. The label now reads **Daemon: Running**
4. The menu item changed to **Stop Daemon**
5. The tray tooltip updated to "Kata Agents - Daemon: Running"

**Behind the scenes:** The app spawned a Bun subprocess running `packages/shared/src/daemon/entry.ts`. This process created a SQLite database at `~/.kata-agents/daemon.db` and wrote its PID to `~/.kata-agents/daemon.pid`.

Verify:
```bash
cat ~/.kata-agents/daemon.pid        # Should print a process ID
ps -p $(cat ~/.kata-agents/daemon.pid)  # Should show a running bun process
ls ~/.kata-agents/daemon.db          # Should exist
```

### 1.5 Stop the Daemon

Click the tray icon, then click **Stop Daemon**.

The status label transitions through "Stopping" and settles at "Stopped". The menu reverts to "Start Daemon".

Verify cleanup:
```bash
cat ~/.kata-agents/daemon.pid 2>/dev/null  # File should be gone
```

### 1.6 App Stays Alive When Daemon Is Running

1. Start the daemon via the tray
2. Close all app windows (Cmd+W)
3. The app should NOT quit. The tray icon stays in the menu bar.
4. Click tray > Show Window to bring the window back

### 1.7 App Quits When Daemon Is Stopped

1. Stop the daemon
2. Close all app windows
3. The app quits entirely. The tray icon disappears.

### 1.8 Daemon Crash Recovery

1. Start the daemon
2. Force-kill the daemon process:
   ```bash
   kill -9 $(cat ~/.kata-agents/daemon.pid)
   ```
3. Wait 1-2 seconds
4. Click the tray icon to check status

The daemon should auto-restart. Status goes through "Starting" then "Running" again.

If you kill it 5 times in rapid succession (within 60 seconds each), the daemon gives up and enters "Error" state. A stable run lasting over 60 seconds resets this counter.

### 1.9 Channel Settings Page

1. Open the app window
2. Navigate to **Settings** (gear icon in the sidebar)
3. In the settings sidebar, click **Channels** (has a Radio icon)

The Channel Settings page loads with two sections:

**Daemon section (top):**
- A "Status" row showing a colored dot and the current daemon state
- A Start/Stop button on the right

**Configured Channels section (below):**
- If no channels are configured, shows: "No channels configured. Use the CLI to add channels."
- If channels exist, shows a list with toggle switches and delete buttons

### 1.10 DaemonStatusIndicator

On the Channels settings page, the colored dot next to "Status" is the DaemonStatusIndicator. It changes based on daemon state:

| State | Color | Animation |
|-------|-------|-----------|
| Stopped | Gray | None |
| Starting | Yellow | None |
| Running | Green | Pulse |
| Stopping | Yellow | None |
| Error | Red | None |

### 1.11 Start/Stop Daemon from Settings Page

1. On the Channels page, click the **Start** button
2. Watch the status dot change from gray to yellow to green (pulsing)
3. The button text changes to **Stop**
4. Click **Stop**
5. The dot goes yellow then gray

The tray menu stays in sync. If you start from the tray, the Channels page updates without refreshing.

### 1.12 SQLite Database Inspection

After starting the daemon at least once:

```bash
sqlite3 ~/.kata-agents/daemon.db ".tables"
```

Expected tables:
- `messages` - Message queue for incoming channel messages
- `polling_state` - Remembers where each adapter left off (survives restart)
- `scheduled_tasks` - Cron/interval/one-shot task scheduling

### 1.13 Permission Mode Cycle

In any chat session, press SHIFT+TAB to cycle permission modes.

**Expected cycle:** Explore > Ask to Edit > Auto > Explore > ...

"Daemon" mode should NOT appear. It is set automatically on daemon-created sessions and restricts the agent to read-only tools (Read, Glob, Grep, WebFetch, WebSearch, Task, TaskOutput, TodoWrite).

---

## Part 2: Channel Configuration (Manual Setup)

There is no UI for creating channels yet. Channels are configured by creating JSON files on disk. The Settings > Channels page manages existing channels (enable/disable/delete).

### 2.1 Find Your Workspace Root Path

Channel configs live alongside other workspace data (sources, sessions, skills) in the workspace's root directory. Find it by checking the app config:

```bash
cat ~/.kata-agents/config.json | python3 -c "
import json, sys
c = json.load(sys.stdin)
for w in c.get('workspaces', []):
    print(f\"{w['name']}: {w['rootPath']}\")
"
```

For example:
```
kata-agents: ~/dev/kata/kata-agents
Test A: ~/dev/kata/kata-agents-test-workspace/test-a
```

Use the root path for your target workspace in the paths below, replacing `<WORKSPACE_ROOT>`.

### 2.2 Create a Test Channel (No Credentials Needed)

This creates a channel config that the UI can display, even without actual Slack/WhatsApp credentials:

```bash
WORKSPACE_ROOT="<your-workspace-root-path>"  # e.g., ~/dev/kata/my-project

mkdir -p "$WORKSPACE_ROOT/channels/test-slack"

cat > "$WORKSPACE_ROOT/channels/test-slack/config.json" << 'EOF'
{
  "slug": "test-slack",
  "adapter": "slack",
  "enabled": true,
  "pollIntervalMs": 10000,
  "credentials": {
    "sourceSlug": "my-slack-bot"
  },
  "filter": {
    "triggerPatterns": ["@kata", "help"],
    "channelIds": ["C0123456789"]
  }
}
EOF
```

### 2.3 Verify Channel Appears in UI

1. Navigate to Settings > Channels
2. The "Configured Channels" section now shows your channel:
   - A Hash (#) icon (because adapter is "slack")
   - The slug "test-slack"
   - The adapter type "slack" in smaller text
   - A toggle switch (on, because `enabled: true`)
   - A trash icon for deletion

### 2.4 Toggle a Channel

Click the toggle switch on the test-slack row. It should slide to the off position.

Verify the file updated:
```bash
cat "$WORKSPACE_ROOT/channels/test-slack/config.json"
```

The `enabled` field should now be `false`.

Toggle it back on.

### 2.5 Delete a Channel

Click the trash icon on the test-slack row.

**Expected:**
- The channel disappears from the list
- A toast notification appears: "Channel deleted"
- The empty state message reappears
- The directory is gone:
  ```bash
  ls "$WORKSPACE_ROOT/channels/test-slack/"
  # Should report "No such file or directory"
  ```

### 2.6 Channel Config Format Reference

```json
{
  "slug": "my-channel-name",
  "adapter": "slack",
  "enabled": true,
  "pollIntervalMs": 10000,
  "credentials": {
    "sourceSlug": "name-of-source-with-token"
  },
  "filter": {
    "triggerPatterns": ["@kata", "^help", "urgent"],
    "channelIds": ["C0123456789", "C9876543210"]
  }
}
```

| Field | Required | Description |
|-------|----------|-------------|
| `slug` | Yes | URL-safe name for this channel (matches the directory name) |
| `adapter` | Yes | `"slack"` or `"whatsapp"` |
| `enabled` | Yes | Whether the daemon should activate this channel |
| `pollIntervalMs` | No | Milliseconds between polls (Slack only, default: 10000) |
| `credentials.sourceSlug` | Yes | References a source whose stored token/path the adapter uses |
| `filter.triggerPatterns` | No | Array of regex patterns. Empty array = match all messages. |
| `filter.channelIds` | No | Slack channel IDs to monitor (e.g., `"C0123456789"`) |

**Trigger patterns** are case-insensitive JavaScript regex strings. If multiple patterns are listed, a message matches if ANY pattern matches (OR logic).

Examples:
- `"@kata"` matches any message containing "@kata"
- `"^help"` matches messages starting with "help"
- `"urgent|critical"` matches messages containing "urgent" or "critical"
- `[]` (empty array) matches all messages

---

## Part 3: Slack Integration (Requires Slack Account)

### 3.1 Create a Slack App

1. Go to https://api.slack.com/apps
2. Click **Create New App** > **From scratch**
3. Name it (e.g., "Kata Agent") and select your Slack workspace
4. Go to **OAuth & Permissions** in the sidebar

### 3.2 Add Bot Scopes

Under **Bot Token Scopes**, add:
- `channels:history` - Read messages from public channels
- `chat:write` - Post responses (for future agent replies)

### 3.3 Install the App to Your Workspace

1. Click **Install to Workspace** at the top of the OAuth & Permissions page
2. Authorize the app
3. Copy the **Bot User OAuth Token** (starts with `xoxb-`)

### 3.4 Add the Bot to a Channel

In Slack:
1. Open the channel you want to monitor
2. Type `/invite @YourBotName` or click the channel name > Integrations > Add apps

### 3.5 Find the Slack Channel ID

Right-click the channel name in Slack > "Copy link". The URL looks like:
```
https://your-workspace.slack.com/archives/C0123456789
```

The `C0123456789` part is the channel ID.

### 3.6 Store the Bot Token as a Source

In Kata Agents, add the Slack bot token as a source credential. The channel config references this source by its slug.

The credential is stored encrypted at `~/.kata-agents/credentials.enc`. The channel config points to it via `credentials.sourceSlug`.

### 3.7 Create the Slack Channel Config

```bash
WORKSPACE_ROOT="<your-workspace-root-path>"
CHANNEL_ID="<slack-channel-id>"   # e.g., C0123456789

mkdir -p "$WORKSPACE_ROOT/channels/slack-main"

cat > "$WORKSPACE_ROOT/channels/slack-main/config.json" << EOF
{
  "slug": "slack-main",
  "adapter": "slack",
  "enabled": true,
  "pollIntervalMs": 10000,
  "credentials": {
    "sourceSlug": "<your-slack-source-slug>"
  },
  "filter": {
    "triggerPatterns": [],
    "channelIds": ["$CHANNEL_ID"]
  }
}
EOF
```

Set `triggerPatterns` to `[]` to match all messages, or add patterns like `["@kata"]` to only respond to mentions.

### 3.8 Enable the Slack Plugin

Edit your workspace config to enable the Slack plugin:

```bash
# Check current workspace config
cat "$WORKSPACE_ROOT/config.json"
```

Add or update the `defaults.enabledPlugins` array to include `"kata-slack"`:

```json
{
  "defaults": {
    "enabledPlugins": ["kata-slack"]
  }
}
```

### 3.9 Start the Daemon and Test

1. Start the daemon (tray > Start Daemon, or Settings > Channels > Start)
2. Send a message in your Slack channel that matches the trigger patterns
3. Wait up to 10 seconds (the polling interval)

**Expected:**
- The daemon picks up the message
- A new session appears in the session list with a **#** badge (Slack icon)
- Hovering the badge shows the channel info
- The bot's own messages are filtered out and don't create sessions

### 3.10 Polling State Persistence

1. With the Slack adapter running, let it process a few messages
2. Stop the daemon
3. Restart the daemon
4. Send a new message

The adapter resumes from where it left off. Old messages are not re-processed. Verify:

```bash
sqlite3 ~/.kata-agents/daemon.db "SELECT * FROM polling_state;"
```

This shows the last-known timestamp per Slack channel, stored across restarts.

---

## Part 4: WhatsApp Integration (Requires WhatsApp Account)

### 4.1 How WhatsApp Differs from Slack

- **Slack** uses polling (fetches messages on a timer via HTTP API)
- **WhatsApp** uses a persistent WebSocket connection via the Baileys library
- **WhatsApp** requires QR code pairing with your phone on first setup
- **WhatsApp** stores authentication state as files on disk (Signal protocol keys)

### 4.2 Create the WhatsApp Channel Config

```bash
WORKSPACE_ROOT="<your-workspace-root-path>"
AUTH_DIR="$HOME/.kata-agents/whatsapp-auth"

mkdir -p "$AUTH_DIR"
mkdir -p "$WORKSPACE_ROOT/channels/whatsapp-main"

cat > "$WORKSPACE_ROOT/channels/whatsapp-main/config.json" << EOF
{
  "slug": "whatsapp-main",
  "adapter": "whatsapp",
  "enabled": true,
  "credentials": {
    "sourceSlug": "<your-whatsapp-source-slug>"
  },
  "filter": {
    "triggerPatterns": []
  }
}
EOF
```

The `sourceSlug` for WhatsApp points to a source whose stored credential is the path to the auth state directory (e.g., `~/.kata-agents/whatsapp-auth`).

### 4.3 QR Code Pairing

1. Start the daemon
2. On first connection, the WhatsApp adapter emits a QR code
3. The QR code appears in daemon logs at `~/Library/Logs/@craft-agent/electron/`
4. Open WhatsApp on your phone > Settings > Linked Devices > Link a Device
5. Scan the QR code

After pairing, the adapter saves credentials to the auth state directory. Future startups reconnect automatically without QR scanning.

### 4.4 Receiving Messages

1. With the WhatsApp adapter paired and running
2. Have someone send a text message to your WhatsApp number

**Expected:**
- The message is received by the adapter
- A new session appears with a **MessageCircle** badge (WhatsApp icon)
- Only text messages are processed. Images, stickers, voice notes, and other media types are skipped.
- Your own outgoing messages are filtered out

### 4.5 Enable the WhatsApp Plugin

Same as Slack - add `"kata-whatsapp"` to `defaults.enabledPlugins` in your workspace config:

```json
{
  "defaults": {
    "enabledPlugins": ["kata-slack", "kata-whatsapp"]
  }
}
```

---

## Part 5: Session Badges

When a channel adapter receives a message, it creates a daemon session. These sessions appear in the session list with a badge identifying their source.

| Badge Icon | Adapter | Example |
|------------|---------|---------|
| # (Hash) | Slack | Messages from Slack channels |
| MessageCircle | WhatsApp | Messages from WhatsApp contacts |
| Radio | Other/Generic | Future adapter types |

Hovering a badge shows a tooltip with the display name (e.g., "#general") or a fallback like "slack/my-channel".

Sessions without a badge are regular direct chat sessions.

---

## Part 6: Build Verification

### 6.1 Type Checking

```bash
bun run typecheck:all
```

All four packages (core, shared, mermaid, ui) should pass with zero errors.

### 6.2 Linting

```bash
bun run lint:electron
```

Zero errors. 47 pre-existing warnings (from code outside v0.7.0 scope).

### 6.3 Unit Tests

```bash
bun test
```

All tests pass. v0.7.0 added 100+ new tests covering:
- Daemon permission mode and allowlist
- SQLite message queue operations
- JSON-lines IPC parsing
- Trigger pattern matching
- Session key resolution
- Slack adapter polling and bot filtering
- WhatsApp adapter connection handling
- Channel runner orchestration
- Plugin manager lifecycle
- Task scheduler (cron, interval, one-shot)
- Daemon entry integration

### 6.4 Distribution Build

```bash
cd apps/electron && bun run dist:mac
```

Open the built DMG. Verify the app launches with the tray icon.

---

## Quick Smoke Test (5 Minutes, No External Accounts)

- [ ] `bun run electron:dev` launches the app
- [ ] Tray icon appears in macOS menu bar
- [ ] Tray menu shows: Show Window, Daemon: Stopped, Start Daemon, Quit
- [ ] Click Start Daemon. Status changes to Running.
- [ ] Navigate to Settings > Channels
- [ ] Channels page loads with DaemonStatusIndicator (green pulsing dot)
- [ ] Start/Stop button works and syncs with tray status
- [ ] "Configured Channels" section shows empty state message
- [ ] Close all windows. App stays alive (tray icon remains).
- [ ] Click tray > Show Window. Window reopens.
- [ ] Stop daemon. Close all windows. App quits.
- [ ] `bun run typecheck:all` passes
- [ ] `bun run lint:electron` passes (0 errors)
- [ ] `bun test` passes
