---
phase: 01-setup-and-tooling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/ci.yml
  - .github/workflows/release.yml
autonomous: true

must_haves:
  truths:
    - "PR triggers typecheck and lint validation"
    - "PR triggers test suite execution"
    - "PR produces macOS build artifact"
    - "Push to main produces all platform artifacts"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "PR validation workflow"
      contains: "pull_request"
    - path: ".github/workflows/release.yml"
      provides: "Release build workflow"
      contains: "electron:build"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "package.json scripts"
      via: "bun run commands"
      pattern: "bun run (typecheck|test|electron:build)"
    - from: ".github/workflows/release.yml"
      to: "package.json scripts"
      via: "bun run commands"
      pattern: "bun run electron:build"
---

<objective>
Create CI workflows that validate PRs and produce release artifacts.

Purpose: Enable automated quality gates on every PR (typecheck, lint, test, build) and ensure release workflow produces distributable artifacts for all platforms. Currently, no PR validation exists and release.yml has a broken script reference.

Output: Two GitHub Actions workflows - ci.yml for PR validation with macOS artifact, release.yml fixed to use correct script names.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-setup-and-tooling/01-CONTEXT.md
@.planning/phases/01-setup-and-tooling/01-RESEARCH.md

@package.json (root - contains correct script names)
@.github/workflows/release.yml (existing - needs fix)
@apps/electron/electron-builder.yml (build config)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PR validation workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Create `.github/workflows/ci.yml` with:

**Triggers:**
- `pull_request` to `main` branch

**Jobs:**

1. `validate` (ubuntu-latest):
   - actions/checkout@v4
   - oven-sh/setup-bun@v2
   - `bun install`
   - `bun run typecheck:all`
   - `bun run lint:electron`
   - `bun test`

2. `build-mac` (macos-latest, needs: validate):
   - actions/checkout@v4
   - oven-sh/setup-bun@v2
   - actions/setup-node@v4 with node-version: '20'
   - `bun install`
   - `bun run electron:build`
   - `cd apps/electron && npx electron-builder --mac --arm64 --publish never`
   - Set env: `CSC_IDENTITY_AUTO_DISCOVERY: false`
   - actions/upload-artifact@v4 with:
     - name: macos-arm64
     - path: apps/electron/release/*.dmg
     - retention-days: 7

**Key details:**
- Use `electron:build` not `build:electron` (the correct script name from package.json)
- Only arm64 for PRs (fast feedback), full matrix is for releases
- 7-day artifact retention for PR builds
  </action>
  <verify>
File exists at `.github/workflows/ci.yml` with:
- `on: pull_request` trigger
- `bun run typecheck:all` command
- `bun run lint:electron` command
- `bun test` command
- `bun run electron:build` command (NOT build:electron)
- `electron-builder --mac --arm64` command
- `retention-days: 7` on artifact upload
  </verify>
  <done>ci.yml exists with PR validation and macOS build job</done>
</task>

<task type="auto">
  <name>Task 2: Fix release workflow script reference</name>
  <files>.github/workflows/release.yml</files>
  <action>
In `.github/workflows/release.yml`, fix the incorrect script reference:

**Change required:**
- Line 59, 99, 134: Change `bun run build:electron` to `bun run electron:build`

The script `build:electron` does not exist in package.json. The correct script is `electron:build` (defined at line 24 of root package.json).

**Do NOT change:**
- Trigger (push to main)
- Version check logic
- Platform matrix (arm64, x64 for macOS; x64 for Windows/Linux)
- Artifact upload paths
- Release job

This is a minimal fix - only change the script name, nothing else.
  </action>
  <verify>
`grep -n "build:electron" .github/workflows/release.yml` returns no matches
`grep -n "electron:build" .github/workflows/release.yml` returns 3 matches (lines ~59, ~99, ~134)
  </verify>
  <done>release.yml uses correct `electron:build` script name on all platform jobs</done>
</task>

</tasks>

<verification>
```bash
# Verify ci.yml structure
grep -q "pull_request" .github/workflows/ci.yml && echo "PR trigger: OK"
grep -q "bun run typecheck:all" .github/workflows/ci.yml && echo "Typecheck: OK"
grep -q "bun run lint:electron" .github/workflows/ci.yml && echo "Lint: OK"
grep -q "bun test" .github/workflows/ci.yml && echo "Test: OK"
grep -q "electron:build" .github/workflows/ci.yml && echo "Build script: OK"
grep -q "retention-days: 7" .github/workflows/ci.yml && echo "Retention: OK"

# Verify release.yml fix
grep -c "electron:build" .github/workflows/release.yml | grep -q "3" && echo "Release fix: OK"
! grep -q "build:electron" .github/workflows/release.yml && echo "No old script: OK"
```
</verification>

<success_criteria>
1. `.github/workflows/ci.yml` exists with PR validation (typecheck, lint, test) and macOS build
2. `.github/workflows/release.yml` uses `electron:build` (not `build:electron`)
3. Both workflows reference valid scripts from package.json
4. Artifact retention is 7 days for PR builds
</success_criteria>

<output>
After completion, create `.planning/phases/01-setup-and-tooling/01-01-SUMMARY.md`
</output>
