---
phase: 03-core-git-service
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/shared/src/git/types.ts
  - packages/shared/src/git/git-service.ts
  - packages/shared/src/git/index.ts
  - packages/shared/package.json
autonomous: true

must_haves:
  truths:
    - "GitService can detect current branch name for a directory"
    - "GitService returns null for non-git directories without error"
    - "GitService handles detached HEAD state gracefully"
  artifacts:
    - path: "packages/shared/src/git/types.ts"
      provides: "GitState type definition"
      contains: "interface GitState"
    - path: "packages/shared/src/git/git-service.ts"
      provides: "GitService with getGitStatus function"
      exports: ["getGitStatus", "isGitRepository"]
    - path: "packages/shared/src/git/index.ts"
      provides: "Public exports for git module"
      exports: ["getGitStatus", "isGitRepository", "GitState"]
  key_links:
    - from: "packages/shared/src/git/git-service.ts"
      to: "simple-git"
      via: "import and async calls"
      pattern: "simpleGit\\(.*\\)"
---

<objective>
Create the GitService module in packages/shared that provides async git status detection.

Purpose: Establish the foundation for git integration by creating a service that can detect branch name, repository status, and handle edge cases (non-git directories, detached HEAD) - all with async-only execution to prevent main process blocking.

Output: `packages/shared/src/git/` module with types and service functions.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/research/SUMMARY.md
@.planning/research/ARCHITECTURE.md
@packages/shared/package.json
@packages/shared/src/config/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add simple-git dependency</name>
  <files>packages/shared/package.json</files>
  <action>
Add simple-git ^3.30.0 as a dependency to packages/shared.

Run: `cd packages/shared && bun add simple-git`

simple-git is the recommended library per research (8.5M weekly downloads, TypeScript-native, returns structured StatusResult). It wraps git CLI commands and handles async execution properly.

Do NOT add any other git-related dependencies.
  </action>
  <verify>
Run `cat packages/shared/package.json | grep simple-git` - should show version ^3.30.0 or similar.
Run `cd packages/shared && bun install` to ensure dependency resolves.
  </verify>
  <done>simple-git is listed in packages/shared/package.json dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create git types and service module</name>
  <files>
packages/shared/src/git/types.ts
packages/shared/src/git/git-service.ts
packages/shared/src/git/index.ts
  </files>
  <action>
Create the git module at `packages/shared/src/git/` with three files:

**types.ts:**
```typescript
/**
 * Git state for a workspace directory.
 * All fields are nullable to handle non-git directories gracefully.
 */
export interface GitState {
  /** Current branch name, or null if detached HEAD or not a git repo */
  branch: string | null
  /** True if directory is inside a git repository */
  isRepo: boolean
  /** True if in detached HEAD state (e.g., during rebase or checkout of commit) */
  isDetached: boolean
  /** Short commit hash when in detached HEAD state */
  detachedHead: string | null
}
```

**git-service.ts:**
```typescript
import simpleGit, { type SimpleGit, type StatusResult } from 'simple-git'

import type { GitState } from './types'

/**
 * Check if a directory is inside a git repository.
 * Uses git rev-parse which is fast and doesn't spawn extra processes.
 */
export async function isGitRepository(dirPath: string): Promise<boolean> {
  try {
    const git: SimpleGit = simpleGit(dirPath)
    await git.revparse(['--is-inside-work-tree'])
    return true
  } catch {
    return false
  }
}

/**
 * Get git status for a directory.
 * Returns null values for non-git directories (graceful degradation).
 *
 * IMPORTANT: This function is async-only to prevent main process blocking.
 * Never use execSync or synchronous git operations.
 */
export async function getGitStatus(dirPath: string): Promise<GitState> {
  // Default state for non-git directories
  const defaultState: GitState = {
    branch: null,
    isRepo: false,
    isDetached: false,
    detachedHead: null,
  }

  try {
    const git: SimpleGit = simpleGit(dirPath, {
      maxConcurrentProcesses: 5, // Prevent subprocess spam
      timeout: {
        block: 5000, // 5 second timeout
      },
    })

    // Quick check if this is a git repo
    try {
      await git.revparse(['--is-inside-work-tree'])
    } catch {
      return defaultState // Not a git repo
    }

    // Get branch info
    const status: StatusResult = await git.status()

    // Check for detached HEAD state
    const isDetached = status.detached
    let detachedHead: string | null = null

    if (isDetached) {
      // Get short commit hash for detached HEAD display
      try {
        const result = await git.revparse(['--short', 'HEAD'])
        detachedHead = result.trim()
      } catch {
        // If revparse fails, leave detachedHead as null
      }
    }

    return {
      branch: status.current,
      isRepo: true,
      isDetached,
      detachedHead,
    }
  } catch (error) {
    // Log error but return safe default (don't crash on git errors)
    console.error('[GitService] Error getting git status:', error)
    return defaultState
  }
}
```

**index.ts:**
```typescript
export { getGitStatus, isGitRepository } from './git-service'
export type { GitState } from './types'
```

Key implementation notes:
- All operations are async (never use execSync)
- maxConcurrentProcesses: 5 prevents subprocess spam
- 5 second timeout prevents hangs on slow repos
- Non-git directories return graceful default (isRepo: false)
- Detached HEAD detection with short commit hash for display
  </action>
  <verify>
Run `bun run typecheck:all` - should pass with no type errors.
Run `ls packages/shared/src/git/` - should show types.ts, git-service.ts, index.ts.
  </verify>
  <done>Git module exists with getGitStatus and isGitRepository functions that handle all edge cases</done>
</task>

<task type="auto">
  <name>Task 3: Add subpath export for git module</name>
  <files>packages/shared/package.json</files>
  <action>
Add a subpath export for the git module in packages/shared/package.json.

In the "exports" field, add:
```json
"./git": {
  "types": "./src/git/index.ts",
  "default": "./src/git/index.ts"
}
```

This follows the existing pattern for other modules (config, auth, agent, etc.) and allows clean imports like:
```typescript
import { getGitStatus, type GitState } from '@craft-agent/shared/git'
```
  </action>
  <verify>
Create a test import file or check that TypeScript recognizes the import path.
Run `bun run typecheck:all` to verify exports are correctly configured.
  </verify>
  <done>packages/shared exports ./git subpath for clean module imports</done>
</task>

</tasks>

<verification>
1. `bun run typecheck:all` passes
2. `cat packages/shared/package.json | grep simple-git` shows the dependency
3. `ls packages/shared/src/git/` shows all three files
4. The git module exports are accessible via `@craft-agent/shared/git`
</verification>

<success_criteria>
- simple-git dependency added to packages/shared
- GitState type defined with branch, isRepo, isDetached, detachedHead fields
- getGitStatus function returns GitState asynchronously
- isGitRepository function returns boolean asynchronously
- Both functions handle non-git directories gracefully (no errors thrown)
- All operations use async patterns (no execSync)
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-git-service/03-01-SUMMARY.md`
</output>
