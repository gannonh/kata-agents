---
phase: 03-core-git-service
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - apps/electron/src/shared/types.ts
  - apps/electron/src/main/ipc.ts
  - apps/electron/src/preload/index.ts
autonomous: true

must_haves:
  truths:
    - "Renderer can request git status via IPC"
    - "IPC handler uses async GitService (not execSync)"
    - "Response includes branch, isRepo, isDetached, detachedHead fields"
  artifacts:
    - path: "apps/electron/src/shared/types.ts"
      provides: "GIT_STATUS IPC channel and ElectronAPI type"
      contains: "GIT_STATUS"
    - path: "apps/electron/src/main/ipc.ts"
      provides: "GIT_STATUS IPC handler using GitService"
      contains: "GIT_STATUS"
    - path: "apps/electron/src/preload/index.ts"
      provides: "getGitStatus method exposed to renderer"
      contains: "getGitStatus"
  key_links:
    - from: "apps/electron/src/main/ipc.ts"
      to: "@craft-agent/shared/git"
      via: "import getGitStatus"
      pattern: "from '@craft-agent/shared/git'"
    - from: "apps/electron/src/preload/index.ts"
      to: "IPC_CHANNELS.GIT_STATUS"
      via: "ipcRenderer.invoke"
      pattern: "IPC_CHANNELS\\.GIT_STATUS"
---

<objective>
Wire the GitService to the Electron IPC layer so the renderer can request git status.

Purpose: Connect the GitService module (Plan 01) to the IPC layer, replacing the existing synchronous GET_GIT_BRANCH handler with an async implementation that returns full GitState. This enables the renderer to fetch git status for any workspace directory.

Output: Updated IPC handlers and preload API with getGitStatus method.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-core-git-service/03-01-SUMMARY.md
@apps/electron/src/shared/types.ts
@apps/electron/src/main/ipc.ts (lines 1-50, 740-760)
@apps/electron/src/preload/index.ts (lines 410-420)
@packages/shared/src/git/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GIT_STATUS IPC channel and types</name>
  <files>apps/electron/src/shared/types.ts</files>
  <action>
Update apps/electron/src/shared/types.ts to add the GIT_STATUS IPC channel and update types.

1. In the IPC_CHANNELS object (around line 680-682), add a new channel:
```typescript
// Git operations
GET_GIT_BRANCH: 'git:getBranch',  // Keep existing for backward compatibility
GIT_STATUS: 'git:status',          // NEW: Full git status
```

2. Import GitState type from shared package. Add near the top with other imports:
```typescript
import type { GitState } from '@craft-agent/shared/git'
```

3. Re-export GitState for renderer use:
```typescript
export type { GitState }
```

4. In the ElectronAPI interface, add the new method (keep getGitBranch for backward compatibility):
```typescript
// Git operations
getGitBranch(dirPath: string): Promise<string | null>
getGitStatus(dirPath: string): Promise<GitState>
```

Note: Keep the existing getGitBranch method for backward compatibility with FreeFormInput.tsx which uses it. The new getGitStatus provides the full GitState.
  </action>
  <verify>
Run `bun run typecheck:all` - should pass with no errors.
Run `grep "GIT_STATUS" apps/electron/src/shared/types.ts` - should show the new channel.
  </verify>
  <done>GIT_STATUS IPC channel defined and GitState type exported</done>
</task>

<task type="auto">
  <name>Task 2: Add GIT_STATUS IPC handler in main process</name>
  <files>apps/electron/src/main/ipc.ts</files>
  <action>
Update apps/electron/src/main/ipc.ts to add the GIT_STATUS handler.

1. Add import at the top of the file (with other @craft-agent/shared imports):
```typescript
import { getGitStatus } from '@craft-agent/shared/git'
```

2. Add the new IPC handler near the existing GET_GIT_BRANCH handler (around line 756):
```typescript
// Get full git status for a directory (async, returns GitState)
ipcMain.handle(IPC_CHANNELS.GIT_STATUS, async (_event, dirPath: string) => {
  return getGitStatus(dirPath)
})
```

The existing GET_GIT_BRANCH handler should remain for backward compatibility - it's used by FreeFormInput.tsx for the quick branch check. The new GIT_STATUS handler provides the full GitState with async-only execution.

Key differences from GET_GIT_BRANCH:
- Uses async getGitStatus (not execSync)
- Returns full GitState object (not just branch string)
- Handles detached HEAD with commit hash
- Never blocks the main process
  </action>
  <verify>
Run `bun run typecheck:all` - should pass.
Run `grep "GIT_STATUS" apps/electron/src/main/ipc.ts` - should show the handler.
  </verify>
  <done>GIT_STATUS IPC handler implemented using async GitService</done>
</task>

<task type="auto">
  <name>Task 3: Expose getGitStatus in preload bridge</name>
  <files>apps/electron/src/preload/index.ts</files>
  <action>
Update apps/electron/src/preload/index.ts to expose getGitStatus to the renderer.

Near the existing getGitBranch method (around line 412-413), add:
```typescript
getGitStatus: (dirPath: string) =>
  ipcRenderer.invoke(IPC_CHANNELS.GIT_STATUS, dirPath),
```

The method should be added to the `api` object alongside the existing getGitBranch:
```typescript
// Existing:
getGitBranch: (dirPath: string) =>
  ipcRenderer.invoke(IPC_CHANNELS.GET_GIT_BRANCH, dirPath),

// Add new:
getGitStatus: (dirPath: string) =>
  ipcRenderer.invoke(IPC_CHANNELS.GIT_STATUS, dirPath),
```

This exposes getGitStatus to the renderer via window.electronAPI.getGitStatus(dirPath).
  </action>
  <verify>
Run `bun run typecheck:all` - should pass.
Run `grep "getGitStatus" apps/electron/src/preload/index.ts` - should show the method.
  </verify>
  <done>getGitStatus exposed to renderer via preload bridge</done>
</task>

</tasks>

<verification>
1. `bun run typecheck:all` passes
2. GIT_STATUS channel is defined in IPC_CHANNELS
3. GitState type is exported from shared/types.ts
4. IPC handler in ipc.ts imports and uses getGitStatus from @craft-agent/shared/git
5. Preload exposes getGitStatus method
6. ElectronAPI interface includes getGitStatus signature
</verification>

<success_criteria>
- GIT_STATUS IPC channel added alongside existing GET_GIT_BRANCH
- GitState type imported from @craft-agent/shared/git and re-exported
- IPC handler uses async getGitStatus (not execSync)
- Preload bridge exposes getGitStatus to renderer
- ElectronAPI type includes getGitStatus method
- Existing getGitBranch remains for backward compatibility
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-git-service/03-02-SUMMARY.md`
</output>
