---
phase: 03-core-git-service
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - apps/electron/src/renderer/components/git/GitStatusBadge.tsx
  - apps/electron/src/renderer/components/app-shell/WorkspaceSwitcher.tsx
autonomous: false

must_haves:
  truths:
    - "User can see current git branch name in workspace UI"
    - "User sees no git indicator when workspace is not a git repository"
    - "User sees correct branch for each workspace when switching workspaces"
    - "Branch display handles detached HEAD state gracefully"
  artifacts:
    - path: "apps/electron/src/renderer/components/git/GitStatusBadge.tsx"
      provides: "Git status badge component"
      exports: ["GitStatusBadge"]
    - path: "apps/electron/src/renderer/components/app-shell/WorkspaceSwitcher.tsx"
      provides: "Updated WorkspaceSwitcher with git badge"
      contains: "GitStatusBadge"
  key_links:
    - from: "apps/electron/src/renderer/components/git/GitStatusBadge.tsx"
      to: "apps/electron/src/renderer/hooks/useGitStatus.ts"
      via: "useGitStatus hook"
      pattern: "useGitStatus"
    - from: "apps/electron/src/renderer/components/app-shell/WorkspaceSwitcher.tsx"
      to: "apps/electron/src/renderer/components/git/GitStatusBadge.tsx"
      via: "component import"
      pattern: "GitStatusBadge"
---

<objective>
Create the GitStatusBadge UI component and integrate it into the workspace header.

Purpose: Display the current git branch name in the workspace UI (GIT-01), show nothing for non-git directories (GIT-02), and update when switching workspaces (GIT-03). This is the user-visible deliverable for Phase 3.

Output: GitStatusBadge component integrated into WorkspaceSwitcher area.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-core-git-service/03-02-SUMMARY.md
@.planning/phases/03-core-git-service/03-03-SUMMARY.md
@apps/electron/src/renderer/components/app-shell/WorkspaceSwitcher.tsx
@apps/electron/src/renderer/components/ui/badge.tsx
@apps/electron/src/renderer/hooks/useGitStatus.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitStatusBadge component</name>
  <files>apps/electron/src/renderer/components/git/GitStatusBadge.tsx</files>
  <action>
Create apps/electron/src/renderer/components/git/GitStatusBadge.tsx.

```typescript
/**
 * GitStatusBadge - Display current git branch in workspace UI
 *
 * Requirements:
 * - GIT-01: Show current branch name
 * - GIT-02: Show nothing when not a git repository
 * - GIT-03: Update when switching workspaces (via useGitStatus hook)
 * - Handle detached HEAD state gracefully (show short commit hash)
 */

import * as React from 'react'
import { GitBranch } from 'lucide-react'
import { cn } from '@/lib/utils'
import { useGitStatus } from '@/hooks/useGitStatus'
import { Tooltip, TooltipTrigger, TooltipContent } from '@craft-agent/ui'

interface GitStatusBadgeProps {
  /** Current workspace ID */
  workspaceId: string | null
  /** Absolute path to workspace root directory */
  workspaceRootPath: string | null
  /** Additional CSS classes */
  className?: string
  /** Whether to show in collapsed/icon-only mode */
  isCollapsed?: boolean
}

/**
 * Git status badge showing current branch name.
 * Returns null (renders nothing) when:
 * - workspaceId or workspaceRootPath is null
 * - Directory is not a git repository
 */
export function GitStatusBadge({
  workspaceId,
  workspaceRootPath,
  className,
  isCollapsed = false,
}: GitStatusBadgeProps) {
  const { gitState, isLoading } = useGitStatus(workspaceId, workspaceRootPath)

  // GIT-02: Show nothing for non-git directories
  if (!gitState || !gitState.isRepo) {
    return null
  }

  // Determine display text
  let displayText: string
  let tooltipText: string

  if (gitState.isDetached) {
    // Detached HEAD: show short commit hash
    displayText = gitState.detachedHead ?? 'detached'
    tooltipText = `Detached HEAD at ${gitState.detachedHead ?? 'unknown'}`
  } else {
    // Normal branch: show branch name
    displayText = gitState.branch ?? ''
    tooltipText = `Branch: ${gitState.branch}`
  }

  // Don't render if no text to show
  if (!displayText) {
    return null
  }

  // Collapsed mode: icon only with tooltip
  if (isCollapsed) {
    return (
      <Tooltip>
        <TooltipTrigger asChild>
          <div
            className={cn(
              'flex items-center justify-center h-7 w-7 rounded-md',
              'text-muted-foreground hover:bg-foreground/5 transition-colors',
              className
            )}
          >
            <GitBranch className="h-3.5 w-3.5" />
          </div>
        </TooltipTrigger>
        <TooltipContent side="right">
          <p className="font-mono text-xs">{displayText}</p>
        </TooltipContent>
      </Tooltip>
    )
  }

  // Expanded mode: icon + branch name
  return (
    <Tooltip>
      <TooltipTrigger asChild>
        <div
          className={cn(
            'flex items-center gap-1.5 px-2 py-1 rounded-md',
            'text-xs text-muted-foreground',
            'hover:bg-foreground/5 transition-colors',
            'max-w-[140px] overflow-hidden',
            className
          )}
        >
          <GitBranch className="h-3 w-3 shrink-0" />
          <span className="truncate font-mono">{displayText}</span>
          {isLoading && (
            <span className="h-1.5 w-1.5 rounded-full bg-muted-foreground/50 animate-pulse" />
          )}
        </div>
      </TooltipTrigger>
      <TooltipContent>
        <p>{tooltipText}</p>
      </TooltipContent>
    </Tooltip>
  )
}
```

Key implementation details:
- Returns null for non-git directories (GIT-02)
- Shows branch icon + name
- Handles detached HEAD with short commit hash
- Truncates long branch names with ellipsis
- Loading indicator (small pulsing dot)
- Collapsed mode shows icon-only with tooltip
- Uses existing Tooltip from @craft-agent/ui
- Follows existing styling patterns (muted-foreground, hover states)
  </action>
  <verify>
Run `bun run typecheck:all` - should pass.
Run `ls apps/electron/src/renderer/components/git/` - directory should exist with GitStatusBadge.tsx.
  </verify>
  <done>GitStatusBadge component created with branch display and non-git handling</done>
</task>

<task type="auto">
  <name>Task 2: Integrate GitStatusBadge into WorkspaceSwitcher area</name>
  <files>apps/electron/src/renderer/components/app-shell/WorkspaceSwitcher.tsx</files>
  <action>
Update apps/electron/src/renderer/components/app-shell/WorkspaceSwitcher.tsx to display GitStatusBadge.

1. Add import at the top:
```typescript
import { GitStatusBadge } from '@/components/git/GitStatusBadge'
```

2. Update the component props interface to include workspace root path:
```typescript
interface WorkspaceSwitcherProps {
  isCollapsed: boolean
  workspaces: Workspace[]
  activeWorkspaceId: string | null
  onSelect: (workspaceId: string, openInNewWindow?: boolean) => void
  onWorkspaceCreated?: (workspace: Workspace) => void
}
```

3. Get the workspace root path from the selected workspace:
```typescript
const selectedWorkspace = workspaces.find(w => w.id === activeWorkspaceId)
const workspaceRootPath = selectedWorkspace?.rootPath ?? null
```

4. Add GitStatusBadge after the workspace name in the trigger button (inside the `{!isCollapsed && ...}` block):
```tsx
{!isCollapsed && (
  <>
    <FadingText className="ml-1 font-sans min-w-0 text-sm" fadeWidth={36}>
      {selectedWorkspace?.name || 'Select workspace'}
    </FadingText>
    {/* Git status badge - shows branch name when in a git repo */}
    <GitStatusBadge
      workspaceId={activeWorkspaceId}
      workspaceRootPath={workspaceRootPath}
      className="ml-1"
    />
    <ChevronDown className="h-3 w-3 opacity-50 shrink-0" />
  </>
)}
```

For collapsed mode, add the badge separately (after the avatar):
```tsx
{isCollapsed && (
  <GitStatusBadge
    workspaceId={activeWorkspaceId}
    workspaceRootPath={workspaceRootPath}
    isCollapsed={true}
  />
)}
```

The badge will:
- Show branch name inline with workspace name (expanded mode)
- Show icon-only with tooltip (collapsed mode)
- Render nothing if not a git repo
  </action>
  <verify>
Run `bun run typecheck:all` - should pass.
Run `bun run electron:dev` to visually verify the badge appears in a git-repo workspace.
  </verify>
  <done>GitStatusBadge integrated into workspace header area</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Git status badge showing branch name in workspace UI</what-built>
  <how-to-verify>
1. Run `bun run electron:dev` to start the app in development mode
2. Open a workspace that IS a git repository
   - Expected: See branch name (e.g., "main", "feature/xyz") next to workspace name
   - The badge should have a git branch icon
3. Open a workspace that is NOT a git repository (e.g., ~/Documents)
   - Expected: No git badge visible (GIT-02)
4. Switch between workspaces
   - Expected: Branch name updates correctly for each workspace (GIT-03)
5. If possible, create a detached HEAD state (git checkout <commit-hash>) and verify display
   - Expected: Shows short commit hash instead of branch name
6. Collapse the sidebar
   - Expected: Icon-only mode with tooltip showing branch name
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `bun run typecheck:all` passes
2. GitStatusBadge component renders branch name
3. GitStatusBadge returns null for non-git directories
4. Badge appears in workspace header next to workspace name
5. Branch updates when switching workspaces
6. Detached HEAD shows commit hash
7. Human verification confirms visual appearance is acceptable
</verification>

<success_criteria>
- GIT-01: User can see current git branch name in workspace UI
- GIT-02: User sees no git indicator when workspace is not a git repository
- GIT-03: User can see git status update when switching workspaces
- Detached HEAD state shows short commit hash
- Badge appears inline with workspace name (expanded) or as icon-only (collapsed)
- TypeScript compilation passes
- Human verification confirms acceptable visual appearance
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-git-service/03-04-SUMMARY.md`
</output>
