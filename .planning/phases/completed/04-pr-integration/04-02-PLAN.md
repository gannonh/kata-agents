---
phase: 04-pr-integration
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - apps/electron/src/renderer/components/app-shell/input/FreeFormInput.tsx
autonomous: false

must_haves:
  truths:
    - "User can see PR number and title when current branch has an open PR"
    - "User can see PR status (open/draft/merged/closed) via visual indicator"
    - "User can click PR badge to open PR in browser"
    - "User sees no PR badge when gh CLI is unavailable or no PR exists"
  artifacts:
    - path: "apps/electron/src/renderer/components/app-shell/input/FreeFormInput.tsx"
      provides: "PrBadge component adjacent to GitBranchBadge"
      contains: "PrBadge"
  key_links:
    - from: "PrBadge component"
      to: "window.electronAPI.getPrStatus"
      via: "IPC call in useEffect"
      pattern: "electronAPI\\.getPrStatus"
    - from: "PrBadge component"
      to: "window.electronAPI.openUrl"
      via: "onClick handler"
      pattern: "openUrl.*prInfo\\.url"
---

<objective>
Create the PR badge UI component that displays PR information adjacent to the git branch badge.

Purpose: Complete the PR integration feature by showing users their linked PR with status and clickable link.
Output: PrBadge component in chat input toolbar, showing PR title, status icon, and clickable to open in browser.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pr-integration/04-RESEARCH.md

# Prior plan in this phase
@.planning/phases/04-pr-integration/04-01-SUMMARY.md

# Phase 3 UI pattern
@.planning/phases/03-core-git-service/03-04-SUMMARY.md

# Current implementation to extend
@apps/electron/src/renderer/components/app-shell/input/FreeFormInput.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PrBadge Component</name>
  <files>
    apps/electron/src/renderer/components/app-shell/input/FreeFormInput.tsx
  </files>
  <action>
1. Import PrInfo type from shared/types.ts (add to existing GitState import line)

2. Import additional Lucide icons at the top:
```typescript
import { GitPullRequest, GitPullRequestDraft, GitMerge } from 'lucide-react'
```

3. Create PrBadge component (place after GitBranchBadge function, before the exports):

```typescript
/**
 * PrBadge - Shows PR information as a clickable badge
 * Displays nothing when no PR exists or gh CLI unavailable
 */
function PrBadge({
  workingDirectory,
}: {
  workingDirectory?: string
}) {
  const [prInfo, setPrInfo] = React.useState<PrInfo | null>(null)

  // Fetch PR status when working directory changes
  React.useEffect(() => {
    if (workingDirectory) {
      window.electronAPI?.getPrStatus?.(workingDirectory).then((info: PrInfo | null) => {
        setPrInfo(info)
      }).catch(() => {
        setPrInfo(null)
      })
    } else {
      setPrInfo(null)
    }
  }, [workingDirectory])

  // Don't render if no PR
  if (!prInfo) {
    return null
  }

  // Determine icon based on state
  const StatusIcon = prInfo.isDraft
    ? GitPullRequestDraft
    : prInfo.state === 'MERGED'
    ? GitMerge
    : GitPullRequest

  // Determine color based on state
  const statusColor = prInfo.state === 'MERGED'
    ? 'text-purple-500'
    : prInfo.state === 'CLOSED'
    ? 'text-red-500'
    : prInfo.isDraft
    ? 'text-muted-foreground'
    : 'text-green-500'

  const handleClick = () => {
    window.electronAPI?.openUrl?.(prInfo.url)
  }

  return (
    <Tooltip>
      <TooltipTrigger asChild>
        <button
          type="button"
          data-testid="pr-badge"
          data-pr-number={prInfo.number}
          data-pr-state={prInfo.state}
          data-pr-draft={prInfo.isDraft}
          onClick={handleClick}
          className={cn(
            'flex items-center gap-1 px-2 py-1 rounded-md shrink-0',
            'text-xs',
            'hover:bg-foreground/5 transition-colors cursor-pointer',
          )}
        >
          <StatusIcon className={cn('h-3.5 w-3.5 shrink-0', statusColor)} />
          <span className="font-mono">#{prInfo.number}</span>
        </button>
      </TooltipTrigger>
      <TooltipContent side="top" className="max-w-[300px]">
        <p className="font-medium truncate">{prInfo.title}</p>
        <p className="text-muted-foreground text-xs">
          {prInfo.isDraft ? 'Draft' : prInfo.state.toLowerCase()} pull request
        </p>
      </TooltipContent>
    </Tooltip>
  )
}
```

4. Add PrBadge to the toolbar after GitBranchBadge (around line 1410-1411):
```typescript
{/* 4. Git Branch Badge - separate from working directory */}
{onWorkingDirectoryChange && (
  <GitBranchBadge workingDirectory={workingDirectory} />
)}

{/* 5. PR Badge - adjacent to git branch */}
{onWorkingDirectoryChange && (
  <PrBadge workingDirectory={workingDirectory} />
)}
```

Note: The existing comment numbering may need adjustment (context badge numbers).

Important:
- Use the exact same styling pattern as GitBranchBadge for consistency
- Use existing Tooltip/TooltipTrigger/TooltipContent from the file
- Use existing cn utility from the file
- PR badge should only render when prInfo is not null (graceful degradation)
  </action>
  <verify>
- `bun run typecheck:all` passes
- PrBadge component defined in FreeFormInput.tsx
- PrInfo type imported from shared/types
- GitPullRequest, GitPullRequestDraft, GitMerge icons imported
- PrBadge rendered after GitBranchBadge in toolbar
  </verify>
  <done>
- PrBadge component created with state-based icon coloring
- Tooltip shows PR title and status
- Click opens PR URL in browser
- Gracefully hidden when no PR exists
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify PR Badge UI</name>
  <what-built>
PR badge UI component showing PR information adjacent to the git branch badge:
- Shows PR number with status-colored icon (green for open, purple for merged, red for closed, gray for draft)
- Tooltip displays PR title and status
- Clicking opens PR in browser
- Hidden when no PR exists or gh CLI unavailable
  </what-built>
  <how-to-verify>
1. Start the app: `cd apps/electron && bun run dev`
2. Open a workspace that is a git repository with an open PR on the current branch
3. In the chat input toolbar, you should see:
   - Working directory badge
   - Git branch badge (e.g., "main")
   - PR badge (e.g., "#123" with green PR icon)
4. Hover over the PR badge - tooltip should show PR title and status
5. Click the PR badge - should open the PR in your default browser
6. Switch to a branch with no PR - PR badge should disappear
7. (Optional) Test with gh not authenticated - PR badge should not appear

Expected appearance in toolbar:
```
[Attach] [Sources] [kata-agents] [main] [#123]     Opus  â†‘
                                  ^branch  ^PR
```
  </how-to-verify>
  <resume-signal>Type "approved" if PR badge works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. Type checking passes: `bun run typecheck:all`
2. PrBadge component exists: grep "function PrBadge" FreeFormInput.tsx
3. PR badge rendered in toolbar: grep "PrBadge" FreeFormInput.tsx
4. Visual verification in running app (checkpoint task)
</verification>

<success_criteria>
- PR-01: User can see linked PR title when current branch has an open PR (via tooltip)
- PR-02: User can see PR status via color-coded icon (green/purple/red/gray)
- PR-03: User can click PR badge to open PR in browser
- PR-04: User sees graceful degradation - no PR badge when gh CLI unavailable or no PR
</success_criteria>

<output>
After completion, create `.planning/phases/04-pr-integration/04-02-SUMMARY.md`
</output>
