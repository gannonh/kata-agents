---
phase: 15-channel-credentials-and-session-attribution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/shared/src/credentials/types.ts
  - packages/shared/src/credentials/manager.ts
  - packages/shared/src/channels/types.ts
  - packages/shared/src/daemon/channel-runner.ts
  - apps/electron/src/shared/types.ts
  - apps/electron/src/preload/index.ts
  - apps/electron/src/main/ipc.ts
autonomous: true

must_haves:
  truths:
    - "CredentialManager can store and retrieve channel credentials keyed by workspaceId + channelSlug"
    - "credentialIdToAccount round-trips channel_credential type through accountToCredentialId"
    - "ChannelConfig.credentials supports both sourceSlug (legacy) and channelSlug (dedicated)"
    - "Renderer can set and delete channel credentials via IPC without seeing raw credential values"
    - "Renderer can check whether a channel credential exists (boolean) via IPC"
  artifacts:
    - path: "packages/shared/src/credentials/types.ts"
      provides: "channel_credential type in CredentialType union and VALID_CREDENTIAL_TYPES"
    - path: "packages/shared/src/credentials/manager.ts"
      provides: "getChannelCredential, setChannelCredential, deleteChannelCredential convenience methods"
    - path: "packages/shared/src/channels/types.ts"
      provides: "ChannelConfig.credentials with optional channelSlug field"
  key_links:
    - from: "apps/electron/src/main/ipc.ts"
      to: "packages/shared/src/credentials/manager.ts"
      via: "getCredentialManager() for channel credential set/delete/check handlers"
      pattern: "CHANNEL_CREDENTIAL"
    - from: "apps/electron/src/preload/index.ts"
      to: "apps/electron/src/shared/types.ts"
      via: "IPC_CHANNELS.CHANNEL_CREDENTIAL_SET/DELETE/EXISTS"
    - from: "packages/shared/src/credentials/types.ts"
      to: "packages/shared/src/credentials/manager.ts"
      via: "CredentialId with type channel_credential"
---

<objective>
Add a dedicated `channel_credential` type to the credential system and wire IPC handlers so the renderer can store/delete/check channel credentials without exposing raw values.

Purpose: Closes Gap 1 (Channel Credential Storage). Channels need their own credential path since sources are MCPs/APIs/folders and have no conceptual mapping to channel auth tokens (Slack bot tokens, WhatsApp auth state paths).

Output: Extended CredentialType union, CredentialManager convenience methods, updated ChannelConfig type, IPC handlers and preload bridge for channel credential CRUD.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/pending/15-channel-credentials-and-session-attribution/15-RESEARCH.md
@packages/shared/src/credentials/types.ts
@packages/shared/src/credentials/manager.ts
@packages/shared/src/credentials/backends/types.ts
@packages/shared/src/channels/types.ts
@apps/electron/src/shared/types.ts
@apps/electron/src/preload/index.ts
@apps/electron/src/main/ipc.ts
@packages/shared/src/daemon/channel-runner.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add channel_credential type and CredentialManager convenience methods</name>
  <files>
    packages/shared/src/credentials/types.ts
    packages/shared/src/credentials/manager.ts
    packages/shared/src/channels/types.ts
  </files>
  <action>
**1. Extend CredentialType in `packages/shared/src/credentials/types.ts`:**

Add `'channel_credential'` to the `CredentialType` union after `'source_basic'`:

```typescript
export type CredentialType =
  // Global credentials
  | 'anthropic_api_key'
  | 'claude_oauth'
  // Workspace credentials
  | 'workspace_oauth'
  // Source credentials
  | 'source_oauth'
  | 'source_bearer'
  | 'source_apikey'
  | 'source_basic'
  // Channel credentials (stored per workspace+channel)
  | 'channel_credential';
```

Add to `VALID_CREDENTIAL_TYPES` array:

```typescript
const VALID_CREDENTIAL_TYPES: readonly CredentialType[] = [
  'anthropic_api_key',
  'claude_oauth',
  'workspace_oauth',
  'source_oauth',
  'source_bearer',
  'source_apikey',
  'source_basic',
  'channel_credential',
] as const;
```

**2. Add `channelSlug` to `CredentialId` interface:**

Add after the `sourceId` field:

```typescript
/** Channel slug for channel credentials */
channelSlug?: string;
```

**3. Extend `credentialIdToAccount` for channel credentials:**

Add a new case before the global fallback, after the source-scoped format:

```typescript
// Channel-scoped format:
// channel_credential::{workspaceId}::{channelSlug}
if (id.type === 'channel_credential' && id.workspaceId && id.channelSlug) {
  parts.push(id.workspaceId);
  parts.push(id.channelSlug);
  return parts.join(CREDENTIAL_DELIMITER);
}
```

**4. Extend `accountToCredentialId` for channel credentials:**

Add a new case before the global format check, after the source-scoped format:

```typescript
// Channel-scoped format:
// channel_credential::{workspaceId}::{channelSlug}
if (type === 'channel_credential' && parts.length === 3) {
  return { type, workspaceId: parts[1], channelSlug: parts[2] };
}
```

**5. Update `ChannelConfig.credentials` in `packages/shared/src/channels/types.ts`:**

Make `sourceSlug` optional and add `channelSlug`:

```typescript
/** Credential reference for this channel */
credentials: {
  /** Source slug whose credentials this channel uses (legacy path) */
  sourceSlug?: string;
  /** Channel slug for dedicated channel credentials (preferred path) */
  channelSlug?: string;
};
```

This is backward-compatible: existing configs with `sourceSlug` still work.

**6. Update `ChannelRunner` token resolution in `packages/shared/src/daemon/channel-runner.ts`:**

The ChannelRunner currently reads `config.credentials.sourceSlug` to look up tokens. Update both the `slack` and `whatsapp` cases to also check `config.credentials.channelSlug`:

In the `slack` case, change the token lookup:
```typescript
const credKey = config.credentials.channelSlug ?? config.credentials.sourceSlug;
if (!credKey) {
  this.emit({ type: 'plugin_error', pluginId: config.slug, error: 'No credential key configured' });
  continue;
}
const token = wsConfig.tokens.get(credKey);
```

Apply the same pattern to the `whatsapp` case.

**7. Add convenience methods to `CredentialManager` in `packages/shared/src/credentials/manager.ts`:**

Add after the `deleteWorkspaceCredentials` method:

```typescript
// ============================================================
// Channel Credential Convenience Methods
// ============================================================

/** Get a channel credential value */
async getChannelCredential(workspaceId: string, channelSlug: string): Promise<string | null> {
  const cred = await this.get({ type: 'channel_credential', workspaceId, channelSlug });
  return cred?.value || null;
}

/** Set a channel credential value */
async setChannelCredential(workspaceId: string, channelSlug: string, value: string): Promise<void> {
  await this.set(
    { type: 'channel_credential', workspaceId, channelSlug },
    { value }
  );
}

/** Delete a channel credential */
async deleteChannelCredential(workspaceId: string, channelSlug: string): Promise<boolean> {
  return this.delete({ type: 'channel_credential', workspaceId, channelSlug });
}

/** Check if a channel credential exists */
async hasChannelCredential(workspaceId: string, channelSlug: string): Promise<boolean> {
  const cred = await this.get({ type: 'channel_credential', workspaceId, channelSlug });
  return cred !== null;
}
```
  </action>
  <verify>
`bun run typecheck:all` passes. Verify that `credentialIdToAccount({ type: 'channel_credential', workspaceId: 'ws1', channelSlug: 'my-slack' })` produces `'channel_credential::ws1::my-slack'` by checking the logic. The `ChannelConfig.credentials` shape change does not break `bun run typecheck:all` since `sourceSlug` is now optional.
  </verify>
  <done>
`channel_credential` is in the CredentialType union and VALID_CREDENTIAL_TYPES. credentialIdToAccount and accountToCredentialId handle the `channel_credential::{workspaceId}::{channelSlug}` format. CredentialManager has getChannelCredential, setChannelCredential, deleteChannelCredential, hasChannelCredential. ChannelConfig.credentials accepts both sourceSlug and channelSlug. ChannelRunner resolves tokens from either credential key.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add IPC handlers and preload bridge for channel credentials</name>
  <files>
    apps/electron/src/shared/types.ts
    apps/electron/src/preload/index.ts
    apps/electron/src/main/ipc.ts
  </files>
  <action>
**1. Add IPC channel constants in `apps/electron/src/shared/types.ts`:**

Add after the existing `CHANNELS_DELETE` entry:

```typescript
// Channel credentials (workspace-scoped, renderer never sees raw values)
CHANNEL_CREDENTIAL_SET: 'channel-credential:set',
CHANNEL_CREDENTIAL_DELETE: 'channel-credential:delete',
CHANNEL_CREDENTIAL_EXISTS: 'channel-credential:exists',
```

**2. Extend ElectronAPI interface in `apps/electron/src/shared/types.ts`:**

Find the `channels` section of the ElectronAPI interface (near `getChannels`, `updateChannel`, `deleteChannel`) and add:

```typescript
// Channel credentials
setChannelCredential(workspaceId: string, channelSlug: string, value: string): Promise<void>
deleteChannelCredential(workspaceId: string, channelSlug: string): Promise<boolean>
hasChannelCredential(workspaceId: string, channelSlug: string): Promise<boolean>
```

**3. Add preload bridge in `apps/electron/src/preload/index.ts`:**

Find the channels section (near `getChannels`, `updateChannel`, `deleteChannel`) and add:

```typescript
// Channel credentials
setChannelCredential: (workspaceId: string, channelSlug: string, value: string) =>
  ipcRenderer.invoke(IPC_CHANNELS.CHANNEL_CREDENTIAL_SET, workspaceId, channelSlug, value),
deleteChannelCredential: (workspaceId: string, channelSlug: string) =>
  ipcRenderer.invoke(IPC_CHANNELS.CHANNEL_CREDENTIAL_DELETE, workspaceId, channelSlug),
hasChannelCredential: (workspaceId: string, channelSlug: string) =>
  ipcRenderer.invoke(IPC_CHANNELS.CHANNEL_CREDENTIAL_EXISTS, workspaceId, channelSlug),
```

**4. Add IPC handlers in `apps/electron/src/main/ipc.ts`:**

Add after the `CHANNELS_DELETE` handler block, before the closing `}` of `registerIpcHandlers`:

```typescript
// ============================================================
// Channel Credentials (workspace-scoped)
// ============================================================

ipcMain.handle(IPC_CHANNELS.CHANNEL_CREDENTIAL_SET, async (_event, workspaceId: string, channelSlug: string, value: string) => {
  const credManager = getCredentialManager()
  await credManager.setChannelCredential(workspaceId, channelSlug, value)
})

ipcMain.handle(IPC_CHANNELS.CHANNEL_CREDENTIAL_DELETE, async (_event, workspaceId: string, channelSlug: string) => {
  const credManager = getCredentialManager()
  return credManager.deleteChannelCredential(workspaceId, channelSlug)
})

ipcMain.handle(IPC_CHANNELS.CHANNEL_CREDENTIAL_EXISTS, async (_event, workspaceId: string, channelSlug: string) => {
  const credManager = getCredentialManager()
  return credManager.hasChannelCredential(workspaceId, channelSlug)
})
```

Ensure `getCredentialManager` is imported at the top of `ipc.ts`. Check existing imports for:
```typescript
import { getCredentialManager } from '@craft-agent/shared/credentials'
```

If not present, add it. Check the existing file for any existing credential manager usage to find the right import path.
  </action>
  <verify>
`bun run typecheck:all` passes. The three new IPC channels exist in IPC_CHANNELS. The ElectronAPI interface has the three new methods. The preload bridge exposes them. The IPC handlers call CredentialManager convenience methods.
  </verify>
  <done>
IPC channels CHANNEL_CREDENTIAL_SET, CHANNEL_CREDENTIAL_DELETE, CHANNEL_CREDENTIAL_EXISTS defined. Preload bridge exposes setChannelCredential, deleteChannelCredential, hasChannelCredential. IPC handlers use CredentialManager convenience methods. Renderer never receives raw credential values (only boolean from hasChannelCredential).
  </done>
</task>

</tasks>

<verification>
- `bun run typecheck:all` passes
- `bun run lint:electron` passes (or only pre-existing warnings)
- `channel_credential` is in CredentialType union and VALID_CREDENTIAL_TYPES array
- `credentialIdToAccount`/`accountToCredentialId` round-trip `channel_credential::{wsId}::{slug}` format
- CredentialManager has 4 channel convenience methods (get/set/delete/has)
- ChannelConfig.credentials has both optional sourceSlug and optional channelSlug
- ChannelRunner resolves tokens from channelSlug or sourceSlug (preferring channelSlug)
- 3 IPC handlers registered (set/delete/exists)
- Preload bridge exposes 3 channel credential methods
- ElectronAPI interface declares 3 channel credential methods
</verification>

<success_criteria>
- Channel credentials can be stored and retrieved independently from source credentials
- Existing channel configs with sourceSlug continue to work (backward compatible)
- Renderer can manage channel credentials via IPC without credential value exposure
- CredentialManager round-trips channel credentials through encrypted storage
</success_criteria>

<output>
After completion, create `.planning/phases/15-channel-credentials-and-session-attribution/15-01-SUMMARY.md`
</output>
