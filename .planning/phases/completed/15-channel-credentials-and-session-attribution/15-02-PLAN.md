---
phase: 15-channel-credentials-and-session-attribution
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/shared/src/sessions/jsonl.ts
  - packages/shared/src/sessions/storage.ts
autonomous: true

must_haves:
  truths:
    - "Sessions created with a channel field persist the channel metadata to JSONL"
    - "Loading a session from JSONL restores the channel field on StoredSession"
    - "Session list (headerToMetadata) includes the channel field for badge rendering"
    - "createSession accepts an optional channel parameter and persists it"
    - "Existing sessions without channel field load without errors (backward compatible)"
  artifacts:
    - path: "packages/shared/src/sessions/jsonl.ts"
      provides: "channel field in createSessionHeader and readSessionJsonl"
    - path: "packages/shared/src/sessions/storage.ts"
      provides: "channel parameter in createSession options and headerToMetadata output"
  key_links:
    - from: "packages/shared/src/sessions/jsonl.ts"
      to: "packages/shared/src/sessions/types.ts"
      via: "SessionHeader.channel, StoredSession.channel"
    - from: "packages/shared/src/sessions/storage.ts"
      to: "packages/shared/src/sessions/jsonl.ts"
      via: "createSessionHeader called from saveSession path"
  deferred:
    - what: "Daemon calling createSession with channel metadata"
      to: "Phase 17 (end-to-end message processing)"
      reason: "Phase 15 adds the channel parameter to createSession and fixes JSONL persistence. The daemon message dequeue loop that actually calls createSession with channel metadata is Phase 17 scope (Gap 5)."
---

<objective>
Fix JSONL serialization and session creation to include the `channel` field that already exists on SessionConfig, SessionHeader, and SessionMetadata types.

Purpose: Closes Gap 4 (Session Channel Attribution). The types were added in Phase 14 Plan 01, but the persistence layer (jsonl.ts) and creation path (storage.ts) never included the field. Without this fix, daemon-created sessions lose their channel metadata on save/load, and the UI channel badge has no data to render.

Output: Updated jsonl.ts (serialize/deserialize channel) and storage.ts (createSession accepts channel, headerToMetadata passes channel through).
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/pending/15-channel-credentials-and-session-attribution/15-RESEARCH.md
@packages/shared/src/sessions/types.ts
@packages/shared/src/sessions/jsonl.ts
@packages/shared/src/sessions/storage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add channel field to JSONL serialization and session creation</name>
  <files>
    packages/shared/src/sessions/jsonl.ts
    packages/shared/src/sessions/storage.ts
  </files>
  <action>
**1. Add `channel` to `createSessionHeader()` in `packages/shared/src/sessions/jsonl.ts`:**

In the `createSessionHeader` function, add the `channel` field to the returned object. Add it after the `model` field and before the pre-computed fields comment:

```typescript
model: session.model,
channel: session.channel,
// Pre-computed fields
messageCount: session.messages.length,
```

**2. Add `channel` to `readSessionJsonl()` in `packages/shared/src/sessions/jsonl.ts`:**

In the `readSessionJsonl` function, add the `channel` field to the returned `StoredSession` object. Add it after the `model` field:

```typescript
model: header.model,
channel: header.channel,
messages,
```

**3. Add `channel` to `headerToMetadata()` in `packages/shared/src/sessions/storage.ts`:**

In the `headerToMetadata` function, add the `channel` field to the returned `SessionMetadata` object. Add it after the `hasUnread` field:

```typescript
// Explicit unread flag - single source of truth for NEW badge (state machine approach)
hasUnread: header.hasUnread,
// Channel origin for daemon-created sessions
channel: header.channel,
```

**4. Add `channel` to `createSession()` options in `packages/shared/src/sessions/storage.ts`:**

Extend the options parameter type of `createSession` to include `channel`:

```typescript
export async function createSession(
  workspaceRootPath: string,
  options?: {
    name?: string;
    workingDirectory?: string;
    permissionMode?: SessionConfig['permissionMode'];
    enabledSourceSlugs?: string[];
    model?: string;
    channel?: SessionConfig['channel'];
  }
): Promise<SessionConfig> {
```

Then include it in the `SessionConfig` object creation:

```typescript
const session: SessionConfig = {
  id: sessionId,
  workspaceRootPath,
  name: options?.name,
  createdAt: now,
  lastUsedAt: now,
  workingDirectory: options?.workingDirectory,
  sdkCwd,
  permissionMode: options?.permissionMode,
  enabledSourceSlugs: options?.enabledSourceSlugs,
  model: options?.model,
  channel: options?.channel,
};
```

**5. Verify backward compatibility:**

Existing sessions without a `channel` field in their JSONL header will parse `header.channel` as `undefined`, which is the correct default (the field is optional). No migration needed.
  </action>
  <verify>
`bun run typecheck:all` passes. Verify by tracing the data flow:
1. `createSession({ channel: { adapter: 'slack', slug: 'my-slack', displayName: '#general' } })` sets `session.channel`
2. `saveSession` calls `createSessionHeader` which now includes `channel`
3. `readSessionJsonl` reads `header.channel` and includes it in returned StoredSession
4. `listSessions` calls `headerToMetadata` which now includes `channel`
5. Existing sessions without channel field parse cleanly (undefined is correct default)
  </verify>
  <done>
`channel` field is serialized in JSONL headers via `createSessionHeader`. `readSessionJsonl` restores `channel` on loaded sessions. `headerToMetadata` includes `channel` in session list metadata. `createSession` accepts an optional `channel` parameter. Existing sessions without channel load without errors.
  </done>
</task>

</tasks>

<verification>
- `bun run typecheck:all` passes
- `bun run lint:electron` passes (or only pre-existing warnings)
- `bun test packages/shared` passes (existing session tests still pass)
- `createSessionHeader` includes `channel` field in output
- `readSessionJsonl` includes `channel` field in returned StoredSession
- `headerToMetadata` includes `channel` field in returned SessionMetadata
- `createSession` accepts optional `channel` parameter
- Existing JSONL files without `channel` field load without errors
</verification>

<success_criteria>
- Daemon-created sessions with channel metadata persist the metadata through save/load cycles
- Session list UI receives channel metadata for badge rendering
- Existing sessions (without channel) continue to load correctly
- createSession API supports channel parameter for daemon session creation
</success_criteria>

<output>
After completion, create `.planning/phases/15-channel-credentials-and-session-attribution/15-02-SUMMARY.md`
</output>
