---
phase: 09-sub-agent-execution-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/types/message.ts
  - apps/electron/src/main/sessions.ts
  - apps/electron/src/renderer/event-processor/types.ts
  - apps/electron/src/renderer/event-processor/handlers/tool.ts
  - packages/ui/src/components/chat/TurnCard.tsx
  - packages/ui/src/components/chat/turn-utils.ts
autonomous: true
source_issue: ""
must_haves:
  truths:
    - agentSlug field exists on Message, StoredMessage, ToolStartEvent, and ActivityItem types
    - sessions.ts extracts subagent_type from Task tool input and propagates as agentSlug through the event pipeline
    - ActivityGroupRow prefers agentSlug over toolInput.subagent_type for the badge label
    - storedToMessage and messageToActivity both pass agentSlug through so persisted sessions retain agent type on reload
  artifacts:
    - packages/core/src/types/message.ts with agentSlug on Message and StoredMessage
    - apps/electron/src/main/sessions.ts with agentSlug extraction in tool_start case
    - apps/electron/src/renderer/event-processor/types.ts with agentSlug on ToolStartEvent
    - apps/electron/src/renderer/event-processor/handlers/tool.ts with agentSlug passthrough
    - packages/ui/src/components/chat/TurnCard.tsx with agentSlug on ActivityItem and preferred in badge
    - packages/ui/src/components/chat/turn-utils.ts with agentSlug in storedToMessage and messageToActivity
  key_links:
    - .planning/phases/pending/09-sub-agent-execution-foundation/09-RESEARCH.md
---

<objective>
Thread the `agentSlug` field through the entire event pipeline so the sub-agent type badge displays the actual agent type (e.g., "Explore", "Plan", "general-purpose") instead of falling back to raw `toolInput.subagent_type` lookup.

Purpose: Completes the EXEC-04 requirement (agent type badge) and hardens badge display against the SDK dual-event pattern where the first `tool_start` arrives with empty input.
Output: Six files modified with a new optional `agentSlug` field threaded from extraction in sessions.ts through to ActivityGroupRow badge rendering.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/pending/09-sub-agent-execution-foundation/09-RESEARCH.md

@packages/core/src/types/message.ts
@apps/electron/src/main/sessions.ts
@apps/electron/src/renderer/event-processor/types.ts
@apps/electron/src/renderer/event-processor/handlers/tool.ts
@packages/ui/src/components/chat/TurnCard.tsx
@packages/ui/src/components/chat/turn-utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add agentSlug to core types and event pipeline</name>
  <files>
    packages/core/src/types/message.ts
    apps/electron/src/renderer/event-processor/types.ts
  </files>
  <action>
    1. In `packages/core/src/types/message.ts`, add `agentSlug?: string` to the `Message` interface after the `parentToolUseId` field (line 148). Add a comment: `// Agent type slug for Task sub-agents (e.g., "Explore", "Plan")`. Add the same field to `StoredMessage` after its `parentToolUseId` field (line 226).

    2. In `apps/electron/src/renderer/event-processor/types.ts`, add `agentSlug?: string` to the `ToolStartEvent` interface (after the `toolDisplayMeta` field, line 64). Add comment: `/** Agent type slug for Task sub-agents */`.
  </action>
  <verify>bun run typecheck:all</verify>
  <done>
    - Message interface has `agentSlug?: string` after parentToolUseId
    - StoredMessage interface has `agentSlug?: string` after parentToolUseId
    - ToolStartEvent interface has `agentSlug?: string` after toolDisplayMeta
    - typecheck passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract and propagate agentSlug through sessions.ts and tool handler</name>
  <files>
    apps/electron/src/main/sessions.ts
    apps/electron/src/renderer/event-processor/handlers/tool.ts
  </files>
  <action>
    1. In `apps/electron/src/main/sessions.ts`, inside the `case 'tool_start'` block (line ~3208):
       - After line 3230 (`const parentToolUseId = event.parentToolUseId`), add:
         ```typescript
         // Extract agent type slug from Task tool input for display badge
         const agentSlug = event.toolName === 'Task'
           ? (formattedToolInput?.subagent_type as string) || undefined
           : undefined
         ```
       - In the `toolStartMessage` object (line ~3257), add `agentSlug,` after `parentToolUseId,`
       - In the existing-message update block (line ~3236-3253), add after the toolDisplayMeta update:
         ```typescript
         if (agentSlug && !existingStartMsg.agentSlug) {
           existingStartMsg.agentSlug = agentSlug
         }
         ```
       - In the `this.sendEvent` call (line ~3277), add `agentSlug,` after `parentToolUseId,`

    2. In `apps/electron/src/renderer/event-processor/handlers/tool.ts`:
       - In `handleToolStart`, in the existing-message update path (line 34, the `updateMessageAt` call), add `agentSlug: event.agentSlug,` to the update object.
       - In the new-message creation path (line 46, `toolMessage` object), add `agentSlug: event.agentSlug,` after `toolDisplayMeta: event.toolDisplayMeta,`.
  </action>
  <verify>bun run typecheck:all</verify>
  <done>
    - sessions.ts extracts agentSlug from Task tool input.subagent_type
    - sessions.ts stores agentSlug on both new and existing tool messages
    - sessions.ts sends agentSlug in the renderer event
    - handleToolStart passes agentSlug to both update and create paths
    - typecheck passes
  </done>
</task>

<task type="auto">
  <name>Task 3: Thread agentSlug through UI layer and prefer it in badge</name>
  <files>
    packages/ui/src/components/chat/TurnCard.tsx
    packages/ui/src/components/chat/turn-utils.ts
  </files>
  <action>
    1. In `packages/ui/src/components/chat/TurnCard.tsx`:
       - Add `agentSlug?: string` to the `ActivityItem` interface (after `parentId`, line ~173). Add comment: `// Agent type slug for Task sub-agents`.
       - In `ActivityGroupRow` (line ~929), change the subagentType derivation from:
         ```typescript
         const subagentType = group.parent.toolInput?.subagent_type as string | undefined
         ```
         to:
         ```typescript
         const subagentType = group.parent.agentSlug
           || (group.parent.toolInput?.subagent_type as string | undefined)
         ```

    2. In `packages/ui/src/components/chat/turn-utils.ts`:
       - In `storedToMessage()` (line ~15), add `agentSlug: stored.agentSlug,` after the `parentToolUseId` line (line 30).
       - In `messageToActivity()` (line ~224), add `agentSlug: message.agentSlug,` to the activity object, after the `parentId` line (line 241).
  </action>
  <verify>bun run typecheck:all && bun test packages/ui/src/components/chat</verify>
  <done>
    - ActivityItem has agentSlug field
    - ActivityGroupRow prefers agentSlug over toolInput.subagent_type for badge text
    - storedToMessage passes agentSlug from stored format to runtime Message
    - messageToActivity passes agentSlug from Message to ActivityItem
    - typecheck passes
    - existing turn-utils tests pass
  </done>
</task>

</tasks>

<verification>
1. `bun run typecheck:all` passes with no errors
2. `bun test` passes all existing tests (no regressions)
3. `bun run lint:electron` passes
4. Grep for `agentSlug` shows it in all 6 modified files
5. The `AgentEvent` union type in `packages/core/src/types/message.ts` does NOT need changes (agentSlug is on Message, not AgentEvent -- the AgentEvent tool_start type could optionally include it but sessions.ts extracts it from event.input, not from a dedicated field)
</verification>

<success_criteria>
- All 4 phase success criteria are met:
  1. Sub-agent events already appear in session (verified by research, no code change needed)
  2. Collapsible group already renders (ActivityGroupRow, no code change needed)
  3. Agent type badge now displays agentSlug instead of falling back to raw toolInput lookup
  4. Depth indentation already works (calculateActivityDepths, no code change needed)
- Zero regressions in existing test suite
- Type safety maintained across the full pipeline
</success_criteria>

<output>
After completion, create `.planning/phases/09-sub-agent-execution-foundation/09-01-SUMMARY.md`
</output>
