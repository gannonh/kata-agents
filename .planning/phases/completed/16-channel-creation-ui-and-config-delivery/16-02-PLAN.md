---
phase: 16-channel-creation-ui-and-config-delivery
plan: 02
type: execute
wave: 1
depends_on: [16-01]
files_modified:
  - apps/electron/src/renderer/pages/settings/ChannelSettingsPage.tsx
autonomous: true
must_haves:
  truths:
    - A user can create a new Slack or WhatsApp channel from the settings UI without editing JSON files
    - The creation form validates slug uniqueness against existing channels before saving
    - After channel creation, the channel list updates immediately without page refresh
    - Channel credentials are stored encrypted via the existing credential system at creation time
  artifacts:
    - apps/electron/src/renderer/pages/settings/ChannelSettingsPage.tsx (modified with creation form)
  key_links:
    - Form save calls updateChannel IPC (CHANNELS_UPDATE) which creates config on disk
    - Form save calls setChannelCredential IPC to store encrypted credential
    - Save sequence is config first, then credential (so daemon reconfigure from Plan 01 finds the credential)
    - Slug auto-generated from adapter type + user-provided name via existing slugify utility
---

<objective>
Add a channel creation form to the ChannelSettingsPage so users can create Slack and WhatsApp channels from the UI.

Purpose: Gap 2 from Phase 14 analysis. Users cannot create channels without manually writing JSON config files. This plan adds an inline creation form with adapter-conditional fields, slug generation, credential storage, and optimistic UI update.

Output: Modified `ChannelSettingsPage.tsx` with an "Add Channel" button that reveals an inline creation form.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/pending/16-channel-creation-ui-and-config-delivery/16-RESEARCH.md

@apps/electron/src/renderer/pages/settings/ChannelSettingsPage.tsx
@apps/electron/src/renderer/components/settings/index.ts (available components)
@apps/electron/src/renderer/components/settings/SettingsInput.tsx
@apps/electron/src/renderer/components/settings/SettingsRadioGroup.tsx
@apps/electron/src/renderer/lib/slugify.ts
@packages/shared/src/channels/types.ts (ChannelConfig, ChannelFilter)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add channel creation form with adapter-conditional fields</name>
  <files>apps/electron/src/renderer/pages/settings/ChannelSettingsPage.tsx</files>
  <action>
Add an inline channel creation form to `ChannelSettingsPage.tsx`. The form appears when the user clicks an "Add Channel" button and collapses on save or cancel.

**Form state interface** (define inside the component file):

```typescript
interface ChannelFormState {
  adapter: 'slack' | 'whatsapp' | '';
  name: string;
  credential: string;
  channelIds: string;
  triggerPatterns: string;
  pollIntervalMs: number;
}
```

Initial state: `{ adapter: '', name: '', credential: '', channelIds: '', triggerPatterns: '', pollIntervalMs: 10000 }`.

**Component state additions:**
- `const [showForm, setShowForm] = useState(false)` -- controls form visibility
- `const [form, setForm] = useState<ChannelFormState>(initialFormState)` -- form data
- `const [formError, setFormError] = useState<string | null>(null)` -- validation error
- `const [isSaving, setIsSaving] = useState(false)` -- save-in-progress flag

**Add Channel button:**
Add a button in the PanelHeader `actions` area (next to HeaderMenu) or below the "Configured Channels" section title. Use a `Plus` icon from lucide-react. Clicking it sets `showForm(true)` and resets form state.

**Form layout** (render above the channel list when `showForm` is true):
Use `SettingsSection` with title "New Channel" and a `SettingsCard` containing:

1. **Adapter type selection** -- Use `SettingsRadioGroup` with two `SettingsRadioCard` options:
   - `{ value: 'slack', label: 'Slack', description: 'Poll Slack channels for messages' }` with `Hash` icon
   - `{ value: 'whatsapp', label: 'WhatsApp', description: 'Subscribe to WhatsApp via Baileys' }` with `MessageCircle` icon

2. **Name input** -- `SettingsInput` with label "Name", placeholder "my-team-alerts". Show the generated slug below as helper text: `Slug: {slugify(adapter + '-' + name)}`. Only show name input after adapter is selected.

3. **Adapter-conditional fields** (only show after adapter selected):

   For Slack:
   - `SettingsSecretInput` with label "Bot Token", placeholder "xoxb-..."
   - `SettingsInput` with label "Channel IDs", description "Comma-separated Slack channel IDs to monitor", placeholder "C01234567, C07654321"
   - `SettingsInput` with label "Poll Interval (ms)", placeholder "10000", value as string

   For WhatsApp:
   - `SettingsInput` with label "Auth State Path", description "Directory for WhatsApp auth state persistence", placeholder "~/.kata-agents/whatsapp-auth"

4. **Trigger patterns** (show for both adapters, optional):
   - `SettingsInput` with label "Trigger Patterns", description "Optional comma-separated regex patterns to filter messages", placeholder "help.*,urgent.*"

5. **Action buttons** -- Two buttons at the bottom of the card:
   - "Cancel" -- secondary style, calls `setShowForm(false)` and resets form
   - "Save Channel" -- primary style, calls the save handler, disabled when `isSaving` or form incomplete

**Validation before save:**
- `adapter` must be set (not empty string)
- `name` must be non-empty
- `credential` must be non-empty (for both Slack and WhatsApp)
- For Slack, `channelIds` must be non-empty
- Generated slug must pass `isValidSlug()` check
- Generated slug must not exist in the current `channels` array (uniqueness check)
- If validation fails, set `formError` with a descriptive message

**Save handler (`handleSaveChannel`):**

```typescript
async function handleSaveChannel() {
  setFormError(null);
  const slug = slugify(`${form.adapter}-${form.name}`);

  // Validation
  if (!form.adapter) { setFormError('Select an adapter type'); return; }
  if (!form.name.trim()) { setFormError('Name is required'); return; }
  if (!form.credential.trim()) { setFormError('Credential is required'); return; }
  if (!isValidSlug(slug)) { setFormError('Generated slug is invalid. Use only letters, numbers, and hyphens.'); return; }
  if (channels.some(c => c.slug === slug)) { setFormError(`A channel with slug "${slug}" already exists`); return; }
  if (form.adapter === 'slack' && !form.channelIds.trim()) { setFormError('At least one Slack channel ID is required'); return; }

  setIsSaving(true);
  try {
    const config: ChannelConfig = {
      slug,
      enabled: true,
      adapter: form.adapter,
      pollIntervalMs: form.adapter === 'slack' ? (parseInt(String(form.pollIntervalMs)) || 10000) : undefined,
      credentials: { channelSlug: slug },
      filter: {
        channelIds: form.adapter === 'slack' && form.channelIds.trim()
          ? form.channelIds.split(',').map(s => s.trim()).filter(Boolean)
          : undefined,
        triggerPatterns: form.triggerPatterns.trim()
          ? form.triggerPatterns.split(',').map(s => s.trim()).filter(Boolean)
          : undefined,
      },
    };

    // Sequence: config first, then credential (Plan 01's delivery trigger fires after each)
    await window.electronAPI.updateChannel(activeWorkspaceId, config);
    await window.electronAPI.setChannelCredential(activeWorkspaceId, slug, form.credential);

    // Optimistic update
    setChannels(prev => [...prev, config]);
    setShowForm(false);
    setForm(initialFormState);
    toast.success('Channel created');
  } catch (err) {
    console.error('[ChannelSettings] Failed to create channel:', err);
    toast.error('Failed to create channel');
  } finally {
    setIsSaving(false);
  }
}
```

**Imports to add:**
- `Plus` from `lucide-react`
- `slugify`, `isValidSlug` from `@/lib/slugify`
- `SettingsInput`, `SettingsSecretInput`, `SettingsRadioGroup`, `SettingsRadioCard` from `@/components/settings`
- `Button` from `@/components/ui/button` (for Save/Cancel buttons)

**Styling notes:**
- The form section uses the same spacing and card styling as the existing daemon and channel list sections.
- Cancel and Save buttons should be in a flex row with `justify-end` alignment.
- Use `cn()` for conditional classes as done elsewhere in the file.
- The form error message displays above the buttons as `text-sm text-destructive`.
- When `showForm` is true, hide the "Add Channel" button to prevent double-form.

**Do NOT:**
- Create a separate component file. The form is small enough to live in the page file.
- Add a new IPC handler. Use existing `updateChannel` and `setChannelCredential`.
- Use a Dialog/Modal. The research recommends inline expansion matching existing patterns.
  </action>
  <verify>
`bun run typecheck:all` passes. `bun run lint:electron` has no new errors. Visual review: the form renders with adapter selection, conditional fields, and save/cancel buttons.
  </verify>
  <done>
ChannelSettingsPage has an "Add Channel" button that reveals an inline form with adapter-conditional fields, slug auto-generation with uniqueness validation, credential storage, and optimistic list update on save.
  </done>
</task>

</tasks>

<verification>
1. `bun run typecheck:all` passes with zero errors.
2. `bun run lint:electron` passes (0 errors, pre-existing warnings only).
3. The "Add Channel" button is visible on the Channels settings page.
4. Selecting an adapter type shows adapter-specific fields.
5. Save validates all required fields and checks slug uniqueness.
6. After saving, the new channel appears in the channel list immediately.
7. The credential is stored via `setChannelCredential` IPC.
</verification>

<success_criteria>
- Users can create a Slack channel by selecting adapter type, entering name, bot token, and channel IDs.
- Users can create a WhatsApp channel by selecting adapter type, entering name, and auth state path.
- Slug is auto-generated from adapter + name and validated for uniqueness.
- Credential is encrypted and stored before daemon reconfiguration.
- Channel appears in the list immediately after creation without page refresh.
- Form validates all required fields and shows error messages.
</success_criteria>

<output>
After completion, create `.planning/phases/16-channel-creation-ui-and-config-delivery/16-02-SUMMARY.md`
</output>
