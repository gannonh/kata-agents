---
phase: 04-pr-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/shared/src/git/types.ts
  - packages/shared/src/git/pr-service.ts
  - packages/shared/src/git/index.ts
  - apps/electron/src/shared/types.ts
  - apps/electron/src/main/ipc.ts
  - apps/electron/src/preload/index.ts
autonomous: true

must_haves:
  truths:
    - "PR data is fetched asynchronously from gh CLI"
    - "Errors from gh CLI return null (graceful degradation)"
    - "Renderer can request PR status via IPC"
  artifacts:
    - path: "packages/shared/src/git/types.ts"
      provides: "PrInfo interface"
      contains: "interface PrInfo"
    - path: "packages/shared/src/git/pr-service.ts"
      provides: "getPrStatus function"
      exports: ["getPrStatus"]
    - path: "packages/shared/src/git/index.ts"
      provides: "Public exports including PrInfo and getPrStatus"
      contains: "getPrStatus"
    - path: "apps/electron/src/shared/types.ts"
      provides: "PR_STATUS IPC channel and PrInfo type export"
      contains: "PR_STATUS"
    - path: "apps/electron/src/main/ipc.ts"
      provides: "PR_STATUS IPC handler"
      contains: "PR_STATUS"
    - path: "apps/electron/src/preload/index.ts"
      provides: "getPrStatus preload method"
      contains: "getPrStatus"
  key_links:
    - from: "apps/electron/src/main/ipc.ts"
      to: "packages/shared/src/git/pr-service.ts"
      via: "import getPrStatus"
      pattern: "import.*getPrStatus.*from.*@craft-agent/shared/git"
    - from: "apps/electron/src/preload/index.ts"
      to: "IPC_CHANNELS.PR_STATUS"
      via: "ipcRenderer.invoke"
      pattern: "ipcRenderer\\.invoke\\(IPC_CHANNELS\\.PR_STATUS"
---

<objective>
Create the PR service module and wire it to the Electron IPC layer.

Purpose: Enable the renderer to fetch PR information for the current git branch via the gh CLI.
Output: PrInfo type, getPrStatus function, and complete IPC wiring from main to renderer.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pr-integration/04-RESEARCH.md

# Phase 3 established patterns
@.planning/phases/03-core-git-service/03-01-SUMMARY.md
@.planning/phases/03-core-git-service/03-02-SUMMARY.md

# Existing implementation to extend
@packages/shared/src/git/types.ts
@packages/shared/src/git/git-service.ts
@packages/shared/src/git/index.ts
@apps/electron/src/shared/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PR Service Module</name>
  <files>
    packages/shared/src/git/types.ts
    packages/shared/src/git/pr-service.ts
    packages/shared/src/git/index.ts
  </files>
  <action>
1. Add PrInfo interface to types.ts:
```typescript
export interface PrInfo {
  number: number
  title: string
  state: 'OPEN' | 'CLOSED' | 'MERGED'
  isDraft: boolean
  url: string
}
```

2. Create pr-service.ts with getPrStatus function:
- Import `execFile` from `node:child_process` and `promisify` from `node:util`
- Create `execFileAsync = promisify(execFile)`
- Export async function `getPrStatus(dirPath: string): Promise<PrInfo | null>`
- Execute: `gh pr view --json number,title,state,isDraft,url`
- Options: `{ cwd: dirPath, timeout: 5000 }` (5 second timeout)
- Parse JSON response and return as PrInfo
- Catch ALL errors and return null (graceful degradation)
- Log to DEBUG_GIT if enabled: `console.debug('[PrService] getPrStatus failed:', error)`

3. Update index.ts to export:
- `getPrStatus` from pr-service.ts
- `PrInfo` type from types.ts

Important: Follow the exact pattern from git-service.ts for error handling and logging.
  </action>
  <verify>
- `bun run typecheck:all` passes
- `packages/shared/src/git/pr-service.ts` exists with getPrStatus function
- `packages/shared/src/git/index.ts` exports getPrStatus and PrInfo
  </verify>
  <done>
- PrInfo interface defined in types.ts
- getPrStatus function in pr-service.ts using promisified execFile
- All errors caught and return null (no thrown errors)
- Exports available via @craft-agent/shared/git
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire PR Service to IPC Layer</name>
  <files>
    apps/electron/src/shared/types.ts
    apps/electron/src/main/ipc.ts
    apps/electron/src/preload/index.ts
  </files>
  <action>
1. Update apps/electron/src/shared/types.ts:
- Import PrInfo from @craft-agent/shared/git (add to existing GitState import)
- Export PrInfo type
- Add `PR_STATUS: 'pr:status'` to IPC_CHANNELS (after GIT_STATUS line)
- Add `getPrStatus(dirPath: string): Promise<PrInfo | null>` to ElectronAPI interface

2. Update apps/electron/src/main/ipc.ts:
- Add getPrStatus to the import from @craft-agent/shared/git
- Add IPC handler for PR_STATUS:
```typescript
ipcMain.handle(IPC_CHANNELS.PR_STATUS, async (_event, dirPath: string) => {
  return getPrStatus(dirPath)
})
```

3. Update apps/electron/src/preload/index.ts:
- Add getPrStatus method to the api object:
```typescript
getPrStatus: (dirPath: string) => ipcRenderer.invoke(IPC_CHANNELS.PR_STATUS, dirPath),
```

Pattern: Follow the exact structure used for GIT_STATUS (see 03-02-SUMMARY.md).
  </action>
  <verify>
- `bun run typecheck:all` passes
- PR_STATUS channel defined in IPC_CHANNELS
- PrInfo type exported from shared/types.ts
- getPrStatus method in ElectronAPI interface
- IPC handler registered in ipc.ts
- Preload bridge exposes getPrStatus
  </verify>
  <done>
- PR_STATUS IPC channel defined
- PrInfo type flows from shared package through types.ts
- IPC handler calls getPrStatus from git module
- Preload exposes window.electronAPI.getPrStatus(dirPath)
- Renderer can request PR status for any directory path
  </done>
</task>

</tasks>

<verification>
1. Type checking passes: `bun run typecheck:all`
2. PR service file exists: `ls packages/shared/src/git/pr-service.ts`
3. IPC channel defined: grep "PR_STATUS" in shared/types.ts
4. Preload method exists: grep "getPrStatus" in preload/index.ts
</verification>

<success_criteria>
- PrInfo interface and getPrStatus function created in git module
- IPC channel PR_STATUS wired end-to-end (main -> preload -> renderer)
- All errors in getPrStatus caught and return null (graceful degradation)
- Type checking passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-pr-integration/04-01-SUMMARY.md`
</output>
