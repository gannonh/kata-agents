---
phase: 02-rebranding
plan: 04
type: execute
wave: 2
depends_on:
  - "02-01"
  - "02-02"
  - "02-03"
files_modified:
  - packages/shared/src/docs/doc-links.ts
  - packages/shared/src/version/manifest.ts
  - packages/shared/src/sources/builtin-sources.ts
  - packages/shared/src/prompts/system.ts
  - packages/shared/src/auth/slack-oauth.ts
  - packages/shared/src/validation/url-validator.ts
  - apps/electron/src/main/menu.ts
  - apps/electron/src/main/auto-update.ts
  - apps/electron/electron-builder.yml
  - apps/electron/package.json
  - scripts/install-app.sh
  - scripts/install-app.ps1
autonomous: true

must_haves:
  truths:
    - "No craft.do domain references in active code paths (OAuth features using craft.do relay are disabled with clear error messages)"
    - "Help menu links are disabled or point to valid URLs"
    - "Version in package.json is 0.4.0"
    - "GitHub release workflow will create v0.4.0 release"
    - "Slack OAuth returns graceful error explaining feature unavailability"
  artifacts:
    - path: "apps/electron/package.json"
      provides: "Package with version 0.4.0"
      contains: '"version": "0.4.0"'
    - path: ".github/workflows/release.yml"
      provides: "Release workflow (existing, no changes needed)"
      min_lines: 10
    - path: "packages/shared/src/auth/slack-oauth.ts"
      provides: "Slack OAuth with disabled state"
      contains: "SLACK_OAUTH_DISABLED"
  key_links:
    - from: "apps/electron/package.json"
      to: ".github/workflows/release.yml"
      via: "version change trigger"
      pattern: "version.*0\\.4\\.0"
---

<objective>
Remove or update all craft.do domain references in the codebase and configure the project for v0.4.0 release via GitHub Actions.

Purpose: Achieves trademark compliance (BRAND-03) by removing external references to Craft infrastructure, and prepares the distribution mechanism (DIST-01) for the first Kata Desktop release.

Output: Codebase has no craft.do references in active code paths (features depending on craft.do infrastructure are gracefully disabled), and pushing to main with version 0.4.0 will trigger a GitHub release.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-rebranding/02-RESEARCH.md

@packages/shared/src/docs/doc-links.ts
@packages/shared/src/version/manifest.ts
@packages/shared/src/auth/slack-oauth.ts
@packages/shared/src/validation/url-validator.ts
@apps/electron/src/main/auto-update.ts
@.github/workflows/release.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove/update craft.do domain references</name>
  <files>
    packages/shared/src/docs/doc-links.ts
    packages/shared/src/version/manifest.ts
    packages/shared/src/sources/builtin-sources.ts
    packages/shared/src/prompts/system.ts
    packages/shared/src/auth/slack-oauth.ts
    packages/shared/src/validation/url-validator.ts
    apps/electron/src/main/menu.ts
    apps/electron/src/main/auto-update.ts
    apps/electron/electron-builder.yml
    scripts/install-app.sh
    scripts/install-app.ps1
  </files>
  <action>
Find all craft.do references and handle appropriately:

```bash
grep -r "craft\.do" --include="*.ts" --include="*.tsx" --include="*.yml" --include="*.sh" --include="*.ps1" .
```

For each file, apply the appropriate fix:

1. **packages/shared/src/docs/doc-links.ts** - DOC_BASE_URL:
   ```typescript
   // Disable external docs until kata.sh docs exist
   export const DOC_BASE_URL = '';  // Was: 'https://agents.craft.do/docs'
   ```

2. **packages/shared/src/version/manifest.ts** - VERSIONS_URL:
   ```typescript
   // Disable version manifest until kata.sh hosts it
   export const VERSIONS_URL = '';  // Was: 'https://agents.craft.do/...'
   ```

3. **packages/shared/src/sources/builtin-sources.ts** - MCP docs:
   - Comment out or remove mcp.craft.do references
   - These are documentation URLs, safe to disable

4. **packages/shared/src/prompts/system.ts** - Git co-author:
   - Change "Craft Agent" email to "Kata Desktop" or generic
   - `git-co-author@kata.sh` or similar placeholder

5. **apps/electron/src/main/menu.ts** - Help menu:
   - Line 199: Change `https://agents.craft.do/docs` to `https://github.com/gannonh/kata-desktop` (GitHub repo as docs for now)

6. **apps/electron/src/main/auto-update.ts** - Update server:
   - The update URL is also in electron-builder.yml
   - Comment out or disable auto-update until kata.sh update server exists
   - Add a comment explaining this is disabled

7. **apps/electron/electron-builder.yml** - publish.url:
   - Line 41: Comment out the generic provider or change to GitHub releases:
   ```yaml
   publish:
     provider: github
     owner: gannonh
     repo: kata-desktop
   ```
   This enables auto-update from GitHub releases.

8. **scripts/install-app.sh** and **scripts/install-app.ps1**:
   - These reference agents.craft.do for downloads
   - Update to use GitHub releases URL or disable

9. **packages/shared/src/auth/slack-oauth.ts** - OAuth redirect (CRITICAL):
   - Line 282 uses `https://agents.craft.do/auth/slack/callback` as OAuth redirect
   - Slack OAuth REQUIRES HTTPS redirect URIs, and we don't have a relay server
   - **Solution:** Disable Slack OAuth gracefully:
     - Add constant `SLACK_OAUTH_DISABLED = true` with explanation comment
     - Modify `startSlackOAuth()` to return early with clear error:
       ```typescript
       const SLACK_OAUTH_DISABLED = true;
       const SLACK_OAUTH_DISABLED_REASON =
         'Slack OAuth is temporarily unavailable. The OAuth relay server (agents.craft.do) ' +
         'is not available for this fork. This feature will be restored when a replacement ' +
         'relay is configured.';

       // At start of startSlackOAuth():
       if (SLACK_OAUTH_DISABLED) {
         return {
           success: false,
           error: SLACK_OAUTH_DISABLED_REASON,
         };
       }
       ```
   - Do NOT remove the implementation - keep it for when relay is set up later
   - Document in comments that relay setup requires: Cloudflare Worker or similar HTTPS endpoint

10. **packages/shared/src/validation/url-validator.ts** - MCP URL validation:
    - Lines 24-55 contain SYSTEM_PROMPT with Craft MCP examples (mcp.craft.do)
    - This is an AI prompt teaching URL validation patterns
    - **Solution:** Update examples to use generic placeholder domain:
      ```typescript
      VALID URL EXAMPLES:
      - https://mcp.example.com/links/DSdsfdsjkf34235/mcp
      - https://mcp.example.com/links/ABC123/mcp

      // OR disable the feature entirely if MCP validation won't work without Craft
      ```
    - If this validator is specific to Craft's MCP infrastructure, consider:
      - Returning `{ valid: true }` always (bypass validation)
      - Or disabling the validation endpoint entirely

Also check for support@craft.do and security@craft.do:
- Update to appropriate Kata contact or remove
  </action>
  <verify>
# Check critical files individually (OAuth and validation)
grep -c "SLACK_OAUTH_DISABLED" packages/shared/src/auth/slack-oauth.ts
# Should return 1 or more (disabled flag exists)

grep "agents\.craft\.do" packages/shared/src/auth/slack-oauth.ts | grep -v "^[[:space:]]*\(//\|/\*\|\*\)"
# Should return empty (no active craft.do references, only in comments)

# Check other source files (excluding comments and test examples in validation prompt)
grep -r "craft\.do" --include="*.ts" --include="*.tsx" --include="*.yml" --include="*.sh" --include="*.ps1" . \
  | grep -v "node_modules" \
  | grep -v ".planning" \
  | grep -v "NOTICE" \
  | grep -v "LICENSE" \
  | grep -v "TRADEMARK" \
  | grep -v "url-validator.ts.*EXAMPLE" \
  | grep -v "//.*craft\.do" \
  | grep -v "#.*craft\.do"
# Should return no matches (active code paths cleaned)
  </verify>
  <done>
No craft.do references remain in active source code. Slack OAuth is gracefully disabled with clear error message. MCP URL validation updated or disabled.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update version and verify release workflow</name>
  <files>
    apps/electron/package.json
    .github/workflows/release.yml
  </files>
  <action>
1. Update version in apps/electron/package.json:
   - Find the "version" field (currently something like "0.3.x")
   - Change to "0.4.0"

2. Verify release.yml workflow configuration:
   ```bash
   cat .github/workflows/release.yml
   ```

   The workflow should:
   - Trigger on push to main when version changes
   - Build for macOS (arm64, x64), Windows (x64), Linux (x64)
   - Create GitHub release with artifacts

   If the workflow uses `electron-builder --publish always`, it will automatically:
   - Create a GitHub release tagged with the version
   - Upload all built artifacts

3. Ensure the workflow has proper permissions:
   ```yaml
   permissions:
     contents: write  # Needed to create releases
   ```

4. Update any "Craft" references in the workflow file to "Kata":
   - Release name/title if customized
   - Any artifact naming (should already use ${productName} from electron-builder.yml)
  </action>
  <verify>
grep '"version"' apps/electron/package.json | head -1
# Should show "version": "0.4.0"
grep -E "(contents: write|permissions:)" .github/workflows/release.yml
# Should show permissions for release creation
  </verify>
  <done>
Version is 0.4.0 and release workflow has correct permissions for GitHub release creation
  </done>
</task>

<task type="auto">
  <name>Task 3: Final verification and documentation cleanup</name>
  <files>
    README.md
    SECURITY.md
    CODE_OF_CONDUCT.md
  </files>
  <action>
1. Run comprehensive craft.do search:
   ```bash
   grep -r "craft\.do" . --include="*.ts" --include="*.tsx" --include="*.js" --include="*.json" --include="*.yml" --include="*.yaml" --include="*.md" --include="*.sh" --include="*.ps1" | grep -v node_modules | grep -v ".planning" | grep -v "bun.lock"
   ```

   Categorize results:
   - **Must remove:** Active code paths (already handled in Task 1)
   - **Keep:** LICENSE, NOTICE, TRADEMARK.md (required attribution)
   - **Acceptable:** Comments explaining disabled features, AI prompt examples
   - **Update:** README.md, SECURITY.md, CODE_OF_CONDUCT.md (user-facing docs)

2. Update README.md:
   - Change project name to Kata Desktop
   - Update any craft.do links to GitHub or remove
   - Keep attribution to original Craft Agents project

3. Update SECURITY.md:
   - Change security@craft.do to appropriate contact
   - Or link to GitHub security advisories

4. Update CODE_OF_CONDUCT.md:
   - Change any Craft-specific references
   - Keep standard code of conduct content

5. Run type check to ensure no broken imports:
   ```bash
   bun run typecheck:all
   ```

6. Run tests to ensure nothing broke:
   ```bash
   bun test
   ```
  </action>
  <verify>
# Verify no ACTIVE craft.do references (comments and attribution files are OK)
# This counts only non-comment, non-attribution references in TypeScript files
grep -r "craft\.do" --include="*.ts" --include="*.tsx" . \
  | grep -v "node_modules" \
  | grep -v ".planning" \
  | grep -v "//.*craft\.do" \
  | grep -v "Was:.*craft\.do" \
  | grep -v "DISABLED" \
  | grep -v "EXAMPLE" \
  | wc -l
# Should be 0 (no active code references)

bun run typecheck:all && echo "Type check: OK"
bun test && echo "Tests: OK"
  </verify>
  <done>
All craft.do references removed from active code, documentation updated, build and tests pass. Disabled features are documented with clear comments explaining why.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Critical OAuth check (Slack won't break):
```bash
grep "SLACK_OAUTH_DISABLED" packages/shared/src/auth/slack-oauth.ts
# Should show the disabled flag
```

2. Active code reference check:
```bash
# Count active (non-comment) craft.do references in TypeScript
grep -r "craft\.do" --include="*.ts" --include="*.tsx" . \
  | grep -v node_modules \
  | grep -v ".planning" \
  | grep -v "//.*craft\.do" \
  | grep -v "DISABLED" \
  | grep -v "EXAMPLE" \
  | grep -v "Was:" \
  | wc -l
# Should be 0
```

3. Version check:
```bash
grep '"version": "0.4.0"' apps/electron/package.json && echo "Version: OK"
```

4. Build verification:
```bash
bun run electron:build
# Should complete successfully
```

5. Release workflow check:
```bash
grep "provider: github" apps/electron/electron-builder.yml || grep "contents: write" .github/workflows/release.yml
# At least one should match (either GitHub provider in builder or write permissions in workflow)
```
</verification>

<success_criteria>
1. Slack OAuth disabled gracefully (returns clear error, doesn't crash)
2. Active TypeScript references to craft.do: 0 (comments/disabled-markers excluded)
3. `grep '"version": "0.4.0"' apps/electron/package.json` returns a match
4. `bun run typecheck:all` passes
5. `bun test` passes
6. Release workflow is configured to create GitHub releases
</success_criteria>

<output>
After completion, create `.planning/phases/02-rebranding/02-04-SUMMARY.md`
</output>
