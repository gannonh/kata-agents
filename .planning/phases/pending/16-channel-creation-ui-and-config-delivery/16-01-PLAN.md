---
phase: 16-channel-creation-ui-and-config-delivery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/electron/src/main/channel-config-delivery.ts
  - apps/electron/src/main/ipc.ts
  - apps/electron/src/main/index.ts
autonomous: true
must_haves:
  truths:
    - When the daemon reaches running state, it receives all enabled channel configs with resolved credentials
    - When a channel is created, toggled, or deleted in the UI, the running daemon is reconfigured within seconds
    - Empty workspaces array is sent to clear previously running adapters when no channels exist
  artifacts:
    - apps/electron/src/main/channel-config-delivery.ts (new file, deliverChannelConfigs function)
  key_links:
    - DaemonManager onEvent callback calls deliverChannelConfigs on status_changed running
    - CHANNELS_UPDATE and CHANNELS_DELETE IPC handlers call deliverChannelConfigs after mutation
    - CHANNEL_CREDENTIAL_SET IPC handler calls deliverChannelConfigs after credential save
    - deliverChannelConfigs resolves credentials via channelSlug (preferred) then sourceSlug (legacy fallback)
---

<objective>
Create the config delivery bridge between channel configuration on disk and the running daemon process.

Purpose: Gap 3 from Phase 14 analysis. The daemon starts but never receives channel configs because nothing sends the configure_channels command. This plan adds that missing function and hooks it into two trigger points: daemon startup and channel mutations.

Output: A `deliverChannelConfigs()` function in a new module, wired into the daemon event callback and channel IPC handlers.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@packages/core/src/types/daemon.ts
@packages/shared/src/daemon/entry.ts (lines 88-122, configure_channels handler)
@apps/electron/src/main/daemon-manager.ts
@apps/electron/src/main/index.ts (lines 320-340, DaemonManager creation + onEvent callback)
@apps/electron/src/main/ipc.ts (lines 2570-2636, channel and daemon IPC handlers)
@packages/shared/src/channels/types.ts (ChannelConfig type)
@packages/shared/src/credentials/manager.ts (getChannelCredential, get methods)
@packages/shared/src/config/storage.ts (getWorkspaces function)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deliverChannelConfigs module</name>
  <files>apps/electron/src/main/channel-config-delivery.ts</files>
  <action>
Create a new module `apps/electron/src/main/channel-config-delivery.ts` with a single exported async function `deliverChannelConfigs`.

The function signature:
```typescript
export async function deliverChannelConfigs(
  daemonManager: DaemonManager,
  credentialManagerGetter: () => CredentialManager,
): Promise<void>
```

Implementation:
1. Guard: if `daemonManager.getState() !== 'running'`, return immediately.
2. Call `getWorkspaces()` from `@craft-agent/shared/config` to get all workspaces.
3. For each workspace:
   a. Expand `rootPath` by replacing `~` with `homedir()`.
   b. Build the channels directory path: `join(rootPath, 'channels')`.
   c. If directory does not exist, skip this workspace.
   d. Read directory entries with `readdirSync`.
   e. For each slug, validate with `/^[a-zA-Z0-9][a-zA-Z0-9_-]*$/` (same pattern as `isValidSlug` in ipc.ts).
   f. Read `config.json` from the channel directory, parse as `ChannelConfig`.
   g. Skip if `!config.enabled`.
   h. Resolve credential: if `config.credentials.channelSlug` exists, call `credManager.getChannelCredential(workspaceId, channelSlug)`. Otherwise if `config.credentials.sourceSlug` exists, call `credManager.get({ type: 'source_api_key', workspaceId, sourceId: sourceSlug })`. Store resolved token in a `tokens` record keyed by the slug used.
   i. Collect configs and tokens into the workspace payload.
4. Derive `enabledPlugins` from the adapter types present in configs (e.g., if any config has `adapter: 'slack'`, include `'slack'`; if `'whatsapp'`, include `'whatsapp'`).
5. Build the full payload and send: `daemonManager.sendCommand({ type: 'configure_channels', workspaces: workspacePayloads })`. Always send, even if workspaces array is empty (clears previously running adapters).

Import types:
- `DaemonManager` from `./daemon-manager`
- `ChannelConfig` from `@craft-agent/shared/channels`
- `getWorkspaces` from `@craft-agent/shared/config`
- `CredentialManager` from `@craft-agent/shared/credentials`
- Standard node: `join` from `path`, `homedir` from `os`, `existsSync`, `readdirSync`, `readFileSync` from `fs`

Do NOT import `getCredentialManager` directly. Accept it as a parameter (getter function) to avoid circular dependency and allow testing. The caller in `ipc.ts` already has access to `getCredentialManager`.

Add a console.error log for skipped malformed configs (same pattern as existing CHANNELS_GET handler).
  </action>
  <verify>
`bun run typecheck:all` passes. The file exists and exports `deliverChannelConfigs`.
  </verify>
  <done>
`channel-config-delivery.ts` exports a function that loads all workspace channel configs, resolves credentials, and sends a `configure_channels` command to the daemon.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire delivery triggers into daemon events and IPC handlers</name>
  <files>
    apps/electron/src/main/index.ts
    apps/electron/src/main/ipc.ts
  </files>
  <action>
Two trigger points need wiring:

**Trigger 1: Daemon reaches running state (index.ts)**

In `apps/electron/src/main/index.ts`, in the `DaemonManager` constructor's `onEvent` callback (around line 327), add a check after the existing event forwarding code:

```typescript
// After: mainLog.info('[daemon] event:', event.type)
// After: for...send DAEMON_EVENT
if (event.type === 'status_changed' && event.status === 'running') {
  deliverChannelConfigs(daemonManager!, getCredentialManager).catch((err) => {
    mainLog.error('[daemon] Failed to deliver channel configs:', err);
  });
}
```

Import `deliverChannelConfigs` from `./channel-config-delivery`.
Import `getCredentialManager` from `@craft-agent/shared/credentials`.

**Trigger 2: Channel mutations (ipc.ts)**

In `apps/electron/src/main/ipc.ts`, modify `registerIpcHandlers` to use `deliverChannelConfigs` after channel mutations. The function needs access to `daemonManager` (already available as parameter).

Import `deliverChannelConfigs` from `./channel-config-delivery` at the top of ipc.ts.
Import `getCredentialManager` from `@craft-agent/shared/credentials` (check if already imported; if so, reuse).

After the CHANNELS_UPDATE handler writes the config file (line ~2606), add:
```typescript
if (daemonManager) {
  deliverChannelConfigs(daemonManager, getCredentialManager).catch((err) => {
    ipcLog.error('[channels:update] Failed to deliver channel configs:', err);
  });
}
```

After the CHANNELS_DELETE handler removes the directory (line ~2616), add the same pattern.

After the CHANNEL_CREDENTIAL_SET handler saves the credential (line ~2625), add the same pattern.

Do NOT trigger on CHANNEL_CREDENTIAL_DELETE or CHANNEL_CREDENTIAL_EXISTS (delete of credential alone does not need immediate daemon reconfigure; the channel config itself determines enabled state).

All calls to `deliverChannelConfigs` must be fire-and-forget with `.catch()` error logging. Channel mutations must not fail if daemon delivery fails.
  </action>
  <verify>
`bun run typecheck:all` passes. `bun run lint:electron` has no new errors (pre-existing warnings acceptable).
  </verify>
  <done>
Three trigger points wired: (1) daemon running event in index.ts, (2) CHANNELS_UPDATE handler, (3) CHANNELS_DELETE handler, (4) CHANNEL_CREDENTIAL_SET handler. All fire-and-forget with error logging.
  </done>
</task>

</tasks>

<verification>
1. `bun run typecheck:all` passes with zero errors.
2. `bun run lint:electron` passes (0 errors, pre-existing warnings only).
3. `bun test packages/shared` passes (existing tests unaffected).
4. Manual code review confirms:
   - `deliverChannelConfigs` guards against non-running daemon state.
   - Empty workspace array is sent (not skipped) to clear stale adapters.
   - Credential resolution uses channelSlug first, sourceSlug as fallback.
   - rootPath tilde expansion is applied.
   - All delivery calls are fire-and-forget with catch handlers.
</verification>

<success_criteria>
- `channel-config-delivery.ts` module exists and is imported by both `index.ts` and `ipc.ts`.
- When daemon emits `status_changed: running`, channel configs are delivered within the same event loop tick.
- When CHANNELS_UPDATE, CHANNELS_DELETE, or CHANNEL_CREDENTIAL_SET IPC handlers complete their mutation, `deliverChannelConfigs` is called if daemon is running.
- Type checking and linting pass.
</success_criteria>

<output>
After completion, create `.planning/phases/16-channel-creation-ui-and-config-delivery/16-01-SUMMARY.md`
</output>
