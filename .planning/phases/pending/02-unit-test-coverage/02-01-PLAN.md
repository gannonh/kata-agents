---
phase: 02-unit-test-coverage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bunfig.toml
  - .planning/REQUIREMENTS.md
autonomous: true

must_haves:
  truths:
    - "Developer runs `bun run test:coverage` and sees coverage report without release directory artifacts"
    - "Coverage report shows only source files from packages/ and apps/electron/src/"
    - "Test files are excluded from coverage percentages"
  artifacts:
    - path: "bunfig.toml"
      provides: "Coverage configuration"
      contains: "coverageSkipTestFiles"
  key_links:
    - from: "bunfig.toml"
      to: "bun test --coverage"
      via: "bun test runner reads config"
      pattern: "\\[test\\]"
---

<objective>
Configure Bun test runner coverage settings to produce clean, actionable reports.

Purpose: The current `bun run test:coverage` output includes release directory artifacts and test files, creating noise. Proper bunfig.toml configuration will exclude these and produce focused reports showing only source file coverage.

Output: Updated bunfig.toml with coverage configuration. Requirement COV-01 marked complete.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/pending/02-unit-test-coverage/02-RESEARCH.md
@bunfig.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure coverage in bunfig.toml</name>
  <files>bunfig.toml</files>
  <action>
Update bunfig.toml to add coverage configuration under the existing [test] section:

```toml
[test]
preload = ["./packages/shared/src/network-interceptor.ts"]
coverageSkipTestFiles = true
coveragePathIgnorePatterns = [
  "**/release/**",
  "**/node_modules/**",
  "**/*.d.ts"
]
```

This configuration:
- `coverageSkipTestFiles = true`: Excludes test files from coverage percentages
- `coveragePathIgnorePatterns`: Excludes release artifacts and type definitions

Do NOT add `coverage = true` (coverage should only run when explicitly requested via --coverage flag).
Do NOT add `coverageThreshold` yet (will be added after gaps documentation identifies realistic targets).
  </action>
  <verify>
Run `bun run test:coverage 2>&1 | head -50` and verify:
1. No files from `apps/electron/release/` appear in output
2. No `*.d.ts` files appear in output
3. Test files (`*.test.ts`) don't affect coverage percentages
  </verify>
  <done>Coverage report shows only source files without release artifacts or test file pollution</done>
</task>

<task type="auto">
  <name>Task 2: Update requirements traceability</name>
  <files>.planning/REQUIREMENTS.md</files>
  <action>
In .planning/REQUIREMENTS.md, update COV-01 status:

Change:
```markdown
- [ ] **COV-01**: Coverage report runs via `bun test --coverage` and identifies untested modules
```

To:
```markdown
- [x] **COV-01**: Coverage report runs via `bun test --coverage` and identifies untested modules
```

Also update COV-02 since pr-service.test.ts already exists (discovered during planning):
```markdown
- [x] **COV-02**: pr-service.ts has unit tests following git-service.test.ts patterns
```

Add to Traceability table:
| COV-01 | Phase 2 | 02-01 | Complete |
| COV-02 | Phase 2 | Pre-existing | Complete |
  </action>
  <verify>Read .planning/REQUIREMENTS.md and confirm both COV-01 and COV-02 are marked [x]</verify>
  <done>Requirements traceability updated to reflect completed work</done>
</task>

</tasks>

<verification>
Run `bun run test:coverage 2>&1 | head -80` and verify:
- Output shows coverage percentages
- No release directory files in output
- Source files from packages/shared and packages/mermaid visible
</verification>

<success_criteria>
1. bunfig.toml contains coverage configuration
2. `bun run test:coverage` produces clean output without release artifacts
3. COV-01 and COV-02 marked complete in REQUIREMENTS.md
</success_criteria>

<output>
After completion, create `.planning/phases/pending/02-unit-test-coverage/02-01-SUMMARY.md`
</output>
