---
phase: 05-real-time-updates
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/electron/src/renderer/hooks/usePrStatus.ts
  - apps/electron/src/renderer/components/app-shell/input/FreeFormInput.tsx
autonomous: true

must_haves:
  truths:
    - "PR status refreshes periodically (every 5 minutes)"
    - "PR status refreshes when workspace gains focus"
    - "PR polling pauses when window is unfocused"
  artifacts:
    - path: "apps/electron/src/renderer/hooks/usePrStatus.ts"
      provides: "Focus-aware PR polling hook"
      exports: ["usePrStatus"]
    - path: "apps/electron/src/renderer/components/app-shell/input/FreeFormInput.tsx"
      provides: "PrBadge using usePrStatus hook"
      contains: "usePrStatus"
  key_links:
    - from: "apps/electron/src/renderer/hooks/usePrStatus.ts"
      to: "window.electronAPI.getPrStatus"
      via: "IPC call for PR data"
      pattern: "getPrStatus"
    - from: "apps/electron/src/renderer/hooks/usePrStatus.ts"
      to: "window.electronAPI.onWindowFocusChange"
      via: "Focus state tracking"
      pattern: "onWindowFocusChange"
---

<objective>
Create usePrStatus hook with focus-aware polling and refactor PrBadge to use it

Purpose: Keep PR status current without manual refresh (LIVE-02)
Output: usePrStatus hook with 5-minute polling interval, PrBadge component updated
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-real-time-updates/05-RESEARCH.md

# Existing implementation to refactor
@apps/electron/src/renderer/components/app-shell/input/FreeFormInput.tsx
@apps/electron/src/renderer/hooks/useGitStatus.ts
@apps/electron/src/preload/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create usePrStatus hook with focus-aware polling</name>
  <files>
    apps/electron/src/renderer/hooks/usePrStatus.ts
  </files>
  <action>
Create `apps/electron/src/renderer/hooks/usePrStatus.ts`:

```typescript
/**
 * usePrStatus - Hook for PR status with focus-aware polling
 *
 * Provides PR information for the current working directory with:
 * - Initial fetch on mount
 * - Refresh on branch change
 * - Refresh on window focus
 * - Periodic polling (5 minutes) when window is focused
 *
 * Polling pauses when window is unfocused to save battery/resources.
 *
 * Usage:
 *   const { prInfo, isLoading, refresh } = usePrStatus(workingDirectory, currentBranch)
 */

import { useState, useEffect, useCallback, useRef } from 'react'
import type { PrInfo } from '../../shared/types'

// Poll every 5 minutes when window is focused
const PR_POLL_INTERVAL_MS = 5 * 60 * 1000

interface UsePrStatusResult {
  /** PR info for current branch, null if no PR or error */
  prInfo: PrInfo | null
  /** True if PR status is being fetched */
  isLoading: boolean
  /** Manually refresh PR status */
  refresh: () => Promise<void>
}

/**
 * Hook to access PR status for a working directory.
 * Automatically polls when window is focused.
 *
 * @param workingDirectory - Absolute path to working directory (git repo)
 * @param currentBranch - Current branch name (triggers refresh on change)
 * @returns PR info, loading state, and refresh function
 */
export function usePrStatus(
  workingDirectory: string | undefined,
  currentBranch: string | null
): UsePrStatusResult {
  const [prInfo, setPrInfo] = useState<PrInfo | null>(null)
  const [isLoading, setIsLoading] = useState(false)
  const [isFocused, setIsFocused] = useState(true)
  const lastBranchRef = useRef<string | null>(null)

  // Track window focus state
  useEffect(() => {
    const unsubscribe = window.electronAPI?.onWindowFocusChange?.((focused) => {
      setIsFocused(focused)
    })
    return unsubscribe
  }, [])

  // Fetch PR status
  const fetchPrStatus = useCallback(async () => {
    if (!workingDirectory) {
      setPrInfo(null)
      return
    }

    setIsLoading(true)
    try {
      const info = await window.electronAPI?.getPrStatus?.(workingDirectory)
      setPrInfo(info ?? null)
    } catch (error) {
      console.error('[usePrStatus] Fetch failed:', error)
      setPrInfo(null)
    } finally {
      setIsLoading(false)
    }
  }, [workingDirectory])

  // Initial fetch on mount or working directory change
  useEffect(() => {
    fetchPrStatus()
  }, [fetchPrStatus])

  // Refresh on branch change
  useEffect(() => {
    // Skip initial mount (lastBranchRef is null)
    if (lastBranchRef.current !== null && currentBranch !== lastBranchRef.current) {
      fetchPrStatus()
    }
    lastBranchRef.current = currentBranch
  }, [currentBranch, fetchPrStatus])

  // Refresh on window focus (LIVE-03 related - keep PR fresh)
  useEffect(() => {
    if (isFocused && workingDirectory) {
      fetchPrStatus()
    }
  }, [isFocused, workingDirectory, fetchPrStatus])

  // Periodic polling when window is focused (LIVE-02)
  useEffect(() => {
    if (!isFocused || !workingDirectory) {
      return // Don't poll when unfocused or no working directory
    }

    const interval = setInterval(() => {
      fetchPrStatus()
    }, PR_POLL_INTERVAL_MS)

    return () => clearInterval(interval)
  }, [isFocused, workingDirectory, fetchPrStatus])

  return {
    prInfo,
    isLoading,
    refresh: fetchPrStatus,
  }
}
```
  </action>
  <verify>
    - `bun run typecheck:all` passes
    - File exists at `apps/electron/src/renderer/hooks/usePrStatus.ts`
    - Hook exports usePrStatus function
  </verify>
  <done>
    usePrStatus hook created with focus-aware polling (5-minute interval when focused)
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor PrBadge to use usePrStatus hook</name>
  <files>
    apps/electron/src/renderer/components/app-shell/input/FreeFormInput.tsx
  </files>
  <action>
1. Add import for usePrStatus at the top of FreeFormInput.tsx (with other imports):
   ```typescript
   import { usePrStatus } from '@/hooks/usePrStatus'
   ```

2. Find the PrBadge component (around line 1935) and refactor to use the hook:

   Update the component props to accept currentBranch:
   ```typescript
   function PrBadge({
     workingDirectory,
     currentBranch,
   }: {
     workingDirectory?: string
     currentBranch?: string | null
   }) {
     // Replace the useState and useEffect with the hook
     const { prInfo, isLoading } = usePrStatus(workingDirectory, currentBranch ?? null)

     // Don't render if no PR
     if (!prInfo) {
       return null
     }

     // ... rest of the component stays the same (icon/color logic, handleClick, JSX)
   ```

3. Update where PrBadge is rendered (around line 1418) to pass currentBranch:
   Find the line:
   ```typescript
   <PrBadge workingDirectory={workingDirectory} />
   ```

   The component needs access to currentBranch. Look for where gitState or branch info is available in the parent component. If not readily available, get it via useGitStatus or pass it from parent.

   Since PrBadge is rendered inside FreeFormInput which has access to workingDirectory, we need to also get git state there. Add:
   ```typescript
   // Near the top of FreeFormInput component, get git state for PR refresh trigger
   import { useGitStatus } from '@/hooks/useGitStatus'

   // Inside FreeFormInput, get the branch for PR refresh:
   const { gitState } = useGitStatus(workspaceId ?? null, workspaceRootPath ?? null)
   const currentBranch = gitState?.branch ?? null
   ```

   Then update the PrBadge usage:
   ```typescript
   <PrBadge workingDirectory={workingDirectory} currentBranch={currentBranch} />
   ```

   Note: FreeFormInput already receives workspaceId and workspaceRootPath as props or from context. Check existing code for how these are obtained and follow the same pattern.
  </action>
  <verify>
    - `bun run typecheck:all` passes
    - usePrStatus import exists in FreeFormInput.tsx
    - PrBadge uses usePrStatus hook
    - PrBadge receives currentBranch prop
    - Manual test: Start app, open git repo, observe PR badge; wait 5 minutes with window focused, observe refresh (add console.log in usePrStatus if needed)
  </verify>
  <done>
    PrBadge refactored to use usePrStatus hook with focus-aware polling
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Type checking: `bun run typecheck:all`
2. Manual test for LIVE-02 (periodic polling):
   - Start app: `bun run electron:dev`
   - Open a workspace with a branch that has an open PR
   - Observe PR badge appears
   - Add temporary console.log in usePrStatus fetchPrStatus function
   - Wait 5 minutes with window focused
   - Observe fetch happens every 5 minutes
   - Minimize/unfocus window for 5+ minutes
   - Observe no fetches while unfocused (check console or network)
3. Manual test for focus refresh:
   - Switch to another app
   - Wait a moment, switch back
   - Observe PR status refresh on focus (check console.log)
4. Manual test for branch change refresh:
   - Run `git checkout -b new-branch` in terminal
   - Observe PR status refresh (should clear since new branch has no PR)
</verification>

<success_criteria>
- usePrStatus hook created with focus-aware polling (5-minute interval)
- Polling pauses when window is unfocused
- PR status refreshes on window focus
- PR status refreshes on branch change
- PrBadge uses usePrStatus hook
- Type checking passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-real-time-updates/05-02-SUMMARY.md`
</output>
