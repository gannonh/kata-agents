---
phase: 05-real-time-updates
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - apps/electron/src/renderer/hooks/useGitStatus.ts
autonomous: true

must_haves:
  truths:
    - "Git status refreshes automatically when .git directory changes"
    - "Git status refreshes when workspace gains focus"
    - "UI updates within 1 second of git checkout/branch operation"
  artifacts:
    - path: "apps/electron/src/renderer/hooks/useGitStatus.ts"
      provides: "Git status hook with real-time updates"
      contains: ["onGitStatusChanged", "onWindowFocusChange"]
  key_links:
    - from: "apps/electron/src/renderer/hooks/useGitStatus.ts"
      to: "window.electronAPI.onGitStatusChanged"
      via: "IPC event listener"
      pattern: "onGitStatusChanged"
    - from: "apps/electron/src/renderer/hooks/useGitStatus.ts"
      to: "window.electronAPI.onWindowFocusChange"
      via: "Focus event listener"
      pattern: "onWindowFocusChange"
---

<objective>
Connect useGitStatus hook to GitWatcher events and window focus for real-time updates

Purpose: Complete LIVE-01 (file watching) and LIVE-03 (focus refresh) for git status
Output: useGitStatus hook responds to GIT_STATUS_CHANGED events and window focus
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-real-time-updates/05-RESEARCH.md
@.planning/phases/05-real-time-updates/05-01-PLAN.md

# Current implementation
@apps/electron/src/renderer/hooks/useGitStatus.ts
@apps/electron/src/shared/types.ts
@apps/electron/src/preload/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GIT_STATUS_CHANGED listener to useGitStatus</name>
  <files>
    apps/electron/src/renderer/hooks/useGitStatus.ts
  </files>
  <action>
Update `apps/electron/src/renderer/hooks/useGitStatus.ts` to listen for GIT_STATUS_CHANGED events:

1. Add a new useEffect that listens for GIT_STATUS_CHANGED events from main process:

```typescript
// Listen for git changes from file watcher (LIVE-01)
useEffect(() => {
  if (!workspaceRootPath) return

  const unsubscribe = window.electronAPI?.onGitStatusChanged?.((changedDir: string) => {
    // Only refresh if the change is for our workspace
    if (changedDir === workspaceRootPath) {
      console.debug('[useGitStatus] Git change detected, refreshing')
      refresh()
    }
  })

  return unsubscribe
}, [workspaceRootPath, refresh])
```

Place this after the existing useEffect that fetches on workspace change.
  </action>
  <verify>
    - `bun run typecheck:all` passes
    - useGitStatus.ts contains onGitStatusChanged listener
    - Manual test: Start app, open git repo, run `git checkout -b test-live-01-hook`, observe branch badge updates within 1 second
  </verify>
  <done>
    useGitStatus listens for GIT_STATUS_CHANGED events and auto-refreshes
  </done>
</task>

<task type="auto">
  <name>Task 2: Add window focus refresh to useGitStatus</name>
  <files>
    apps/electron/src/renderer/hooks/useGitStatus.ts
  </files>
  <action>
Update `apps/electron/src/renderer/hooks/useGitStatus.ts` to refresh on window focus:

1. Add state to track focus:
   ```typescript
   import { useEffect, useCallback, useState } from 'react'
   ```

2. Add focus tracking and refresh effect:

```typescript
// Track window focus for LIVE-03
const [isFocused, setIsFocused] = useState(true)

// Listen for window focus changes
useEffect(() => {
  const unsubscribe = window.electronAPI?.onWindowFocusChange?.((focused) => {
    setIsFocused(focused)
  })
  return unsubscribe
}, [])

// Refresh git status when window gains focus (LIVE-03)
useEffect(() => {
  if (isFocused && workspaceId && workspaceRootPath) {
    // Add small delay to avoid duplicate fetches with file watcher
    const timer = setTimeout(() => {
      console.debug('[useGitStatus] Window focused, refreshing')
      refresh()
    }, 100)
    return () => clearTimeout(timer)
  }
}, [isFocused, workspaceId, workspaceRootPath, refresh])
```

The complete updated hook should look like:

```typescript
/**
 * useGitStatus - Hook for accessing workspace git status
 *
 * Provides git status for the current workspace with:
 * - Automatic fetching on workspace switch
 * - Real-time updates via file watcher (LIVE-01)
 * - Refresh on window focus (LIVE-03)
 *
 * Usage:
 *   const { gitState, isLoading, refresh } = useGitStatus(workspaceId, workspaceRootPath)
 */

import { useEffect, useCallback, useState } from 'react'
import { useAtomValue, useSetAtom } from 'jotai'
import {
  gitStateForWorkspaceAtom,
  gitLoadingForWorkspaceAtom,
  setGitStateAtom,
  setGitLoadingAtom,
} from '@/atoms/git'
import type { GitState } from '../../shared/types'

interface UseGitStatusResult {
  /** Current git state for the workspace, null if not yet fetched or not a git repo */
  gitState: GitState | null
  /** True if git status is being fetched */
  isLoading: boolean
  /** Manually refresh git status */
  refresh: () => Promise<void>
}

/**
 * Hook to access git status for a workspace.
 *
 * @param workspaceId - Current workspace ID
 * @param workspaceRootPath - Absolute path to workspace root directory
 * @returns Git state, loading state, and refresh function
 */
export function useGitStatus(
  workspaceId: string | null,
  workspaceRootPath: string | null
): UseGitStatusResult {
  const getGitState = useAtomValue(gitStateForWorkspaceAtom)
  const getLoading = useAtomValue(gitLoadingForWorkspaceAtom)
  const setGitState = useSetAtom(setGitStateAtom)
  const setLoading = useSetAtom(setGitLoadingAtom)

  const gitState = workspaceId ? getGitState(workspaceId) : null
  const isLoading = workspaceId ? getLoading(workspaceId) : false

  // Track window focus for LIVE-03
  const [isFocused, setIsFocused] = useState(true)

  const refresh = useCallback(async () => {
    if (!workspaceId || !workspaceRootPath) return

    // Set loading state
    setLoading({ workspaceId, loading: true })

    try {
      // Fetch git status via IPC (optional chaining for safety)
      const state = await window.electronAPI?.getGitStatus?.(workspaceRootPath)
      if (state) {
        setGitState({ workspaceId, state })
      } else {
        // electronAPI not available (e.g., outside Electron)
        setGitState({
          workspaceId,
          state: {
            branch: null,
            isRepo: false,
            isDetached: false,
            detachedHead: null,
          },
        })
      }
    } catch (error) {
      console.error('[useGitStatus] Failed to fetch git status:', error)
      // Set default non-repo state on error
      setGitState({
        workspaceId,
        state: {
          branch: null,
          isRepo: false,
          isDetached: false,
          detachedHead: null,
        },
      })
    } finally {
      setLoading({ workspaceId, loading: false })
    }
  }, [workspaceId, workspaceRootPath, setGitState, setLoading])

  // Fetch git status when workspace changes (only if not already cached)
  useEffect(() => {
    if (workspaceId && workspaceRootPath && !gitState) {
      refresh()
    }
  }, [workspaceId, workspaceRootPath, gitState, refresh])

  // Listen for git changes from file watcher (LIVE-01)
  useEffect(() => {
    if (!workspaceRootPath) return

    const unsubscribe = window.electronAPI?.onGitStatusChanged?.((changedDir: string) => {
      // Only refresh if the change is for our workspace
      if (changedDir === workspaceRootPath) {
        console.debug('[useGitStatus] Git change detected, refreshing')
        refresh()
      }
    })

    return unsubscribe
  }, [workspaceRootPath, refresh])

  // Listen for window focus changes
  useEffect(() => {
    const unsubscribe = window.electronAPI?.onWindowFocusChange?.((focused) => {
      setIsFocused(focused)
    })
    return unsubscribe
  }, [])

  // Refresh git status when window gains focus (LIVE-03)
  useEffect(() => {
    if (isFocused && workspaceId && workspaceRootPath) {
      // Small delay to avoid duplicate fetches with file watcher
      const timer = setTimeout(() => {
        console.debug('[useGitStatus] Window focused, refreshing')
        refresh()
      }, 100)
      return () => clearTimeout(timer)
    }
  }, [isFocused, workspaceId, workspaceRootPath, refresh])

  return {
    gitState,
    isLoading,
    refresh,
  }
}
```
  </action>
  <verify>
    - `bun run typecheck:all` passes
    - useGitStatus.ts contains onWindowFocusChange listener
    - useGitStatus.ts contains isFocused state
    - Manual test: Start app, switch to another app, make git change in terminal, switch back, observe git badge updates
  </verify>
  <done>
    useGitStatus refreshes on window focus (LIVE-03 complete)
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Type checking: `bun run typecheck:all`
2. Manual test for LIVE-01 (file watching - full end-to-end):
   - Start app: `bun run electron:dev`
   - Open a git repository workspace
   - Note current branch in UI
   - In terminal: `git checkout -b test-live-01-e2e`
   - Observe branch badge updates to "test-live-01-e2e" within 1 second
   - In terminal: `git checkout main && git branch -d test-live-01-e2e`
   - Observe branch badge returns to "main" within 1 second
3. Manual test for LIVE-03 (focus refresh):
   - With app open, switch to Terminal
   - In terminal: `git checkout -b test-focus`
   - Switch back to Kata Agents window
   - Observe branch badge shows "test-focus" (may take ~100ms)
   - Clean up: `git checkout main && git branch -d test-focus`
4. Performance check:
   - Open Activity Monitor
   - Observe Kata Agents CPU usage stays low (< 5%) while idle
   - Make several rapid git operations
   - Observe no CPU spikes (debouncing working)
</verification>

<success_criteria>
- useGitStatus listens for GIT_STATUS_CHANGED events
- useGitStatus refreshes on window focus
- Branch change reflected in UI within 1 second of git operation
- Git status refreshes when returning to app from another application
- No CPU spikes from file watching
- Type checking passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-real-time-updates/05-03-SUMMARY.md`
</output>
