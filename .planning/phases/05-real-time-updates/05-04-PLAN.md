---
phase: 05-real-time-updates
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/electron/src/renderer/components/app-shell/input/FreeFormInput.tsx
autonomous: true
gap_closure: true
source_issue: ""

must_haves:
  truths:
    - "Git branch badge updates within ~1 second of git checkout"
    - "PR badge appears when current branch has an open PR"
    - "Git branch badge updates on window focus after external git change"
  artifacts:
    - path: "apps/electron/src/renderer/components/app-shell/input/FreeFormInput.tsx"
      provides: "GitBranchBadge driven by live gitState prop, not local fetch"
      contains: "gitState"
  key_links:
    - from: "FreeFormInput (parent)"
      to: "GitBranchBadge"
      via: "gitState prop from useGitStatus"
      pattern: "GitBranchBadge.*gitState"
    - from: "FreeFormInput (parent)"
      to: "PrBadge"
      via: "currentBranch from live gitState"
      pattern: "currentBranch.*gitState"
---

<objective>
Wire GitBranchBadge to live git state from the useGitStatus hook, closing all three UAT failures.

Purpose: GitBranchBadge currently has its own local useState/useEffect that fetches git status once when workingDirectory changes and never subscribes to GIT_STATUS_CHANGED events or window focus. This disconnects it from the entire real-time pipeline (GitWatcher -> IPC -> useGitStatus) that Phase 5 built. All three UAT failures (LIVE-01, LIVE-02, LIVE-03) trace to this single root cause.

Output: GitBranchBadge becomes a pure display component receiving gitState as a prop from FreeFormInput, which already calls useGitStatus with real-time listeners.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/05-real-time-updates/05-UAT.md
@.planning/phases/05-real-time-updates/05-03-SUMMARY.md
@apps/electron/src/renderer/hooks/useGitStatus.ts
@apps/electron/src/renderer/hooks/usePrStatus.ts
@apps/electron/src/renderer/components/app-shell/input/FreeFormInput.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor GitBranchBadge to accept gitState as a prop</name>
  <files>apps/electron/src/renderer/components/app-shell/input/FreeFormInput.tsx</files>
  <action>
Refactor GitBranchBadge (around line 1870-1935) to be a pure display component:

1. Change the GitBranchBadge function signature from `{ workingDirectory }` to `{ gitState }` where gitState is `GitState | null` (imported type already available in the file).

2. Remove the local `useState` for gitState (line 1875) and the `useEffect` that calls `window.electronAPI?.getGitStatus?.(workingDirectory)` (lines 1878-1894). These are the root cause of all three UAT failures -- this one-shot fetch never updates after mount.

3. The rest of the component logic stays the same: the null checks (`if (!gitState?.isRepo)`), branch display logic, tooltip, and JSX remain unchanged.

4. Update the call site (around line 1419) from:
   ```
   <GitBranchBadge workingDirectory={workingDirectory} />
   ```
   to:
   ```
   <GitBranchBadge gitState={prGitState} />
   ```

   Note: `prGitState` is already available at line 253 from useGitStatus. This is the live git state that receives GIT_STATUS_CHANGED events and focus refresh. The variable name `prGitState` was chosen when it only served PrBadge, but it now serves both badges. Optionally rename it to `gitState` for clarity (update lines 253-254 accordingly: `const { gitState } = useGitStatus(...)` and `const currentBranch = gitState?.branch ?? null`). If renaming, make sure to update both the call site for GitBranchBadge and PrBadge.

5. Verify PrBadge's `currentBranch` prop (line 1424) still derives from the same live gitState. Currently it comes from `prGitState?.branch` at line 254 -- this is correct and wired to the real-time pipeline. No change needed for PrBadge itself.
  </action>
  <verify>
Run `bun run typecheck:all` from the project root -- must pass with zero errors.

Run `bun run lint:electron` -- must pass.

Grep to confirm no local git fetch remains in GitBranchBadge:
- `grep -n "getGitStatus" apps/electron/src/renderer/components/app-shell/input/FreeFormInput.tsx` should NOT match any line inside GitBranchBadge (lines 1870+). The only getGitStatus usage should be in the useGitStatus hook.
- `grep -n "useState.*gitState\|useState.*GitState" apps/electron/src/renderer/components/app-shell/input/FreeFormInput.tsx` should return zero matches (no local gitState state in this file).
  </verify>
  <done>
GitBranchBadge is a pure display component receiving gitState as a prop. No local useState, no local useEffect for git fetching. The component renders branch name from the prop, which comes from the useGitStatus hook that has real-time GIT_STATUS_CHANGED listeners and focus refresh.
  </done>
</task>

<task type="auto">
  <name>Task 2: Validate path consistency between useGitStatus and GitWatcher</name>
  <files>apps/electron/src/renderer/components/app-shell/input/FreeFormInput.tsx</files>
  <action>
Verify that the path used by useGitStatus matches what GitWatcher broadcasts:

1. In FreeFormInput, useGitStatus is called at line 253 with `workspaceRootPath` (the workspace root directory, where .git lives). This is correct.

2. GitWatcher in ipc.ts (line 828-835) auto-starts with the `dirPath` passed to GIT_STATUS. The useGitStatus hook passes `workspaceRootPath` to `getGitStatus`, so the watcher key matches the listener filter.

3. The old GitBranchBadge used `workingDirectory` (session's working directory, which could be a subdirectory). This was a secondary bug -- if workingDirectory differed from workspaceRootPath, the watcher would be keyed differently than the listener expected.

4. By removing GitBranchBadge's direct IPC call (Task 1), this path mismatch is eliminated. The only getGitStatus call now goes through useGitStatus which always uses workspaceRootPath.

5. Confirm: search FreeFormInput.tsx for any remaining direct calls to `window.electronAPI?.getGitStatus` -- there should be NONE. All git status fetching should go through the useGitStatus hook.

6. If the old GitBranchBadge was the only consumer passing `workingDirectory` (not workspaceRootPath) to getGitStatus, confirm that no other component in the file makes this mistake. Search for `getGitStatus` across the renderer to verify.
  </action>
  <verify>
Run from project root:
- `grep -rn "getGitStatus" apps/electron/src/renderer/` should only show matches in `useGitStatus.ts` (the hook itself). No component should call getGitStatus directly.
- `grep -rn "getGitStatus" apps/electron/src/renderer/components/` should return zero matches.
  </verify>
  <done>
No component calls getGitStatus directly. All git status access goes through useGitStatus hook, which uses workspaceRootPath (the correct path where .git directory lives). Path consistency between useGitStatus and GitWatcher is confirmed.
  </done>
</task>

</tasks>

<verification>
All three UAT failures should be resolved by this single change:

1. **LIVE-01 (branch badge updates on checkout):** GitBranchBadge now receives gitState from useGitStatus, which subscribes to GIT_STATUS_CHANGED events from GitWatcher. When git checkout occurs, GitWatcher detects .git/HEAD change -> broadcasts via IPC -> useGitStatus refreshes -> new gitState flows to GitBranchBadge as prop.

2. **LIVE-02 (PR badge appears for branch with PR):** PrBadge already received currentBranch from the live useGitStatus hook (line 254). However, the old GitBranchBadge's stale local state may have confused testing. With the fix, both badges are driven by the same live gitState. The usePrStatus hook re-fetches when currentBranch changes.

3. **LIVE-03 (badge updates on focus return):** useGitStatus subscribes to onWindowFocusChange and triggers refresh with 100ms debounce. The refreshed gitState flows to GitBranchBadge via prop.

Verify with manual testing:
1. `bun run electron:dev`
2. Open a workspace that is a git repo
3. In terminal: `git checkout -b test-live-fix` -- branch badge should update within ~1 second
4. Create a PR for the branch with `gh pr create` -- PR badge should appear after focus refresh or polling
5. Switch to another app, run `git checkout main` in terminal, switch back -- branch badge should show "main"
</verification>

<success_criteria>
- GitBranchBadge accepts gitState prop (no local state/fetch)
- TypeScript compiles with zero errors
- Linting passes
- No direct getGitStatus calls in any renderer component (only in useGitStatus hook)
- Branch badge updates automatically on git checkout (LIVE-01)
- PR badge appears for branches with open PRs (LIVE-02)
- Branch badge updates on window focus after external git change (LIVE-03)
</success_criteria>

<output>
After completion, create `.planning/phases/05-real-time-updates/05-04-SUMMARY.md`
</output>
