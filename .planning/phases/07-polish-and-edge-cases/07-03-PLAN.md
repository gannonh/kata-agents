---
phase: 07-polish-and-edge-cases
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - apps/electron/src/main/lib/__tests__/git-watcher.test.ts
autonomous: true

must_haves:
  truths:
    - "GitWatcher has unit tests covering start, stop, and change detection"
    - "Worktree .git file resolution is tested"
    - "Non-git directory returns false from start()"
    - "Watcher cleanup releases resources"
  artifacts:
    - path: "apps/electron/src/main/lib/__tests__/git-watcher.test.ts"
      provides: "Integration tests for GitWatcher"
      min_lines: 80
  key_links:
    - from: "apps/electron/src/main/lib/__tests__/git-watcher.test.ts"
      to: "apps/electron/src/main/lib/git-watcher.ts"
      via: "imports GitWatcher class"
      pattern: "import.*GitWatcher"
---

<objective>
Add integration tests for the GitWatcher class covering normal repos, worktree directories, non-git directories, and cleanup behavior.

Purpose: GitWatcher has zero test coverage. These tests catch cross-platform regressions and verify the worktree support added in Plan 01.
Output: New test file with integration tests that create real temp git repos and verify watcher behavior.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-polish-and-edge-cases/07-RESEARCH.md
@apps/electron/src/main/lib/git-watcher.ts
@packages/shared/src/git/__tests__/git-service.test.ts (for test patterns: createTempDir, initGitRepo, cleanupDir)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitWatcher integration tests</name>
  <files>apps/electron/src/main/lib/__tests__/git-watcher.test.ts</files>
  <action>
Create a new test file following the patterns established in `packages/shared/src/git/__tests__/git-service.test.ts`.

Use `bun:test` (describe, it, expect, beforeEach, afterEach). Create real temp directories with `git init`.

**Test utility functions (reuse pattern from git-service.test.ts):**
- `createTempDir(prefix)` - creates temp dir in os.tmpdir()
- `initGitRepo(dir, options?)` - runs `git init`, configures user, optional initial commit and branch
- `cleanupDir(dir)` - rmSync with recursive/force

**Test cases to implement:**

1. **"start() returns true for a git repository"**
   - Create temp dir, init git repo
   - Create GitWatcher with a mock callback
   - Call start(), expect true
   - Call stop() in cleanup

2. **"start() returns false for non-git directory"**
   - Create temp dir (no git init)
   - Create GitWatcher
   - Call start(), expect false

3. **"start() returns false for non-existent directory"**
   - Use a path that does not exist
   - Create GitWatcher
   - Call start(), expect false

4. **"detects git changes via callback"**
   - Create temp dir, init git repo with initial commit
   - Create GitWatcher with a mock callback and debounceMs: 50 (faster for tests)
   - Call start()
   - Write a file and run `git add .` + `git commit -m "test"` using execSync
   - Wait 200ms (debounce + watcher propagation)
   - Expect callback to have been called at least once
   - Call stop()

5. **"stop() prevents further callbacks"**
   - Create temp dir, init git repo with initial commit
   - Create GitWatcher with callback
   - Call start(), then immediately stop()
   - Make a git commit
   - Wait 200ms
   - Expect callback NOT called after stop

6. **"isRunning() returns correct state"**
   - Create temp dir, init git repo
   - Create GitWatcher
   - Expect isRunning() false before start
   - Call start()
   - Expect isRunning() true
   - Call stop()
   - Expect isRunning() false

7. **"handles worktree .git file"**
   - Create temp dir, init git repo with initial commit
   - Create a worktree: `git worktree add ../worktree-dir feature-branch` (creates a branch and worktree)
   - Create GitWatcher for the worktree directory
   - Call start(), expect true (the resolveGitDir function should resolve the gitdir pointer)
   - Call stop()
   - Clean up both directories

8. **"calls onError callback on watcher error"**
   - Create GitWatcher with onError callback
   - This is a defensive test. The exact mechanism of triggering a chokidar error is platform-specific. If hard to trigger reliably, test that the onError option is stored and the constructor accepts it without error. Mark as a structural/smoke test.

**Important patterns:**
- Always call `stop()` in afterEach to prevent leaked watchers
- Use `afterEach` for cleanup (both stop() and cleanupDir)
- For timing-dependent tests (callback detection), use a Promise with setTimeout and keep timeouts short (200-300ms) but sufficient
- If the worktree test needs git >= 2.5 (when worktrees were introduced), skip gracefully if `git worktree` fails

**Import the GitWatcher class using a relative path** since this test lives in the electron app, not in the shared package. The import path from `apps/electron/src/main/lib/__tests__/` to `apps/electron/src/main/lib/git-watcher.ts` is `../git-watcher`.
  </action>
  <verify>
Run `bun test apps/electron/src/main/lib/__tests__/git-watcher.test.ts` and confirm all tests pass.
Run `bun test` to confirm no regressions across the full suite.
  </verify>
  <done>
GitWatcher has integration tests covering: normal repo start/stop, non-git directory, change detection, worktree support, isRunning state, and resource cleanup. All tests pass.
  </done>
</task>

</tasks>

<verification>
- `bun test apps/electron/src/main/lib/__tests__/git-watcher.test.ts` passes
- `bun test` full suite passes (1312+ existing tests plus new GitWatcher tests)
- Test file covers at least 6 distinct scenarios
</verification>

<success_criteria>
- GitWatcher has meaningful test coverage for the first time
- Worktree .git file resolution is tested with a real git worktree
- Tests follow established patterns from git-service.test.ts
- No leaked watchers or temp directories after test run
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish-and-edge-cases/07-03-SUMMARY.md`
</output>
