---
phase: 07-polish-and-edge-cases
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/electron/src/main/lib/git-watcher.ts
  - packages/shared/src/git/git-service.ts
autonomous: true

must_haves:
  truths:
    - "GitWatcher starts successfully for git worktree directories"
    - "GitWatcher starts successfully for submodule directories"
    - "simple-git does not produce console errors for non-existent directories"
    - "ENOSPC errors on Linux produce a user-friendly log message"
  artifacts:
    - path: "apps/electron/src/main/lib/git-watcher.ts"
      provides: "resolveGitDir function and ENOSPC handling"
      contains: "resolveGitDir"
    - path: "packages/shared/src/git/git-service.ts"
      provides: "existsSync guard before simpleGit construction"
      contains: "existsSync"
  key_links:
    - from: "apps/electron/src/main/lib/git-watcher.ts"
      to: "resolveGitDir"
      via: "start() calls resolveGitDir instead of hardcoding join(workspaceDir, '.git')"
      pattern: "resolveGitDir"
    - from: "packages/shared/src/git/git-service.ts"
      to: "existsSync"
      via: "getGitStatus and isGitRepository guard before simpleGit()"
      pattern: "existsSync.*dirPath"
---

<objective>
Add defensive error handling to the git integration layer: worktree/submodule support in GitWatcher, existsSync guard in GitService, and user-friendly ENOSPC error messages.

Purpose: Prevent silent failures for advanced git setups (worktrees, submodules) and eliminate console noise from simple-git for non-existent paths.
Output: Hardened git-watcher.ts and git-service.ts with graceful edge case handling.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-polish-and-edge-cases/07-RESEARCH.md
@apps/electron/src/main/lib/git-watcher.ts
@packages/shared/src/git/git-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add worktree/submodule support and ENOSPC handling to GitWatcher</name>
  <files>apps/electron/src/main/lib/git-watcher.ts</files>
  <action>
1. Add a `resolveGitDir(workspaceDir: string): string | null` function at module scope (not exported, internal helper). This function:
   - Reads `join(workspaceDir, '.git')` with `statSync`
   - If `.git` is a directory, return it (normal repo)
   - If `.git` is a file, read its contents, parse `gitdir: <path>`, resolve the path relative to workspaceDir, return the resolved absolute path (worktree/submodule case)
   - On any error (ENOENT, permission), return null
   - Import `readFileSync`, `statSync` from `node:fs` and `resolve` from `node:path`

2. Update `start()` method:
   - Replace `const gitDir = join(this.workspaceDir, '.git')` and the `existsSync(gitDir)` check with a call to `resolveGitDir(this.workspaceDir)`
   - If `resolveGitDir` returns null, log and return false
   - Use the resolved git dir path for all watch paths (HEAD, index, refs/heads, refs/remotes)

3. In the `.on('error', ...)` handler, add specific ENOSPC detection:
   - Check if `error.message` includes 'ENOSPC' or error code is 'ENOSPC'
   - If so, log a user-friendly message: `[GitWatcher] File watcher limit reached. On Linux, increase inotify watches: echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf && sudo sysctl -p`
   - Still call the existing `onError` callback

Do NOT change the public API (constructor, start, stop, isRunning, getWorkspaceDir). Only internal behavior changes.
  </action>
  <verify>
Run `bun run typecheck:all` from the monorepo root to confirm no type errors.
Visually inspect that `resolveGitDir` handles: normal repo (.git directory), worktree (.git file with gitdir pointer), and missing .git (returns null).
  </verify>
  <done>
GitWatcher.start() resolves the actual git directory for worktrees and submodules instead of assuming .git is always a directory. ENOSPC errors produce an actionable log message.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add existsSync guard to GitService functions</name>
  <files>packages/shared/src/git/git-service.ts</files>
  <action>
1. Add `import { existsSync } from 'node:fs'` at the top of the file.

2. In `getGitStatus(dirPath)`, add an early return before the `simpleGit(dirPath, ...)` call:
```typescript
// Pre-check: simple-git throws synchronously if dir doesn't exist
if (!existsSync(dirPath)) {
  return defaultState
}
```
This prevents the synchronous throw from `simpleGit()` that currently produces console errors for non-existent directories (visible in test output).

3. In `isGitRepository(dirPath)`, add the same guard before `simpleGit(dirPath)`:
```typescript
if (!existsSync(dirPath)) {
  return false
}
```

These guards eliminate the console error noise without changing any return values or behavior. The functions already return the same defaults when simple-git throws, this just prevents the noisy console output.
  </action>
  <verify>
Run `bun test packages/shared/src/git/__tests__/git-service.test.ts` and confirm:
- All tests pass (same count as before)
- No "Cannot use simple-git on a directory that does not exist" console error in output
Run `bun run typecheck:all` to confirm no type errors.
  </verify>
  <done>
simple-git no longer produces synchronous throw console errors for non-existent directories. All existing tests pass without console noise.
  </done>
</task>

</tasks>

<verification>
- `bun run typecheck:all` passes with no errors
- `bun test packages/shared` passes with no console errors about non-existent directories
- `apps/electron/src/main/lib/git-watcher.ts` contains `resolveGitDir` function
- `packages/shared/src/git/git-service.ts` contains `existsSync` guard before `simpleGit()`
</verification>

<success_criteria>
- GitWatcher resolves worktree/submodule `.git` files to actual git directories
- simple-git console errors eliminated for non-existent paths
- ENOSPC errors produce actionable user guidance
- All existing tests pass
- No type errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish-and-edge-cases/07-01-SUMMARY.md`
</output>
