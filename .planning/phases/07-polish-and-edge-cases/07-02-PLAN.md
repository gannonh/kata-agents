---
phase: 07-polish-and-edge-cases
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/electron/src/main/ipc.ts
  - apps/electron/src/preload/index.ts
  - apps/electron/src/shared/types.ts
autonomous: true

must_haves:
  truths:
    - "GET_GIT_BRANCH handler no longer uses execSync"
    - "GET_GIT_BRANCH handler delegates to async getGitStatus from GitService"
    - "Preload and type definitions are marked as deprecated"
    - "No renderer code calls getGitBranch"
  artifacts:
    - path: "apps/electron/src/main/ipc.ts"
      provides: "Async GET_GIT_BRANCH handler using getGitStatus"
      contains: "getGitStatus"
    - path: "apps/electron/src/shared/types.ts"
      provides: "Deprecated annotation on GET_GIT_BRANCH and getGitBranch"
      contains: "@deprecated"
  key_links:
    - from: "apps/electron/src/main/ipc.ts"
      to: "@craft-agent/shared/git"
      via: "GET_GIT_BRANCH handler imports and calls getGitStatus"
      pattern: "getGitStatus"
---

<objective>
Replace the legacy synchronous GET_GIT_BRANCH IPC handler with an async implementation that delegates to GitService, and mark the handler chain as deprecated.

Purpose: Eliminate the only remaining execSync git call in the main process, which can freeze the UI on slow filesystems or large repos.
Output: Async GET_GIT_BRANCH handler, deprecated type annotations, removed execSync import if unused.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-polish-and-edge-cases/07-RESEARCH.md
@apps/electron/src/main/ipc.ts (lines 826-845, the GET_GIT_BRANCH handler)
@apps/electron/src/shared/types.ts (lines 684-686, the channel definition; lines 953-955, the ElectronAPI type)
@apps/electron/src/preload/index.ts (lines 411-413, the preload bridge)
@packages/shared/src/git/git-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace execSync GET_GIT_BRANCH handler with async GitService delegation</name>
  <files>apps/electron/src/main/ipc.ts</files>
  <action>
1. Find the GET_GIT_BRANCH handler (around line 831). It currently looks like:
```typescript
ipcMain.handle(IPC_CHANNELS.GET_GIT_BRANCH, (_event, dirPath: string) => {
  try {
    const branch = execSync('git rev-parse --abbrev-ref HEAD', {
      cwd: dirPath,
      encoding: 'utf-8',
      stdio: ['pipe', 'pipe', 'pipe'],
      timeout: 5000,
    }).trim()
    return branch || null
  } catch {
    return null
  }
})
```

2. Replace with an async handler that delegates to getGitStatus:
```typescript
// Legacy handler - deprecated, use GIT_STATUS instead.
// Kept for backward compatibility; delegates to async GitService.
ipcMain.handle(IPC_CHANNELS.GET_GIT_BRANCH, async (_event, dirPath: string) => {
  try {
    const status = await getGitStatus(dirPath)
    return status.branch
  } catch {
    return null
  }
})
```

3. Verify `getGitStatus` is already imported at the top of ipc.ts from `@craft-agent/shared/git`. If not, add the import.

4. Check if `execSync` from `child_process` is used anywhere else in ipc.ts. The GITBASH_CHECK handler (around line 906) also uses `execSync` for `where bash`. If GET_GIT_BRANCH was the only other user, the import is still needed for GITBASH_CHECK. Do NOT remove the import.

Do NOT rename the channel or change its return type (string | null). External consumers (if any) should see no behavior change.
  </action>
  <verify>
Run `bun run typecheck:all` to confirm no type errors.
Grep for `execSync.*rev-parse` in ipc.ts to confirm it's removed.
Grep for `getGitStatus` in the GET_GIT_BRANCH handler to confirm delegation.
  </verify>
  <done>
GET_GIT_BRANCH handler is async and delegates to GitService. No more execSync for git operations in the main process.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add deprecation annotations to types and preload</name>
  <files>
    apps/electron/src/shared/types.ts
    apps/electron/src/preload/index.ts
  </files>
  <action>
1. In `apps/electron/src/shared/types.ts`, find the IPC_CHANNELS object and add a JSDoc deprecation comment to GET_GIT_BRANCH:
```typescript
/** @deprecated Use GIT_STATUS instead. Kept for backward compatibility. */
GET_GIT_BRANCH: 'git:getBranch',
```

2. In the same file, find the ElectronAPI interface and add a JSDoc deprecation comment to getGitBranch:
```typescript
/** @deprecated Use getGitStatus instead. Returns branch string only, no detached HEAD info. */
getGitBranch(dirPath: string): Promise<string | null>
```

3. In `apps/electron/src/preload/index.ts`, add a deprecation comment above the getGitBranch bridge method:
```typescript
/** @deprecated Use getGitStatus instead */
getGitBranch: (dirPath: string) =>
  ipcRenderer.invoke(IPC_CHANNELS.GET_GIT_BRANCH, dirPath),
```

These annotations make the deprecation visible in IDE tooling without breaking any existing code.
  </action>
  <verify>
Run `bun run typecheck:all` to confirm no type errors.
Grep for `@deprecated` in types.ts and preload/index.ts to confirm annotations present.
  </verify>
  <done>
GET_GIT_BRANCH, getGitBranch in types and preload are annotated with @deprecated JSDoc comments. IDE users see deprecation warnings.
  </done>
</task>

</tasks>

<verification>
- `bun run typecheck:all` passes
- `bun test` passes (all 1312+ tests)
- No `execSync.*rev-parse` in ipc.ts
- `@deprecated` annotations present on GET_GIT_BRANCH channel, getGitBranch type, and getGitBranch preload method
</verification>

<success_criteria>
- GET_GIT_BRANCH handler uses async getGitStatus instead of execSync
- All three deprecation points (channel, type, preload) annotated
- No type errors, all tests pass
- execSync import retained (still used by GITBASH_CHECK)
</success_criteria>

<output>
After completion, create `.planning/phases/07-polish-and-edge-cases/07-02-SUMMARY.md`
</output>
