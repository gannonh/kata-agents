---
phase: 06-ai-context-injection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/shared/src/prompts/system.ts
  - packages/shared/src/prompts/print-system-prompt.ts
  - packages/shared/src/agent/craft-agent.ts
  - apps/electron/src/main/sessions.ts
autonomous: true

must_haves:
  truths:
    - "Agent can reference the current git branch name in responses"
    - "Agent can reference PR information (number, title, state) when a PR exists"
    - "Git context updates when user switches workspaces (different working directory)"
    - "Git context is concise and does not bloat the prompt"
    - "Non-git directories produce no git context (graceful absence)"
  artifacts:
    - path: "packages/shared/src/prompts/system.ts"
      provides: "formatGitContext function"
      exports: ["formatGitContext"]
    - path: "packages/shared/src/agent/craft-agent.ts"
      provides: "Git context injection into user messages"
      contains: "gitContext"
    - path: "apps/electron/src/main/sessions.ts"
      provides: "Git state fetching before message send"
      contains: "getGitStatus"
  key_links:
    - from: "apps/electron/src/main/sessions.ts"
      to: "packages/shared/src/agent/craft-agent.ts"
      via: "agent.updateGitContext() called before chat()"
      pattern: "updateGitContext"
    - from: "packages/shared/src/agent/craft-agent.ts"
      to: "packages/shared/src/prompts/system.ts"
      via: "formatGitContext import"
      pattern: "formatGitContext"
    - from: "packages/shared/src/agent/craft-agent.ts"
      to: "buildTextPrompt and buildSDKUserMessage"
      via: "gitContext property injected into parts/contentBlocks"
      pattern: "this\\.gitContext"
---

<objective>
Inject workspace-specific git context (branch name, PR info) into every agent message so the AI can reference the user's current git state in responses.

Purpose: This is the differentiator phase -- the agent becomes git-aware, able to say things like "I see you're on feature/auth" or "Your PR #42 is still in draft." This turns git context from passive UI display into active AI awareness.

Output: Modified prompt system and agent to include concise git context in every user message, fetched fresh before each message send.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/shared/src/prompts/system.ts
@packages/shared/src/agent/craft-agent.ts
@apps/electron/src/main/sessions.ts
@packages/shared/src/git/types.ts
@packages/shared/src/git/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create formatGitContext and wire into CraftAgent</name>
  <files>
    packages/shared/src/prompts/system.ts
    packages/shared/src/agent/craft-agent.ts
  </files>
  <action>
**In `packages/shared/src/prompts/system.ts`:**

1. Import `GitState` and `PrInfo` types from `../git/types.ts`.

2. Create and export a `formatGitContext` function:

```typescript
/**
 * Format git context for injection into user messages.
 * Returns concise XML-tagged context for the agent, or empty string if no git info.
 * Designed to be lightweight (~100-200 chars) to avoid prompt bloat.
 */
export function formatGitContext(gitState?: GitState | null, prInfo?: PrInfo | null): string
```

Format rules:
- If `gitState` is null/undefined or `isRepo` is false, return empty string `''`
- Branch line: `Current branch: {branch}` (or `Detached HEAD: {detachedHead}` if detached)
- PR line (only if prInfo exists): `PR #{number}: {title} ({state}{isDraft ? ', Draft' : ''})`
- Wrap in `<git_context>` XML tag (matches existing pattern: `<working_directory>`, `<session_state>`)
- Keep it compact -- the roadmap specifies format like: `"Current branch: feature/user-auth, PR #42 (Fix user auth) - Open"`

Example output with PR:
```
<git_context>
Current branch: feature/user-auth
PR #42: Fix user auth (OPEN, Draft)
</git_context>
```

Example output without PR:
```
<git_context>
Current branch: main
</git_context>
```

3. Export `formatGitContext` from `packages/shared/src/prompts/index.ts` (it already re-exports `* from './system.ts'` so this is automatic).

**In `packages/shared/src/agent/craft-agent.ts`:**

1. Import `formatGitContext` alongside existing imports from `'../prompts/system.ts'`.

2. Add a `gitContext` property to the `CraftAgent` class:
```typescript
/** Cached git context string, updated before each message send */
private gitContext: string = '';
```

3. Add a public `updateGitContext` method:
```typescript
/**
 * Update the cached git context for injection into user messages.
 * Called by SessionManager before each message send with fresh git state.
 */
updateGitContext(gitState?: GitState | null, prInfo?: PrInfo | null): void {
  this.gitContext = formatGitContext(gitState, prInfo);
}
```

Import `GitState` and `PrInfo` types from `'../git/types.ts'` for the method signature.

4. In `buildTextPrompt()`, after the working directory context block (after the `if (workingDirContext)` block, around line 2208), add:
```typescript
// Add git context (branch, PR info) for AI awareness
if (this.gitContext) {
  parts.push(this.gitContext);
}
```

5. In `buildSDKUserMessage()`, after the working directory context block (after `contentBlocks.push({ type: 'text', text: workingDirContextSdk })`, around line 2264), add:
```typescript
// Add git context (branch, PR info) for AI awareness
if (this.gitContext) {
  contentBlocks.push({ type: 'text', text: this.gitContext });
}
```
  </action>
  <verify>
Run `bun run typecheck:all` from the monorepo root -- should pass with no type errors.

Verify the new function exists:
```bash
grep -n "formatGitContext" packages/shared/src/prompts/system.ts
grep -n "gitContext" packages/shared/src/agent/craft-agent.ts
```
  </verify>
  <done>
`formatGitContext` function exists in system.ts and is exported. CraftAgent has `gitContext` property, `updateGitContext()` method, and both `buildTextPrompt` and `buildSDKUserMessage` inject the git context into the message.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire SessionManager to fetch and inject git context</name>
  <files>
    apps/electron/src/main/sessions.ts
    packages/shared/src/prompts/print-system-prompt.ts
  </files>
  <action>
**In `apps/electron/src/main/sessions.ts`:**

1. Import `getGitStatus` and `getPrStatus` if not already imported. Check existing imports -- `ipc.ts` already imports these from `@craft-agent/shared/git`, but `sessions.ts` may not. Add:
```typescript
import { getGitStatus, getPrStatus } from '@craft-agent/shared/git'
```

2. In the `sendMessage` method, after the agent is obtained via `getOrCreateAgent()` and before the `agent.chat()` call, add git context fetching. Find the section where `agent.chat()` is called and add BEFORE it:

```typescript
// Fetch fresh git context for AI awareness (CTX-01, CTX-02)
// Uses working directory from session config -- workspace-specific
const workingDir = managed.agent?.config?.session?.workingDirectory
if (workingDir && managed.agent) {
  try {
    const [gitState, prInfo] = await Promise.all([
      getGitStatus(workingDir),
      getPrStatus(workingDir),
    ])
    managed.agent.updateGitContext(gitState, prInfo)
  } catch (error) {
    // Non-fatal: git context is nice-to-have, don't block message send
    sessionLog.debug('[sendMessage] Failed to fetch git context:', error)
  }
}
```

Important: The `config` property on `CraftAgent` may be private. Check the class. If so, access the working directory from `managed` directly. The `managed` object (ManagedSession) stores session config. Look for how `workingDirectory` is accessed elsewhere in sessions.ts and follow the same pattern. Likely it's available via the session config stored in the managed session, or through `managed.workingDirectory`.

Check for the working directory in the managed session -- it may be at `managed.session?.workingDirectory` based on the SessionConfig type, or it may need to come from the workspace directory as a fallback. The key requirement is: use the same directory the agent uses for bash commands (the effective working directory).

If the working directory is not explicitly set on the session, fall back to the workspace's associated directory path. Look at how other code in sessions.ts determines the working directory.

3. Also update git context when working directory changes mid-session. Find the handler for working directory changes (there should be one that calls `agent.updateWorkingDirectory()`). After that call, also update git context:

```typescript
// Also refresh git context for new working directory
try {
  const [gitState, prInfo] = await Promise.all([
    getGitStatus(newPath),
    getPrStatus(newPath),
  ])
  managed.agent?.updateGitContext(gitState, prInfo)
} catch {
  // Non-fatal
}
```

**In `packages/shared/src/prompts/print-system-prompt.ts`:**

Update the debug print script to show git context as a new component in the user message structure.

1. Import `formatGitContext` from `'./system.ts'`.
2. After the working directory section (around line 145), add a new section:

```typescript
// 6. Git Context
const gitContext = formatGitContext(
  { branch: 'feature/auth', isRepo: true, isDetached: false, detachedHead: null },
  { number: 42, title: 'Add user authentication', state: 'OPEN', isDraft: false, url: 'https://github.com/org/repo/pull/42' }
);
printSection(
  '6. GIT CONTEXT - formatGitContext()',
  gitContext || '(empty - not a git repo)',
  colors.magenta
);
printAnnotation('Shows current branch and PR info when available');
printAnnotation('Injected per-message alongside working directory context');
```

3. Update the complete user message example to include git context.
4. Update the numbered component list at the bottom to include git context.
  </action>
  <verify>
Run `bun run typecheck:all` from the monorepo root -- should pass with no type errors.

Run `bun run print:system-prompt` and verify git context section appears in the output.

Verify the wiring exists:
```bash
grep -n "updateGitContext" apps/electron/src/main/sessions.ts
grep -n "formatGitContext" packages/shared/src/prompts/print-system-prompt.ts
```
  </verify>
  <done>
SessionManager fetches git state and PR info before each message send and passes it to the agent via `updateGitContext()`. The print-system-prompt script shows the new git context component. Git context is workspace-specific because it uses the session's working directory.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit test for formatGitContext</name>
  <files>
    packages/shared/src/prompts/__tests__/git-context.test.ts
  </files>
  <action>
Create a test file at `packages/shared/src/prompts/__tests__/git-context.test.ts` using the project's Bun test runner pattern.

Test cases:

1. **Returns empty string for null gitState** -- `formatGitContext(null, null)` returns `''`
2. **Returns empty string for non-repo** -- `formatGitContext({ isRepo: false, branch: null, isDetached: false, detachedHead: null }, null)` returns `''`
3. **Returns branch context for git repo without PR** -- verify output contains `<git_context>`, the branch name, and no PR line
4. **Returns branch + PR context** -- verify output contains branch name, PR number, title, and state
5. **Handles draft PR** -- verify `Draft` appears in output when `isDraft: true`
6. **Handles detached HEAD** -- verify detached head hash appears instead of branch name
7. **Handles MERGED and CLOSED PR states** -- verify state strings are correct

Follow the test pattern from existing tests in the project (use `describe`, `test`/`it`, `expect` from Bun test runner).

```typescript
import { describe, test, expect } from 'bun:test'
import { formatGitContext } from '../system'
```
  </action>
  <verify>
Run `bun test packages/shared/src/prompts/__tests__/git-context.test.ts` -- all tests should pass.
  </verify>
  <done>
All test cases pass, covering: null/non-repo returns empty, branch-only formatting, branch+PR formatting, draft PRs, detached HEAD, and various PR states.
  </done>
</task>

</tasks>

<verification>
1. `bun run typecheck:all` passes with no errors
2. `bun test packages/shared/src/prompts/__tests__/git-context.test.ts` -- all tests pass
3. `bun run print:system-prompt` shows git context section in output
4. Grep confirms wiring: `grep -rn "updateGitContext\|formatGitContext\|gitContext" packages/shared/src apps/electron/src/main/sessions.ts`
</verification>

<success_criteria>
- formatGitContext produces concise XML-tagged context from GitState + PrInfo
- CraftAgent injects git context into every user message (both text and SDK message paths)
- SessionManager fetches fresh git state before each message send
- Git context is workspace-specific (uses session's working directory)
- Non-git directories gracefully produce no git context
- Unit tests cover all formatting edge cases
- No type errors across the monorepo
</success_criteria>

<output>
After completion, create `.planning/phases/06-ai-context-injection/06-01-SUMMARY.md`
</output>
