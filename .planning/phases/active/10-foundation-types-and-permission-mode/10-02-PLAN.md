---
phase: 10-foundation-types-and-permission-mode
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/shared/src/agent/mode-types.ts
  - packages/shared/src/agent/mode-manager.ts
  - packages/shared/src/agent/index.ts
  - packages/shared/src/agent/__tests__/daemon-permission.test.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Daemon permission mode restricts tool access to an explicit allowlist"
    - "Daemon mode blocks Bash, Write, Edit, MultiEdit, NotebookEdit, and computer operations by default"
    - "Daemon mode allows Read, Glob, Grep, WebFetch, WebSearch, Task, TaskOutput, TodoWrite by default"
    - "Daemon mode does not appear in SHIFT+TAB cycling"
    - "Custom daemon allowlists can extend the default set via options parameter"
    - "Unit tests validate all daemon mode behaviors"
  artifacts:
    - path: "packages/shared/src/agent/mode-types.ts"
      provides: "PermissionMode with daemon, DaemonAllowlistConfig, DAEMON_DEFAULT_ALLOWLIST, PERMISSION_MODE_CONFIG daemon entry"
      contains: "'daemon'"
    - path: "packages/shared/src/agent/mode-manager.ts"
      provides: "shouldAllowToolInMode daemon branch"
      contains: "mode === 'daemon'"
    - path: "packages/shared/src/agent/__tests__/daemon-permission.test.ts"
      provides: "Unit tests for daemon permission mode"
      min_lines: 60
  key_links:
    - from: "packages/shared/src/agent/mode-manager.ts"
      to: "packages/shared/src/agent/mode-types.ts"
      via: "import DAEMON_DEFAULT_ALLOWLIST"
      pattern: "DAEMON_DEFAULT_ALLOWLIST"
    - from: "packages/shared/src/agent/mode-manager.ts"
      to: "shouldAllowToolInMode"
      via: "daemon mode early return branch"
      pattern: "mode === 'daemon'"
---

<objective>
Add daemon permission mode to the existing permission system with an allowlist-based tool filtering approach, and write comprehensive unit tests.

Purpose: Enable background daemon sessions to operate with restricted tool access. Unlike safe mode (blocklist-based), daemon mode uses an allowlist where only explicitly permitted tools can run. This satisfies DAEMON-04 and success criteria 3, 4, and 5 from the roadmap.

Output: Extended PermissionMode type, daemon allowlist config, daemon branch in shouldAllowToolInMode, and a test file proving all behaviors.
</objective>

<execution_context>
<!-- Executor agent has built-in instructions for plan execution and summary creation -->
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/pending/10-foundation-types-and-permission-mode/10-RESEARCH.md

@packages/shared/src/agent/mode-types.ts (modify: add daemon to PermissionMode, add DaemonAllowlistConfig, add DAEMON_DEFAULT_ALLOWLIST, add PERMISSION_MODE_CONFIG entry)
@packages/shared/src/agent/mode-manager.ts (modify: add daemon branch to shouldAllowToolInMode, add daemon imports, add daemonAllowlist to options, update re-exports)
@packages/shared/src/agent/index.ts (modify: add DaemonAllowlistConfig and DAEMON_DEFAULT_ALLOWLIST re-exports)
@packages/shared/src/agent/__tests__/tool-matching.test.ts (test pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add daemon mode to PermissionMode and mode config</name>
  <files>
    packages/shared/src/agent/mode-types.ts
    packages/shared/src/agent/mode-manager.ts
    packages/shared/src/agent/index.ts
  </files>
  <action>
**mode-types.ts changes:**

1. Extend the `PermissionMode` type union to include `'daemon'`:
   ```
   export type PermissionMode = 'safe' | 'ask' | 'allow-all' | 'daemon';
   ```

2. Do NOT modify `PERMISSION_MODE_ORDER`. It stays as `['safe', 'ask', 'allow-all']`. Daemon is not user-cycleable.

3. Add `DaemonAllowlistConfig` interface after the existing `ModeConfig` interface:
   ```
   export interface DaemonAllowlistConfig {
     allowedTools: Set<string>;
     allowedMcpPatterns: RegExp[];
   }
   ```

4. Add `DAEMON_DEFAULT_ALLOWLIST` constant after `SAFE_MODE_CONFIG`:
   ```
   export const DAEMON_DEFAULT_ALLOWLIST: DaemonAllowlistConfig = {
     allowedTools: new Set([
       'Read', 'Glob', 'Grep',
       'WebFetch', 'WebSearch',
       'Task', 'TaskOutput',
       'TodoWrite',
     ]),
     allowedMcpPatterns: [],
   };
   ```

5. Add a `'daemon'` entry to `PERMISSION_MODE_CONFIG` after the `'allow-all'` entry. Use a shield icon SVG path (`M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z`). Color class: `text-warning`, `bg-warning`, `border-warning`.

**mode-manager.ts changes:**

1. Add `DAEMON_DEFAULT_ALLOWLIST` and `DaemonAllowlistConfig` to the imports from `./mode-types.ts`.

2. Add them to the re-exports block.

3. Add `daemonAllowlist?: DaemonAllowlistConfig` to the `options` parameter of `shouldAllowToolInMode()`.

4. Add the daemon mode branch at the TOP of `shouldAllowToolInMode()`, BEFORE the existing `if (mode === 'allow-all')` check:

   ```typescript
   if (mode === 'daemon') {
     const daemonConfig = options?.daemonAllowlist ?? DAEMON_DEFAULT_ALLOWLIST;
     if (daemonConfig.allowedTools.has(toolName)) {
       return { allowed: true };
     }
     if (toolName.startsWith('mcp__')) {
       for (const pattern of daemonConfig.allowedMcpPatterns) {
         if (pattern.test(toolName)) {
           return { allowed: true };
         }
       }
     }
     return {
       allowed: false,
       reason: `${toolName} is not in the daemon tool allowlist. Daemon mode restricts tool access for safety.`,
     };
   }
   ```

**index.ts changes:**

Add `DaemonAllowlistConfig` type export and `DAEMON_DEFAULT_ALLOWLIST` value export to the mode-manager re-exports section.
  </action>
  <verify>
Run `cd /Users/gannonhall/dev/kata/kata-agents && bun run typecheck:all` to confirm all type changes compile. Run `bun test packages/shared` to confirm existing tests still pass.
  </verify>
  <done>
PermissionMode includes 'daemon'. PERMISSION_MODE_ORDER unchanged (daemon not in cycle). DAEMON_DEFAULT_ALLOWLIST exported. shouldAllowToolInMode handles daemon mode with allowlist logic. Existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write daemon permission mode unit tests</name>
  <files>
    packages/shared/src/agent/__tests__/daemon-permission.test.ts
  </files>
  <action>
Create `packages/shared/src/agent/__tests__/daemon-permission.test.ts` using the existing test patterns from `tool-matching.test.ts` (bun:test, describe/it/expect).

Import `shouldAllowToolInMode` from `../mode-manager.ts` and `DAEMON_DEFAULT_ALLOWLIST`, `PERMISSION_MODE_ORDER` from `../mode-types.ts`. Import `type DaemonAllowlistConfig` from `../mode-types.ts`.

Test groups:

**describe('daemon mode - default allowlist'):**
- `it('allows Read')` - `shouldAllowToolInMode('Read', { file_path: '/foo' }, 'daemon')` returns `{ allowed: true }`
- `it('allows Glob')` - same pattern
- `it('allows Grep')` - same pattern
- `it('allows WebFetch')` - same pattern
- `it('allows WebSearch')` - same pattern
- `it('allows Task')` - same pattern
- `it('allows TaskOutput')` - same pattern
- `it('allows TodoWrite')` - same pattern
- `it('blocks Bash')` - returns `{ allowed: false }` with reason containing "daemon tool allowlist"
- `it('blocks Write')` - returns `{ allowed: false }`
- `it('blocks Edit')` - returns `{ allowed: false }`
- `it('blocks MultiEdit')` - returns `{ allowed: false }`
- `it('blocks NotebookEdit')` - returns `{ allowed: false }`
- `it('blocks unknown tools')` - `shouldAllowToolInMode('SomeRandomTool', {}, 'daemon')` returns `{ allowed: false }`
- `it('blocks MCP tools not in patterns')` - `shouldAllowToolInMode('mcp__foo__bar', {}, 'daemon')` returns `{ allowed: false }`

**describe('daemon mode - custom allowlist'):**
- `it('allows MCP tools matching custom pattern')` - pass `daemonAllowlist: { allowedTools: new Set(['Read']), allowedMcpPatterns: [/^mcp__slack__/] }` and check `mcp__slack__send_message` is allowed
- `it('blocks MCP tools not matching custom pattern')` - same allowlist, `mcp__github__create_issue` is blocked
- `it('allows custom tools in allowlist')` - allowlist with `new Set(['Read', 'CustomTool'])`, check `CustomTool` is allowed

**describe('daemon mode - not in UI cycle'):**
- `it('daemon is not in PERMISSION_MODE_ORDER')` - `expect(PERMISSION_MODE_ORDER).not.toContain('daemon')`
- `it('PERMISSION_MODE_ORDER has exactly 3 entries')` - `expect(PERMISSION_MODE_ORDER).toHaveLength(3)`
  </action>
  <verify>
Run `cd /Users/gannonhall/dev/kata/kata-agents && bun test packages/shared/src/agent/__tests__/daemon-permission.test.ts` and confirm all tests pass. Then run `bun test packages/shared` to confirm no regressions.
  </verify>
  <done>
All daemon permission tests pass. Tests cover: default allowlist allows read-only tools, default allowlist blocks dangerous tools, custom allowlist with MCP patterns, daemon not in PERMISSION_MODE_ORDER.
  </done>
</task>

</tasks>

<verification>
1. `bun run typecheck:all` passes with zero errors
2. `bun test packages/shared` passes all existing tests (no regressions)
3. `bun test packages/shared/src/agent/__tests__/daemon-permission.test.ts` passes all new tests
4. `shouldAllowToolInMode('Bash', { command: 'ls' }, 'daemon')` returns `{ allowed: false }`
5. `shouldAllowToolInMode('Read', { file_path: '/foo' }, 'daemon')` returns `{ allowed: true }`
6. `PERMISSION_MODE_ORDER` does not contain `'daemon'`
</verification>

<success_criteria>
- Daemon permission mode restricts tool access to explicit allowlist
- Bash, Write, Edit, MultiEdit, NotebookEdit blocked by default in daemon mode
- Read, Glob, Grep, WebFetch, WebSearch, Task, TaskOutput, TodoWrite allowed by default
- Custom daemon allowlists extendable via options.daemonAllowlist parameter
- PERMISSION_MODE_ORDER unchanged (daemon not in SHIFT+TAB cycle)
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/pending/10-foundation-types-and-permission-mode/10-02-SUMMARY.md`
</output>
