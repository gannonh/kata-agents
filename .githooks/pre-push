#!/bin/bash
#
# Pre-push hook: Prevent accidental pushes to upstream
#
# This fork should only interact with upstream via:
# 1. Fetching to update upstream/sync branch
# 2. Cherry-picking specific commits
#
# All other work goes to origin (gannonh/kata-desktop)

remote="$1"
url="$2"

# Check if pushing to upstream
if [[ "$remote" == "upstream" ]] || [[ "$url" == *"lukilabs/craft-agents"* ]]; then
    # Read what's being pushed
    while read local_ref local_sha remote_ref remote_sha; do
        # Allow pushing to upstream/sync branch only
        if [[ "$remote_ref" == "refs/heads/upstream/sync" ]]; then
            echo "✓ Allowed: Pushing to upstream/sync branch"
            exit 0
        fi

        echo "╔════════════════════════════════════════════════════════════╗"
        echo "║  ⛔ BLOCKED: Push to upstream repository                   ║"
        echo "╠════════════════════════════════════════════════════════════╣"
        echo "║                                                            ║"
        echo "║  This is a fork. Pushes should go to origin, not upstream. ║"
        echo "║                                                            ║"
        echo "║  Allowed upstream operations:                              ║"
        echo "║    • git fetch upstream                                    ║"
        echo "║    • git push upstream upstream/sync (sync branch only)    ║"
        echo "║                                                            ║"
        echo "║  For your work, push to origin:                            ║"
        echo "║    git push origin <branch>                                ║"
        echo "║                                                            ║"
        echo "║  See UPSTREAM.md for fork management strategy.             ║"
        echo "║                                                            ║"
        echo "╚════════════════════════════════════════════════════════════╝"
        exit 1
    done
fi

exit 0
